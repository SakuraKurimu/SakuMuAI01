<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>樱梦DX AI - 多功能AI助手平台</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #7c3aed;
            --primary-light: #8b5cf6;
            --secondary-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --info-color: #3b82f6;
            --background-dark: #0f172a;
            --background-card: #1e293b;
            --background-sidebar: #111827;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155;
        }
        

        .theme-purple {
            --primary-color: #6d28d9;
            --primary-light: #7c3aed;
            --sidebar-gradient: linear-gradient(135deg, #1a0b3a 0%, #0f0621 100%);
            --header-gradient: linear-gradient(90deg, #0f0621 0%, #1a0b3a 100%);
            --button-hover: #5b21b6;
            --accent-shadow: rgba(109, 40, 217, 0.1);
        }
        
        .theme-blue {
            --primary-color: #1d4ed8;
            --primary-light: #2563eb;
            --sidebar-gradient: linear-gradient(135deg, #07152f 0%, #040a16 100%);
            --header-gradient: linear-gradient(90deg, #040a16 0%, #07152f 100%);
            --button-hover: #1e40af;
            --accent-shadow: rgba(29, 78, 216, 0.1);
        }
        
        .theme-green {
            --primary-color: #059669;
            --primary-light: #10b981;
            --sidebar-gradient: linear-gradient(135deg, #021a0e 0%, #010d07 100%);
            --header-gradient: linear-gradient(90deg, #010d07 0%, #021a0e 100%);
            --button-hover: #047857;
            --accent-shadow: rgba(5, 150, 105, 0.1);
        }
        
        .theme-pink {
            --primary-color: #db2777;
            --primary-light: #ec4899;
            --sidebar-gradient: linear-gradient(135deg, #2a0414 0%, #15020a 100%);
            --header-gradient: linear-gradient(90deg, #15020a 0%, #2a0414 100%);
            --button-hover: #be185d;
            --accent-shadow: rgba(219, 39, 119, 0.1);
        }
        
        .theme-orange {
            --primary-color: #d97706;
            --primary-light: #f59e0b;
            --sidebar-gradient: linear-gradient(135deg, #220a05 0%, #110502 100%);
            --header-gradient: linear-gradient(90deg, #110502 0%, #220a05 100%);
            --button-hover: #b45309;
            --accent-shadow: rgba(217, 119, 6, 0.1);
        }
        
        .theme-red {
            --primary-color: #dc2626;
            --primary-light: #ef4444;
            --sidebar-gradient: linear-gradient(135deg, #220505 0%, #110202 100%);
            --header-gradient: linear-gradient(90deg, #110202 0%, #220505 100%);
            --button-hover: #b91c1c;
            --accent-shadow: rgba(220, 38, 38, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: var(--background-dark);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }
        

        .loading-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--background-dark) 0%, #1e1b4b 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 1;
            transition: opacity 0.5s ease;
            overflow: hidden;
        }
        

        .loading-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(45deg, transparent 30%, rgba(124, 58, 237, 0.05) 50%, transparent 70%),
                linear-gradient(135deg, transparent 40%, rgba(59, 130, 246, 0.03) 60%, transparent 80%),
                linear-gradient(225deg, transparent 20%, rgba(16, 185, 129, 0.04) 40%, transparent 60%);
            animation: backgroundFlow 15s linear infinite;
            z-index: 1;
        }
        

        .loading-container::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(255, 255, 255, 0.1) 1px, transparent 2px),
                radial-gradient(circle at 80% 70%, rgba(255, 255, 255, 0.08) 1px, transparent 2px),
                radial-gradient(circle at 40% 20%, rgba(255, 255, 255, 0.06) 0.5px, transparent 1px);
            background-size: 200px 200px, 150px 150px, 100px 100px;
            animation: threadFloat 20s linear infinite;
            z-index: 2;
        }
        
        .loading-container.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-content {
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        
        .loading-logo {
            margin-bottom: 20px;
            animation: pulse 2s infinite, float 4s ease-in-out infinite;
        }
        
        .loading-title {
            animation: fadeInUp 0.8s ease-out;
        }
        
        .loading-subtitle {
            animation: fadeInUp 0.8s ease-out 0.2s both;
        }
        
        .progress-container {
            animation: fadeInUp 0.8s ease-out 0.4s both;
        }
        
        .loading-complete {
            animation: fadeInUp 0.8s ease-out;
        }
        
        @keyframes fadeInUp {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        
        .loading-title {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, var(--primary-color), #ec4899);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .loading-subtitle {
            color: var(--text-secondary);
            margin-bottom: 30px;
            font-size: 1.1rem;
        }
        
        .progress-container {
            margin-top: 30px;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        @keyframes float {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(30px, -15px) rotate(120deg); }
            66% { transform: translate(-20px, 25px) rotate(240deg); }
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        

        @keyframes backgroundFlow {
            0% { 
                background-position: 0% 0%, 0% 0%, 0% 0%;
                opacity: 0.3;
            }
            25% { 
                background-position: 50% 25%, 75% 50%, 25% 75%;
                opacity: 0.5;
            }
            50% { 
                background-position: 100% 50%, 50% 100%, 100% 25%;
                opacity: 0.7;
            }
            75% { 
                background-position: 75% 75%, 25% 25%, 50% 50%;
                opacity: 0.5;
            }
            100% { 
                background-position: 0% 100%, 100% 0%, 0% 100%;
                opacity: 0.3;
            }
        }
        
        @keyframes threadFloat {
            0% { 
                background-position: 0 0, 0 0, 0 0;
                opacity: 0.1;
            }
            33% { 
                background-position: 100px 50px, 75px 25px, 50px 100px;
                opacity: 0.3;
            }
            66% { 
                background-position: 200px 100px, 150px 75px, 100px 50px;
                opacity: 0.2;
            }
            100% { 
                background-position: 300px 150px, 225px 125px, 150px 100px;
                opacity: 0.1;
            }
        }
        

        @keyframes meteorFall {
            0% {
                transform: translateY(0) translateX(0) rotate(45deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            70% {
                opacity: 0.5;
            }
            100% {
                transform: translateY(100vh) translateX(100px) rotate(45deg);
                opacity: 0;
            }
        }
        
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
        }
        
        .login-box {
            background-color: var(--background-card);
            border-radius: 15px;
            padding: 40px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
        }
        
        .login-title {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2rem;
            background: linear-gradient(90deg, var(--primary-color), #ec4899);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .login-tabs {
            display: flex;
            margin-bottom: 25px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .login-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        
        .login-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        
        .login-form {
            display: none;
        }
        
        .login-form.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--background-sidebar);
            color: var(--text-primary);
            font-size: 1rem;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(124, 58, 237, 0.2);
        }
        
        .btn {
            padding: 12px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 1rem;
        }
        
        .btn-primary {
            background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(90deg, var(--button-hover), var(--primary-color));
            transform: translateY(-2px);
            box-shadow: 0 5px 15px var(--accent-shadow);
        }
        
        .btn-block {
            width: 100%;
        }
        
        .login-footer {
            text-align: center;
            margin-top: 20px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .app-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
            display: none;
        }
        
        .sidebar {
            width: 280px;
            background: var(--sidebar-gradient);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 0 20px var(--accent-shadow);
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
        }

        .device-toggle-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .device-toggle-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            color: var(--primary-color);
            transform: scale(1.1);
        }

        .device-toggle-btn:active {
            transform: scale(0.95);
        }
        
        .app-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .app-info {
            display: flex;
            flex-direction: column;
            gap: 0;
        }
        
        .app-logo i {
            color: var(--primary-color);
            font-size: 1.8rem;
        }
        
        .cube-container {
            width: 50px;
            height: 50px;
            perspective: 800px;
            transform-style: preserve-3d;
        }
        
        .cube {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            animation: rotateCube 8s infinite linear;
        }
        
        .cube-face {
            position: absolute;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
            backface-visibility: visible;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5), 0 0 20px rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        
        .cube-face.front { transform: translateZ(20px); }
        .cube-face.back { transform: rotateY(180deg) translateZ(20px); }
        .cube-face.right { transform: rotateY(90deg) translateZ(20px); }
        .cube-face.left { transform: rotateY(-90deg) translateZ(20px); }
        .cube-face.top { transform: rotateX(90deg) translateZ(20px); }
        .cube-face.bottom { transform: rotateX(-90deg) translateZ(20px); }
        
        @keyframes rotateCube {
            0% { transform: rotateX(0) rotateY(0); }
            25% { transform: rotateX(90deg) rotateY(90deg); }
            50% { transform: rotateX(180deg) rotateY(180deg); }
            75% { transform: rotateX(270deg) rotateY(270deg); }
            100% { transform: rotateX(360deg) rotateY(360deg); }
        }
        
        .app-name {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(90deg, var(--primary-color), #ec4899);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .app-version {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 2px;
            font-weight: 300;
        }
        
        .app-copyright {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 2px;
            font-weight: 300;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        
        .app-copyright:hover {
            color: var(--primary-color);
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        
        .mode-section {
            margin-bottom: 25px;
        }
        
        .section-title {
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        
        .section-title i.fa-chevron-down {
            transition: transform 0.3s ease;
            font-size: 0.8rem;
            transform: rotate(-90deg);
        }
        
        .section-title.collapsed i.fa-chevron-down {
            transform: rotate(0deg);
        }
        
        .mode-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .mode-list.collapsed {
            height: 0;
            opacity: 0;
        }
        
        .mode-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            color: var(--text-primary);
        }
        
        .mode-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        .mode-item.active {
            background-color: rgba(124, 58, 237, 0.2);
            border-left: 3px solid var(--primary-color);
        }
        
        .mode-icon {
            font-size: 1.2rem;
            color: var(--text-secondary);
            width: 24px;
            text-align: center;
        }
        
        .mode-item.active .mode-icon {
            color: var(--primary-color);
        }
        
        .mode-name {
            flex: 1;
            font-weight: 500;
        }
        
        .section-title.mode-expandable {
            position: relative;
            padding-right: 40px;
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-transform: none;
            letter-spacing: normal;
            margin-bottom: 5px;
            padding: 12px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .section-title.mode-expandable:hover {
            background-color: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }
        
        .section-title.mode-expandable.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .section-title.mode-expandable i:first-child {
            transition: transform 0.3s ease;
            font-size: 0.8rem;
        }
        
        .section-title.mode-expandable.collapsed i:first-child {
            transform: rotate(-90deg);
        }
        
        .new-conversation-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        
        .new-conversation-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }
        
        .section-title.mode-expandable.active .new-conversation-btn {
            color: white;
        }
        
        .conversation-dropdown {
            margin-top: 5px;
            transition: all 0.3s ease;
            overflow: hidden;
            max-height: 0;
        }
        
        .conversation-dropdown.expanded {
            max-height: 300px;
        }
        
        .conversation-list-dropdown {
            max-height: 250px;
            overflow-y: auto;
            padding: 5px;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            margin: 0 5px;
        }
        
        .conversation-item-dropdown {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: 6px;
            transition: all 0.3s ease;
            margin-bottom: 2px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        
        .conversation-item-dropdown:hover {
            background-color: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }
        
        .conversation-item-dropdown.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .conversation-name-dropdown {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.85rem;
        }
        
        .conversation-actions-dropdown {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .conversation-item-dropdown:hover .conversation-actions-dropdown {
            opacity: 1;
        }
        
        .conversation-action-btn-dropdown {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            border-radius: 3px;
            font-size: 0.7rem;
            transition: all 0.2s ease;
        }
        
        .conversation-action-btn-dropdown:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }
        
        .conversation-action-btn-dropdown.rename-btn:hover {
            color: var(--info-color);
        }
        
        .conversation-action-btn-dropdown.delete-btn:hover {
            color: var(--danger-color);
        }
        
        .battery-info {
            padding: 15px;
            border-top: 1px solid var(--border-color);
            background-color: rgba(0, 0, 0, 0.1);
        }
        
        .battery-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .battery-title {
            font-size: 0.9rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .battery-amount {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--secondary-color);
        }
        
        .battery-low {
            color: var(--danger-color);
        }
        
        .battery-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .current-time {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-align: center;
            margin-top: 10px;
            padding: 5px;
            background-color: rgba(255, 255, 255, 0.03);
            border-radius: 5px;
        }
        
        .time-card-info {
            background-color: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            margin-bottom: 5px;
        }
        
        .time-card-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            margin-bottom: 5px;
        }
        
        .time-card-item:last-child {
            margin-bottom: 0;
        }
        
        .time-card-item i {
            color: var(--secondary-color);
            width: 16px;
            text-align: center;
        }
        
        .time-card-item span:first-of-type {
            color: var(--text-secondary);
            min-width: 60px;
        }
        
        .time-card-item span:last-of-type {
            color: var(--secondary-color);
            font-weight: 600;
        }
        
        .btn-success {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .btn-success:hover {
            background: linear-gradient(90deg, #0da271, var(--secondary-color));
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3);
        }
        
        .btn-info {
            background-color: var(--info-color);
            color: white;
        }
        
        .btn-info:hover {
            background: linear-gradient(90deg, #2563eb, var(--info-color));
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .main-header {
            padding: 18px 25px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--header-gradient);
            box-shadow: 0 4px 12px var(--accent-shadow);
        }
        
        .conversation-header-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .conversation-title {
            font-size: 1.3rem;
            font-weight: 600;
            line-height: 1.2;
        }
        
        .conversation-mode {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .btn-secondary {
            background-color: var(--background-sidebar);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .btn-secondary:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #dc2626;
        }
        
        .chat-container {
            flex: 1;
            display: flex;
            overflow: hidden;
            position: relative;
        }
        
        .chat-background-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            z-index: -1;
            transition: all 0.3s ease;
        }
        
        .chat-container.background-blur .chat-background-overlay {
            filter: blur(5px);
        }
        
        .chat-container.background-darken .chat-background-overlay {
            filter: brightness(0.7);
        }
        
        .chat-container.background-blur.background-darken .chat-background-overlay {
            filter: blur(5px) brightness(0.7);
        }
        
        .conversation-sidebar {
            width: 300px;
            background-color: var(--background-sidebar);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .conversation-header {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .conversation-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .conversation-item {
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s ease;
        }
        
        .conversation-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        .conversation-item.active {
            background-color: rgba(124, 58, 237, 0.15);
        }
        
        .conversation-title {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }
        
        .conversation-time {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }
        
        .conversation-actions {
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .conversation-item:hover .conversation-actions {
            opacity: 1;
        }
        
        @media (max-width: 768px) {
            .conversation-actions {
                opacity: 1 !important;
            }
        }
        
        .conversation-action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
        }
        
        .conversation-action-btn:hover {
            background-color: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }
        
        .chat-window {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }
        
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 0;
        }
        
        .message-container {
            display: flex;
            width: 100%;
            margin-bottom: 0;
            padding: 15px 20px;
            transition: background-color 0.2s ease;
        }
        
        .message-container:hover {
            background-color: rgba(255, 255, 255, 0.02);
        }
        
        .ai-message-container {
            justify-content: flex-start;
        }
        
        .user-message-container {
            justify-content: flex-end;
        }
        
        .message-avatar-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            width: 60px;
            margin: 0 12px;
        }
        
        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            color: white;
            background-color: var(--info-color);
        }
        
        .user-message-container .message-avatar {
            background-color: var(--primary-color);
        }
        
        .message-nickname {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-align: center;
            max-width: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.5;
            position: relative;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .ai-message-bubble {
            background-color: #ffffff;
            color: #1a1a1a;
            border-bottom-left-radius: 4px;
        }
        
        .user-message-bubble {
            background-color: #10b981;
            color: #000000;
            border-bottom-right-radius: 4px;
        }
        
        /* 对话气泡样式定义 */
        .bubble-style-original .ai-message-bubble {
            background-color: #ffffff;
            color: #1a1a1a;
        }
        
        .bubble-style-original .user-message-bubble {
            background-color: #10b981;
            color: #000000;
        }
        
        .bubble-style-transparent .ai-message-bubble,
        .bubble-style-transparent .user-message-bubble {
            background-color: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-primary);
        }
        
        .bubble-style-glass .ai-message-bubble,
        .bubble-style-glass .user-message-bubble {
            background-color: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-primary);
        }
        
        .bubble-style-semi-transparent .ai-message-bubble {
            background-color: rgba(255, 255, 255, 0.7);
            color: #1a1a1a;
        }
        
        .bubble-style-semi-transparent .user-message-bubble {
            background-color: rgba(16, 185, 129, 0.7);
            color: #000000;
        }
        
        .bubble-style-btn.active {
            border-color: var(--primary-color) !important;
            box-shadow: 0 0 0 2px rgba(124, 58, 237, 0.2);
        }
        
        .message-content-wrapper {
            min-width: 0;
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .message-content {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .message-content h1,
        .message-content h2,
        .message-content h3,
        .message-content h4,
        .message-content h5,
        .message-content h6 {
            margin-top: 1em;
            margin-bottom: 0.5em;
            font-weight: 600;
            line-height: 1.25;
        }
        
        .message-content h1 {
            font-size: 1.5em;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.3em;
        }
        
        .message-content h2 {
            font-size: 1.3em;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.3em;
        }
        
        .message-content h3 {
            font-size: 1.1em;
        }
        
        .message-content strong {
            font-weight: 700;
        }
        
        .message-content em {
            font-style: italic;
        }
        
        .message-content code {
            background-color: rgba(0, 0, 0, 0.2);
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        .message-content pre {
            background-color: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 10px 0;
        }
        
        .message-content pre code {
            background: none;
            padding: 0;
            border-radius: 0;
        }
        
        .message-content ul,
        .message-content ol {
            padding-left: 20px;
            margin: 10px 0;
        }
        
        .message-content li {
            margin-bottom: 5px;
        }
        
        .message-content blockquote {
            border-left: 4px solid var(--primary-color);
            padding-left: 15px;
            margin: 10px 0;
            color: var(--text-secondary);
        }
        
        .message-footer {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .message-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            justify-content: flex-end;
        }
        
        .message-action-btn {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            transition: all 0.2s ease;
        }
        
        .message-action-btn:hover {
            background-color: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }
        
        .user-message-bubble .message-action-btn {
            background-color: rgba(255, 255, 255, 0.9);
            color: #000000;
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        .user-message-bubble .message-action-btn:hover {
            background-color: #ffffff;
            color: #000000;
            border-color: #ffffff;
        }
        
        .message-action-btn.regenerate {
            border-color: var(--info-color);
            color: var(--info-color);
        }
        
        .message-action-btn.regenerate:hover {
            background-color: rgba(59, 130, 246, 0.1);
        }
        
        .message-action-btn.undo {
            border-color: var(--warning-color);
            color: var(--warning-color);
        }
        
        .message-action-btn.undo:hover {
            background-color: rgba(245, 158, 11, 0.1);
        }
        
        .message-action-btn.edit {
            border-color: var(--secondary-color);
            color: var(--secondary-color);
        }
        
        .message-action-btn.edit:hover {
            background-color: rgba(16, 185, 129, 0.1);
        }
        
        .message-action-btn.copy {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        
        .message-action-btn.copy:hover {
            background-color: rgba(124, 58, 237, 0.1);
        }
        
        .message-action-btn.resend {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        
        .message-action-btn.resend:hover {
            background-color: rgba(124, 58, 237, 0.1);
        }
        
        .message-action-btn.delete {
            border-color: var(--danger-color);
            color: var(--danger-color);
        }
        
        .message-action-btn.delete:hover {
            background-color: rgba(239, 68, 68, 0.1);
        }
        
        .edit-message-container {
            display: none;
            margin-top: 10px;
        }
        
        .edit-message-container.active {
            display: block;
        }
        
        .edit-textarea {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--primary-color);
            background-color: var(--background-sidebar);
            color: var(--text-primary);
            font-size: 0.9rem;
            resize: vertical;
            min-height: 80px;
            margin-bottom: 8px;
        }
        
        .edit-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        
        .input-container {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            background-color: var(--background-card);
            position: relative;
        }
        
        .cost-estimate {
            padding: 8px 12px;
            background-color: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: var(--text-secondary);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .cost-estimate-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .cost-label {
            color: var(--text-secondary);
        }
        
        .cost-value {
            color: var(--primary-color);
            font-weight: 500;
        }
        
        .cost-value.warning {
            color: var(--warning-color);
        }
        
        .cost-value.danger {
            color: var(--danger-color);
        }
        
        .input-area {
            display: flex;
            gap: 10px;
        }
        
        .message-input {
            flex: 1;
            padding: 12px 15px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background-color: var(--background-sidebar);
            color: var(--text-primary);
            font-size: 1rem;
            resize: vertical;
            min-height: 60px;
            max-height: 200px;
            width: 100%;
        }
        
        .message-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .send-button {
            padding: 12px 20px;
            border-radius: 10px;
            border: none;
            background-color: #10b981;
            color: white;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .send-button:hover {
            background-color: #0da271;
        }
        
        .send-button:disabled {
            background-color: var(--border-color);
            cursor: not-allowed;
        }
        
        .settings-panel {
            position: absolute;
            top: 70px;
            right: 25px;
            width: 350px;
            max-height: 70vh;
            background-color: var(--background-card);
            border-radius: 10px;
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            z-index: 100;
            display: none;
            padding: 20px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) var(--border-color);
        }
        
        .settings-panel::-webkit-scrollbar {
            width: 6px;
        }
        
        .settings-panel::-webkit-scrollbar-track {
            background: var(--border-color);
            border-radius: 3px;
        }
        
        .settings-panel::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 3px;
        }
        
        .settings-panel.active {
            display: block;
        }
        
        .settings-title {
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .settings-group {
            margin-bottom: 20px;
        }
        
        .settings-divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--border-color), transparent);
            margin: 25px 0;
            border: none;
        }
        
        .settings-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .settings-value {
            display: inline-block;
            min-width: 30px;
            text-align: center;
            color: var(--primary-color);
            font-weight: 500;
        }
        
        .settings-slider {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--border-color);
            border-radius: 3px;
            outline: none;
            margin-bottom: 10px;
        }
        
        .settings-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
        }
        
        .context-cost-info {
            background-color: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background-color: var(--background-card);
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .api-list {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .api-item {
            padding: 12px 15px;
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.03);
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .api-item.active {
            border-left: 3px solid var(--primary-color);
        }
        
        .api-name {
            font-weight: 500;
        }
        
        .api-actions {
            display: flex;
            gap: 8px;
        }
        
        .preset-list {
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .preset-item {
            padding: 12px 15px;
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.03);
            margin-bottom: 10px;
            border-left: 3px solid var(--info-color);
        }
        
        .preset-item-title {
            font-weight: 500;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .preset-item-content {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }
        
        .recharge-code-input {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            letter-spacing: 1px;
        }
        
        .recharge-info {
            background-color: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .recharge-info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        
        .warning-modal .modal-content {
            border-color: var(--danger-color);
            max-width: 450px;
        }
        
        .warning-header {
            color: var(--danger-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .warning-body {
            text-align: center;
            padding: 30px 20px;
        }
        
        .warning-icon {
            font-size: 3rem;
            color: var(--danger-color);
            margin-bottom: 20px;
        }
        
        .warning-text {
            font-size: 1.1rem;
            margin-bottom: 25px;
            color: var(--text-primary);
        }
        
        .warning-timer {
            font-size: 2rem;
            font-weight: 700;
            color: var(--danger-color);
            margin-bottom: 25px;
        }
        
        .warning-actions {
            display: flex;
            gap: 15px;
        }
        
        .warning-actions .btn {
            flex: 1;
        }
        
        @media (max-width: 1024px) {
            .conversation-sidebar {
                width: 250px;
            }
            
            .settings-panel {
                width: 300px;
            }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                z-index: 100;
                height: 100vh;
                transform: translateX(-100%);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .conversation-sidebar {
                position: fixed;
                left: 0;
                top: 0;
                height: 100vh;
                z-index: 99;
                transform: translateX(-100%);
            }
            
            .conversation-sidebar.active {
                transform: translateX(0);
            }
            
            .menu-toggle {
                display: block;
            }
            
            .settings-panel {
                width: 90%;
                right: 5%;
                max-height: 80vh;
                top: 60px;
            }
        }
        
        .menu-toggle {
            display: none;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
        }
        
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-light);
        }
        
        .loading {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            color: var(--text-secondary);
        }
        
        .loading-dots {
            display: inline-flex;
            gap: 4px;
        }
        
        .loading-dot {
            width: 8px;
            height: 8px;
            background-color: var(--primary-color);
            border-radius: 50%;
            animation: dot-flashing 1.4s infinite alternate;
        }
        
        .loading-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .loading-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes dot-flashing {
            0% {
                opacity: 0.2;
            }
            100% {
                opacity: 1;
            }
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .empty-state h3 {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: var(--text-primary);
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            background-color: var(--primary-color);
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            transform: translateX(150%);
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.error {
            background-color: var(--danger-color);
        }
        
        .notification.success {
            background-color: var(--secondary-color);
        }
        
        .notification.warning {
            background-color: var(--warning-color);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            border-radius: 10px;
            background-color: rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .user-info:hover {
            background-color: rgba(255, 255, 255, 0.08);
        }
        
        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), #ec4899);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .user-avatar:hover {
            transform: scale(1.05);
        }
        
        .user-avatar-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            flex: 1;
        }
        
        .user-details {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            text-align: center;
        }
        
        .user-name {
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-primary);
        }
        
        .user-email {
            font-size: 0.75rem;
            color: var(--text-secondary);
            opacity: 0.8;
        }
        
        .logout-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
        }
        
        .logout-btn:hover {
            color: var(--danger-color);
            background-color: rgba(239, 68, 68, 0.1);
        }



        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .settings-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--background-card);
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .settings-title {
            font-size: 1.5rem;
            color: var(--text-primary);
        }

        .close-settings {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.5rem;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .close-settings:hover {
            color: var(--danger-color);
            background-color: rgba(239, 68, 68, 0.1);
        }

        .settings-group {
            margin-bottom: 25px;
        }

        .settings-divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--border-color), transparent);
            margin: 25px 0;
            border: none;
        }

        .settings-label {
            display: block;
            margin-bottom: 10px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .device-toggle {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background-color: var(--background-sidebar);
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .toggle-label {
            flex: 1;
            color: var(--text-primary);
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background-color: var(--border-color);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .toggle-switch input[type="checkbox"] {
            display: none;
        }
        
        .toggle-switch input[type="checkbox"]:checked + .toggle-slider {
            left: 33px;
        }
        
        .toggle-switch input[type="checkbox"]:checked {
            background-color: var(--primary-color);
        }
        
        .toggle-switch:has(input[type="checkbox"]:checked) {
            background-color: var(--primary-color);
        }
        
        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background-color: white;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .preset-switch {
            display: none;
        }
        
        .switch-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border-color);
            transition: .4s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .preset-select {
            margin-bottom: 15px;
        }
        
        .preset-select .form-control {
            font-size: 0.9rem;
            padding: 8px 12px;
        }
        
        .nickname-status {
            display: inline-block;
            margin-left: 10px;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .nickname-status.enabled {
            background-color: rgba(16, 185, 129, 0.2);
            color: var(--secondary-color);
        }
        
        .nickname-status.disabled {
            background-color: rgba(148, 163, 184, 0.2);
            color: var(--text-secondary);
        }
        
        .preset-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .preset-buttons .btn {
            flex: 1;
        }
        
        .battery-details-modal .modal-content {
            max-width: 600px;
            max-height: 70vh;
            height: 600px;
            overflow-y: auto;
            overflow-x: hidden;
        }
        

        
        .battery-summary {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        
        .battery-summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 1rem;
        }
        
        .battery-summary-total {
            font-weight: 700;
            color: var(--primary-color);
            font-size: 1.1rem;
        }
        
        .battery-summary-remaining {
            font-weight: 600;
            color: var(--secondary-color);
            font-size: 1.1rem;
        }
        
        .time-card-summary-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        
        .time-card-summary-item:last-child {
            margin-bottom: 0;
        }
        
        .time-card-summary-item i {
            color: var(--secondary-color);
            width: 16px;
            text-align: center;
        }
        
        .time-card-summary-item span:nth-child(2) {
            color: var(--text-secondary);
            min-width: 70px;
        }
        
        .time-card-summary-item span:last-child {
            color: var(--secondary-color);
            font-weight: 600;
        }
        
        .ai-first-button,
        .continue-button {
            padding: 12px 20px;
            border-radius: 10px;
            border: none;
            background-color: var(--info-color);
            color: white;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }
        
        .ai-first-button:hover,
        .continue-button:hover {
            background-color: #2563eb;
        }
        
        .ai-first-button:disabled,
        .continue-button:disabled {
            background-color: var(--border-color);
            cursor: not-allowed;
        }
        
        .input-buttons {
            display: flex;
            gap: 10px;
            width: 100%;
            align-items: flex-end;
        }
        
        .message-input-container {
            flex: 1;
            position: relative;
        }
        
        .resize-handle {
            position: absolute;
            top: -5px;
            left: 0;
            right: 0;
            height: 10px;
            cursor: ns-resize;
            background-color: transparent;
            z-index: 10;
        }
        
        .resize-handle:hover {
            background-color: rgba(124, 58, 237, 0.2);
        }
        
        .resize-handle.active {
            background-color: rgba(124, 58, 237, 0.4);
        }


        @media (max-width: 768px) {

            .mobile-mode .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .mobile-mode .sidebar.active {
                transform: translateX(0);
            }
            
            .mobile-mode .main-content::before {
                content: '';
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 99;
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.3s ease;
            }
            
            .mobile-mode .sidebar.active + .main-content::before {
                opacity: 1;
                pointer-events: auto;
            }
            body {
                overflow: auto;
                height: auto;
                min-height: 100vh;
            }

            .app-container {
                flex-direction: column;
                height: auto;
                min-height: 100vh;
            }

            .sidebar {
                width: 100%;
                height: auto;
                max-height: 80px;
                overflow: hidden;
                transition: all 0.3s ease;
                position: fixed;
                top: 0;
                left: 0;
                z-index: 100;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }

            .sidebar.active {
                max-height: 100vh;
                height: 100vh;
            }

            .sidebar-header {
                padding: 15px;
                position: relative;
            }

            .device-toggle-btn {
                top: 15px;
                right: 15px;
                width: 28px;
                height: 28px;
                font-size: 0.8rem;
            }

            .app-logo {
                flex-direction: row;
                align-items: center;
                gap: 10px;
            }

            .app-info {
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .app-name {
                font-size: 1.2rem;
            }

            .app-version, .app-copyright {
                display: none;
            }



            .user-info {
                display: none;
            }

            .sidebar-content {
                display: none;
            }

            .sidebar.active .sidebar-content {
                display: block;
            }

            .sidebar.active .user-info {
                display: flex;
            }

            .battery-info {
                display: none;
            }

            .main-content {
                margin-left: 0;
                margin-top: 80px;
                height: calc(100vh - 80px);
            }

            .main-header {
                padding: 15px;
                position: fixed;
                top: 80px;
                left: 0;
                width: 100%;
                z-index: 99;
                background-color: var(--background-card);
            }

            .conversation-area {
                margin-top: 0;
                padding-top: 60px;
                height: calc(100vh - 140px);
            }

            .message-input-area {
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                background-color: var(--background-card);
                border-top: 1px solid var(--border-color);
                padding: 15px;
            }

            .message-input-container {
                flex-direction: column;
                gap: 10px;
            }

            .message-input {
                min-height: 80px;
                max-height: 120px;
            }

            .input-actions {
                display: flex;
                justify-content: space-between;
                align-items: center;
                width: 100%;
            }

            .action-buttons {
                display: flex;
                gap: 10px;
            }

            .btn {
                padding: 10px 15px;
                font-size: 0.9rem;
            }

            .modal-content {
                width: 95%;
                margin: 20px auto;
            }

            .login-box {
                width: 95%;
                margin: 20px auto;
            }

            .menu-toggle {
                display: block;
            }

            .header-actions {
                gap: 8px;
            }

            .header-actions .btn span {
                display: none;
            }

            .header-actions .btn i {
                margin-right: 0;
            }
        }

        @media (max-width: 480px) {
            .sidebar-header {
                padding: 10px;
            }

            .device-toggle-btn {
                top: 10px;
                right: 10px;
                width: 24px;
                height: 24px;
                font-size: 0.7rem;
            }

            .app-name {
                font-size: 1rem;
            }

            .main-header {
                padding: 10px;
            }

            .message-input-area {
                padding: 10px;
            }

            .btn {
                padding: 8px 12px;
                font-size: 0.8rem;
            }

            .message {
                padding: 10px;
                margin: 8px 0;
            }

            .message-content {
                font-size: 0.9rem;
            }
        }


        @media (min-width: 769px) and (max-width: 1024px) {
            .sidebar {
                width: 240px;
            }

            .main-content {
                margin-left: 240px;
            }


        }
    </style>
</head>
<body>
    <!-- 数据读取进度条页面 -->
    <div class="loading-container" id="loadingContainer">
        <!-- 流星雨效果 - 最上层级 -->
        <div class="meteor-shower" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 9998; pointer-events: none;">
            <div class="meteor" style="position: absolute; width: 2px; height: 20px; background: linear-gradient(to bottom, transparent, #ffffff, transparent); animation: meteorFall 3s linear infinite; top: -20px; left: 10%;"></div>
            <div class="meteor" style="position: absolute; width: 2px; height: 30px; background: linear-gradient(to bottom, transparent, #ff6b6b, transparent); animation: meteorFall 4s linear infinite 1s; top: -30px; left: 30%;"></div>
            <div class="meteor" style="position: absolute; width: 2px; height: 25px; background: linear-gradient(to bottom, transparent, #4ecdc4, transparent); animation: meteorFall 3.5s linear infinite 2s; top: -25px; left: 60%;"></div>
            <div class="meteor" style="position: absolute; width: 2px; height: 28px; background: linear-gradient(to bottom, transparent, #ffd93d, transparent); animation: meteorFall 4.2s linear infinite 0.5s; top: -28px; left: 80%;"></div>
            <div class="meteor" style="position: absolute; width: 2px; height: 22px; background: linear-gradient(to bottom, transparent, #6c5ce7, transparent); animation: meteorFall 3.8s linear infinite 1.5s; top: -22px; left: 45%;"></div>
            <div class="meteor" style="position: absolute; width: 2px; height: 26px; background: linear-gradient(to bottom, transparent, #fd79a8, transparent); animation: meteorFall 4.5s linear infinite 2.5s; top: -26px; left: 70%;"></div>
            <div class="meteor" style="position: absolute; width: 2px; height: 24px; background: linear-gradient(to bottom, transparent, #00b894, transparent); animation: meteorFall 3.2s linear infinite 0.8s; top: -24px; left: 25%;"></div>
            <div class="meteor" style="position: absolute; width: 2px; height: 27px; background: linear-gradient(to bottom, transparent, #0984e3, transparent); animation: meteorFall 4.8s linear infinite 1.8s; top: -27px; left: 55%;"></div>
        </div>
        
        <div class="loading-content">
            <div class="loading-logo">
                <div class="cube-container" style="width: 80px; height: 80px;">
                    <div class="cube" style="width: 80px; height: 80px; transform-style: preserve-3d; animation: rotateCube 3s infinite linear;">
                        <div class="cube-face front" style="background: linear-gradient(45deg, var(--primary-color), var(--primary-light)); transform: translateZ(40px);">樱</div>
                        <div class="cube-face back" style="background: linear-gradient(45deg, var(--primary-light), var(--primary-color)); transform: rotateY(180deg) translateZ(40px);">梦</div>
                        <div class="cube-face right" style="background: linear-gradient(45deg, var(--primary-color), var(--primary-light)); transform: rotateY(90deg) translateZ(40px);">D</div>
                        <div class="cube-face left" style="background: linear-gradient(45deg, var(--primary-light), var(--primary-color)); transform: rotateY(-90deg) translateZ(40px);">X</div>
                        <div class="cube-face top" style="background: linear-gradient(45deg, var(--primary-color), var(--primary-light)); transform: rotateX(90deg) translateZ(40px);">A</div>
                        <div class="cube-face bottom" style="background: linear-gradient(45deg, var(--primary-light), var(--primary-color)); transform: rotateX(-90deg) translateZ(40px);">I</div>
                    </div>
                </div>
            </div>
            <h2 class="loading-title">樱梦DX AI</h2>
            <p class="loading-subtitle">正在加载数据...</p>
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">0%</div>
            </div>
            <div class="loading-complete" id="loadingComplete" style="display: none; margin-top: 20px;">
                <p style="color: var(--text-secondary); margin-bottom: 10px;">数据加载完成</p>
                <p style="color: var(--text-secondary); font-size: 0.9rem; opacity: 0.8;">单击屏幕继续</p>
            </div>
            <div class="loading-footer" style="position: absolute; bottom: 20px; left: 0; right: 0; text-align: center; color: var(--text-secondary); font-size: 0.8rem; opacity: 0.6;">
                <p>樱梦AI © 2026 | Made by 樱玖璃梦</p>
            </div>
        </div>
    </div>
    
    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <h1 class="login-title">樱梦DX AI</h1>
            
            <div class="login-tabs">
                <div class="login-tab active" data-tab="login">登录</div>
                <div class="login-tab" data-tab="register">注册</div>
            </div>
            
            <form id="loginForm" class="login-form active">
                <div class="form-group">
                    <label class="form-label" for="loginEmail">邮箱</label>
                    <input type="email" class="form-control" id="loginEmail" placeholder="请输入邮箱" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="loginUsername">账号</label>
                    <input type="text" class="form-control" id="loginUsername" placeholder="请输入账号" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="loginPassword">密码</label>
                    <input type="password" class="form-control" id="loginPassword" placeholder="请输入密码" required>
                </div>
                
                <button type="submit" class="btn btn-primary btn-block">
                    <i class="fas fa-sign-in-alt"></i>
                    登录
                </button>
                
                <div class="login-footer">
                    首次使用？请先注册账号
                </div>
            </form>
            
            <form id="registerForm" class="login-form">
                <div class="form-group">
                    <label class="form-label" for="registerEmail">邮箱</label>
                    <input type="email" class="form-control" id="registerEmail" placeholder="请输入邮箱" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="registerUsername">账号</label>
                    <input type="text" class="form-control" id="registerUsername" placeholder="请输入账号" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="registerPassword">密码</label>
                    <input type="password" class="form-control" id="registerPassword" placeholder="请输入密码" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="confirmPassword">确认密码</label>
                    <input type="password" class="form-control" id="confirmPassword" placeholder="请再次输入密码" required>
                </div>
                
                <button type="submit" class="btn btn-primary btn-block">
                    <i class="fas fa-user-plus"></i>
                    注册
                </button>
                
                <div class="login-footer">
                    已有账号？请直接登录
                </div>
            </form>
        </div>
    </div>
    
    <div class="app-container" id="appContainer">
        <div class="sidebar active" id="sidebar">
            <div class="sidebar-header">
                <div class="app-logo">
                    <div class="cube-container">
                        <div class="cube">
                            <div class="cube-face front">樱</div>
                            <div class="cube-face back">梦</div>
                            <div class="cube-face right">D</div>
                            <div class="cube-face left">X</div>
                            <div class="cube-face top">A</div>
                            <div class="cube-face bottom">I</div>
                        </div>
                    </div>
                    <div class="app-info">
                        <span class="app-name">樱梦DX AI</span>
                        <div class="app-version">SakuMuAI.Ver.2.1</div>
                        <div class="app-copyright" id="copyrightInfo">樱梦AI © 2026 | Made by 樱玖璃梦</div>
                    </div>
                </div>
                <button class="device-toggle-btn" id="deviceToggleBtn" onclick="toggleDeviceMode()">
                    <i class="fas fa-desktop"></i>
                </button>
            </div>
            
            <div class="user-info" id="userInfo">
                <div class="user-avatar-container">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div class="user-details">
                        <div class="user-name" id="userName">用户</div>
                        <div class="user-email" id="userEmail">user@example.com</div>
                    </div>
                </div>
                <button class="logout-btn" id="logoutBtn" title="退出登录">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
            
            <input type="file" id="avatarUploadInput" accept="image/*" style="display: none;">
            
            <div class="sidebar-content">
                <div class="mode-section">
                    <div class="section-title" id="recentConversationsTitle">
                        <i class="fas fa-chevron-down"></i>
                        <span>最近对话</span>
                    </div>
                    <div class="mode-list collapsed" id="recentConversations">
                    </div>
                </div>
                
                <div class="mode-section">
                    <div class="section-title mode-expandable" data-mode="chat">
                        <i class="fas fa-chevron-down"></i>
                        <i class="fas fa-comment-dots"></i>
                        <span>文字对话</span>
                        <button class="new-conversation-btn" data-mode="chat" title="新建对话">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="conversation-dropdown" data-mode="chat">
                        <div class="conversation-list-dropdown" id="conversationListChat">
                        </div>
                    </div>
                    
                    <div class="section-title mode-expandable" data-mode="document">
                        <i class="fas fa-chevron-down"></i>
                        <i class="fas fa-file-alt"></i>
                        <span>文档分析</span>
                        <button class="new-conversation-btn" data-mode="document" title="新建对话">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="conversation-dropdown" data-mode="document">
                        <div class="conversation-list-dropdown" id="conversationListDocument">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="battery-info">
                <div class="battery-header">
                    <div class="battery-title">
                        <i class="fas fa-battery-full"></i>
                        <span>电池</span>
                    </div>
                    <div class="battery-amount" id="batteryAmount">0.000</div>
                </div>
                
                <div class="current-time" id="currentTime"></div>
                

                <div class="time-card-info" id="timeCardInfo" style="display: none;">
                    <div class="time-card-item">
                        <i class="fas fa-clock"></i>
                        <span>到期时间:</span>
                        <span id="expireTime"></span>
                    </div>
                    <div class="time-card-item">
                        <i class="fas fa-hourglass-half"></i>
                        <span>剩余时间:</span>
                        <span id="remainingTime"></span>
                    </div>
                </div>
                
                <div class="battery-actions">
                    <button class="btn btn-success btn-block" id="rechargeBtn">
                        <i class="fas fa-bolt"></i>
                        充值
                    </button>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="main-header">
                <button class="menu-toggle" id="menuToggle">
                    <i class="fas fa-bars"></i>
                </button>
                
                <div class="conversation-header-info">
                    <div class="conversation-title" id="conversationTitle">新对话</div>
                    <div class="conversation-mode" id="conversationMode">文字对话</div>
                </div>
                
                <div class="header-actions">
                    <button class="btn btn-primary" id="batteryDetailsBtn">
                        <i class="fas fa-battery-three-quarters"></i>
                        <span>电池详情</span>
                    </button>
                    <button class="btn btn-primary" id="presetManagementBtn">
                        <i class="fas fa-sliders-h"></i>
                        <span>预设指令</span>
                        <span class="nickname-status disabled" id="presetStatusDisplay">未启用</span>
                    </button>
                    <button class="btn btn-info" id="settingsBtn">
                        <i class="fas fa-cog"></i>
                        <span>设置</span>
                    </button>
                </div>
                
                <div class="settings-panel" id="settingsPanel">
                    <div class="settings-title">
                        <span>设置</span>
                        <button class="btn btn-secondary btn-sm" id="closeSettingsBtn" style="padding: 4px 8px;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <!-- 对话设置 -->
                    <div class="settings-group">
                        <label class="settings-label">对话温度设置: <span class="settings-value" id="temperatureValue">0.7</span></label>
                        <input type="range" min="0" max="1.5" step="0.1" value="0.7" class="settings-slider" id="temperatureSlider">
                    </div>
                    
                    <div class="settings-group">
                        <label class="settings-label">记忆关联长度: <span class="settings-value" id="contextValue">10</span></label>
                        <input type="range" min="1" max="30" value="10" class="settings-slider" id="contextSlider">
                        <div class="context-cost-info">
                            <div>当前记忆预估消耗: <span id="contextCostEstimate">0.000</span> 电池</div>
                            <div>预估tokens: <span id="contextTokensEstimate">0</span></div>
                        </div>
                    </div>
                    
                    <!-- 界面设置分隔线 -->
                    <div class="settings-divider"></div>
                    
                    <!-- 界面设置 -->
                    <div class="settings-group">
                        <label class="settings-label">系统主题</label>
                        <div class="theme-selector" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px;">
                            <button class="theme-btn theme-purple active" data-theme="purple" style="width: 100%; height: 40px; border: 2px solid var(--primary-color); border-radius: 8px; background: linear-gradient(135deg, #7c3aed, #8b5cf6); cursor: pointer; transition: all 0.3s ease;"></button>
                            <button class="theme-btn theme-blue" data-theme="blue" style="width: 100%; height: 40px; border: 2px solid var(--border-color); border-radius: 8px; background: linear-gradient(135deg, #3b82f6, #60a5fa); cursor: pointer; transition: all 0.3s ease;"></button>
                            <button class="theme-btn theme-green" data-theme="green" style="width: 100%; height: 40px; border: 2px solid var(--border-color); border-radius: 8px; background: linear-gradient(135deg, #10b981, #34d399); cursor: pointer; transition: all 0.3s ease;"></button>
                            <button class="theme-btn theme-pink" data-theme="pink" style="width: 100%; height: 40px; border: 2px solid var(--border-color); border-radius: 8px; background: linear-gradient(135deg, #ec4899, #f472b6); cursor: pointer; transition: all 0.3s ease;"></button>
                            <button class="theme-btn theme-orange" data-theme="orange" style="width: 100%; height: 40px; border: 2px solid var(--border-color); border-radius: 8px; background: linear-gradient(135deg, #f59e0b, #fbbf24); cursor: pointer; transition: all 0.3s ease;"></button>
                            <button class="theme-btn theme-red" data-theme="red" style="width: 100%; height: 40px; border: 2px solid var(--border-color); border-radius: 8px; background: linear-gradient(135deg, #ef4444, #f87171); cursor: pointer; transition: all 0.3s ease;"></button>
                        </div>
                    </div>
                    
                    <!-- 对话气泡样式设置 -->
                    <div class="settings-group">
                        <label class="settings-label">对话气泡样式</label>
                        <div class="bubble-style-selector" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px;">
                            <button class="bubble-style-btn bubble-original active" data-style="original" style="width: 100%; height: 40px; border: 2px solid var(--primary-color); border-radius: 8px; background: linear-gradient(135deg, #ffffff, #f0f0f0); color: #1a1a1a; cursor: pointer; transition: all 0.3s ease;">原版</button>
                            <button class="bubble-style-btn bubble-transparent" data-style="transparent" style="width: 100%; height: 40px; border: 2px solid var(--border-color); border-radius: 8px; background: transparent; color: var(--text-primary); cursor: pointer; transition: all 0.3s ease;">全透明</button>
                            <button class="bubble-style-btn bubble-glass" data-style="glass" style="width: 100%; height: 40px; border: 2px solid var(--border-color); border-radius: 8px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); color: var(--text-primary); cursor: pointer; transition: all 0.3s ease;">毛玻璃</button>
                            <button class="bubble-style-btn bubble-semi-transparent" data-style="semi-transparent" style="width: 100%; height: 40px; border: 2px solid var(--border-color); border-radius: 8px; background: rgba(255, 255, 255, 0.5); color: #1a1a1a; cursor: pointer; transition: all 0.3s ease;">半透明</button>
                        </div>
                        <div class="toggle-switch-container" style="margin-top: 15px;">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <span style="color: var(--text-secondary);">智能文字颜色</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="smartTextColorToggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <p style="color: var(--text-secondary); font-size: 0.8rem; margin-top: 5px; opacity: 0.7;">
                                根据气泡背景自动调整文字颜色
                            </p>
                        </div>
                    </div>
                    
                    <!-- 个性化设置分隔线 -->
                    <div class="settings-divider"></div>
                    
                    <!-- 个性化设置 -->
                    <div class="settings-group">
                        <label class="settings-label">AI头像设置</label>
                        <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
                            <div class="ai-avatar-preview" id="aiAvatarPreview" style="width: 40px; height: 40px; border-radius: 50%; background-color: var(--primary-color); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; font-weight: bold;">AI</div>
                            <input type="file" id="aiAvatarUpload" accept="image/*" style="display: none;">
                            <button class="btn btn-secondary btn-sm" id="changeAiAvatarBtn" style="padding: 6px 12px;">
                                <i class="fas fa-image"></i>
                                更换头像
                            </button>
                            <button class="btn btn-secondary btn-sm" id="resetAiAvatarBtn" style="padding: 6px 12px;">
                                <i class="fas fa-redo"></i>
                                重置
                            </button>
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <label class="settings-label">聊天背景设置</label>
                        <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
                            <div class="background-preview" id="backgroundPreview" style="width: 60px; height: 40px; border-radius: 5px; border: 1px solid var(--border-color); overflow: hidden; background-size: cover; background-position: center;"></div>
                            <input type="file" id="backgroundUpload" accept="image/*" style="display: none;">
                            <button class="btn btn-secondary btn-sm" id="changeBackgroundBtn" style="padding: 6px 12px;">
                                <i class="fas fa-image"></i>
                                选择图片
                            </button>
                            <button class="btn btn-secondary btn-sm" id="resetBackgroundBtn" style="padding: 6px 12px;">
                                <i class="fas fa-redo"></i>
                                重置
                            </button>
                        </div>
                        <div style="margin-top: 10px; display: flex; gap: 5px;">
                            <button class="btn btn-secondary btn-sm" id="backgroundBlurBtn" style="padding: 4px 8px; font-size: 0.8rem;">
                                模糊效果
                            </button>
                            <button class="btn btn-secondary btn-sm" id="backgroundDarkenBtn" style="padding: 4px 8px; font-size: 0.8rem;">
                                暗化效果
                            </button>
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <label class="settings-label">全屏模式</label>
                        <div style="display: flex; align-items: center; gap: 15px; margin-top: 10px;">
                            <span id="fullscreenStatus" style="color: var(--text-secondary);">已开启全屏模式</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 15px; margin-top: 10px;">
                            <button class="btn btn-primary btn-sm" id="reEnterFullscreenBtn" style="padding: 6px 12px;">
                                <i class="fas fa-expand"></i>
                                开启全屏
                            </button>
                            <span style="color: var(--text-secondary); font-size: 0.9rem;">窗口下可启用</span>
                        </div>
                        
                        <!-- 自动进入全屏模式开关 -->
                        <div class="toggle-switch-container" style="margin-top: 15px;">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <span style="color: var(--text-secondary);">自动进入全屏模式</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="autoFullscreenToggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <p style="color: var(--text-secondary); font-size: 0.8rem; margin-top: 5px; opacity: 0.7;">
                                开启后，将自动进入全屏模式
                            </p>
                        </div>
                    </div>
                    
                    <!-- 系统功能分隔线 -->
                    <div class="settings-divider"></div>
                    
                    <!-- 系统功能 -->
                    <div class="settings-group">
                        <label class="settings-label">存储空间管理</label>
                        <div style="background-color: rgba(255, 255, 255, 0.03); border-radius: 8px; padding: 15px; margin-top: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <span style="color: var(--text-secondary);">已使用存储:</span>
                                <span id="storageUsage" style="color: var(--primary-color); font-weight: 500;">计算中...</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <span style="color: var(--text-secondary);">存储项目数:</span>
                                <span id="storageItemCount" style="color: var(--primary-color); font-weight: 500;">0</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <span style="color: var(--text-secondary);">存储状态:</span>
                                <span id="storageStatus" style="color: var(--success-color); font-weight: 500;">正常</span>
                            </div>
                            
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-primary btn-sm" id="refreshStorageBtn" style="flex: 1; padding: 8px 12px;">
                                    <i class="fas fa-sync-alt"></i>
                                    刷新统计
                                </button>
                                <button class="btn btn-warning btn-sm" id="cleanupStorageBtn" style="flex: 1; padding: 8px 12px;">
                                    <i class="fas fa-trash-alt"></i>
                                    一键清理
                                </button>
                            </div>
                            
                            <div id="storageDetails" style="margin-top: 15px; display: none;">
                                <div style="border-top: 1px solid var(--border-color); padding-top: 10px;">
                                    <h4 style="font-size: 0.9rem; margin-bottom: 10px; color: var(--text-secondary);">存储详情:</h4>
                                    <div id="storageItemsList" style="max-height: 150px; overflow-y: auto; font-size: 0.8rem; color: var(--text-secondary);"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 数据管理分隔线 -->
                    <div class="settings-divider"></div>
                    
                    <!-- 数据管理 -->
                    <button class="btn btn-primary" id="exportConversationBtn" style="width: 100%; margin-top: 15px;">
                        <i class="fas fa-download"></i>
                        导出当前对话
                    </button>
                    
                    <input type="file" id="importConversationFile" accept=".txt" style="display: none;">
                    <button class="btn btn-success" id="importConversationBtn" style="width: 100%; margin-top: 10px;">
                        <i class="fas fa-upload"></i>
                        导入对话
                    </button>
                </div>
            </div>
            
            <div class="chat-container">
                <div class="chat-background-overlay" id="chatBackgroundOverlay"></div>
                
                <div class="chat-window">
                    <div class="document-upload" id="documentUpload" style="display: none;">
                        <i class="fas fa-cloud-upload-alt fa-3x" style="color: var(--primary-color); margin-bottom: 15px;"></i>
                        <h3>上传文档进行分析</h3>
                        <p class="document-info">支持 .txt 和 .json 文件格式</p>
                        <input type="file" id="fileInput" accept=".txt,.json" style="display: none;">
                        <button class="btn btn-primary" style="margin-top: 15px;" id="uploadDocumentBtn">
                            <i class="fas fa-upload"></i>
                            选择文件
                        </button>
                        <div id="documentInfo" style="margin-top: 10px; font-size: 0.9rem;"></div>
                    </div>
                    
                    <div class="messages-container" id="messagesContainer">
                        <div class="empty-state">
                            <i class="fas fa-robot"></i>
                            <h3>开始新的对话</h3>
                            <p>选择左侧的对话或点击"+"按钮开始</p>
                        </div>
                    </div>
                    
                    <div class="cost-estimate" id="costEstimate" style="display: none;">
                        <div class="cost-estimate-item">
                            <span class="cost-label">记忆长度:</span>
                            <span class="cost-value" id="currentContextLengthDisplay">10</span>
                        </div>
                        <div class="cost-estimate-item">
                            <span class="cost-label">基础消耗:</span>
                            <span class="cost-value" id="totalCostEstimate">0.000</span>
                            <span>电池</span>
                        </div>
                    </div>
                    
                    <div class="input-container">
                        <div class="input-area">
                            <div class="input-buttons">
                                <button class="ai-first-button" id="aiFirstButton" style="display: none;">
                                    <i class="fas fa-microphone-alt"></i>
                                    <span>AI先说</span>
                                </button>
                                <button class="continue-button" id="continueButton" style="display: none;">
                                    <i class="fas fa-forward"></i>
                                    <span>继续</span>
                                </button>
                                <div class="message-input-container">
                                    <div class="resize-handle" id="resizeHandle"></div>
                                    <textarea class="message-input" id="messageInput" placeholder="输入消息..."></textarea>
                                </div>
                                <button class="send-button" id="sendButton">
                                    <i class="fas fa-paper-plane"></i>
                                    <span>发送</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="rechargeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">电池充值</h3>
                <button class="modal-close" id="closeRechargeModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">充值码</label>
                    <input type="text" class="form-control recharge-code-input" id="rechargeCode" placeholder="请输入充值码">
                </div>
                
                <button class="btn btn-primary" id="useRechargeCodeBtn" style="width: 100%; margin-top: 15px;">
                    <i class="fas fa-bolt"></i>
                    使用充值码
                </button>
                
                <div class="current-time" style="margin-top: 15px; text-align: center;" id="rechargeCurrentTime"></div>
                
                <div class="recharge-info" id="rechargeInfo" style="display: none;">
                    <div class="recharge-info-item">
                        <span>用户邮箱:</span>
                        <span id="rechargeEmail"></span>
                    </div>
                    <div class="recharge-info-item">
                        <span>用户账号:</span>
                        <span id="rechargeUsername"></span>
                    </div>
                    <div class="recharge-info-item">
                        <span>充值电池量:</span>
                        <span id="rechargeBattery" style="color: var(--secondary-color); font-weight: 700;"></span>
                    </div>
                    <div class="recharge-info-item">
                        <span>生成时间:</span>
                        <span id="rechargeTime"></span>
                    </div>
                    <div class="recharge-info-item">
                        <span>防伪码:</span>
                        <span id="rechargeSecurityCode" style="font-family: 'Courier New', monospace;"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="presetModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">预设指令管理</h3>
                <button class="modal-close" id="closePresetModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">切换预设指令</label>
                    <select class="form-control" id="presetSelect">
                        <option value="-1" selected>不使用</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">预设指令 <span id="presetTokensDisplay" style="color: var(--text-secondary); font-size: 0.9rem;">(tokens: 0)</span></label>
                    <textarea class="form-control" id="presetInstruction" rows="6" placeholder="输入预设指令..." disabled></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">自定义预设名称</label>
                    <input type="text" class="form-control" id="customPresetName" placeholder="自定义预设1" disabled>
                </div>
                
                <div class="form-group">
                    <label class="form-label">人物昵称设定</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="text" class="form-control" id="aiNickname" placeholder="AI昵称" disabled>
                        <input type="text" class="form-control" id="userNickname" placeholder="用户昵称" disabled>
                    </div>
                    <small style="color: var(--text-secondary); display: block; margin-top: 5px;">昵称需同时设置或同时留空</small>
                </div>
                
                <div class="preset-buttons">
                    <button class="btn btn-primary" id="newPresetBtn">
                        <i class="fas fa-plus"></i>
                        新建预设指令
                    </button>
                    <button class="btn btn-success" id="savePresetBtn">
                        <i class="fas fa-save"></i>
                        保存并应用
                    </button>
                </div>
                
                <div class="preset-list-section" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                    <h4 style="margin-bottom: 15px;">预设指令列表</h4>
                    <div id="presetListContainer" style="max-height: 200px; overflow-y: auto; margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 5px; padding: 10px;">
                        <div id="presetList">

                        </div>
                    </div>
                    
                    <div class="preset-import-export" style="display: flex; gap: 10px;">
                        <button class="btn btn-info" id="exportSelectedPresetsBtn" style="flex: 1;">
                            <i class="fas fa-download"></i>
                            导出选中预设
                        </button>
                        <button class="btn btn-warning" id="importPresetsBtn" style="flex: 1;">
                            <i class="fas fa-upload"></i>
                            导入预设
                        </button>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn btn-danger" id="deletePresetBtn" style="width: 100%;">
                        <i class="fas fa-trash"></i>
                        删除当前预设
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal battery-details-modal" id="batteryDetailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">电池详情</h3>
                <button class="modal-close" id="closeBatteryDetailsModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="battery-summary" style="margin-bottom: 20px; padding: 15px; background-color: rgba(255, 255, 255, 0.03); border-radius: 8px;">
                    <div class="battery-summary-item battery-summary-total">
                        <span>总消耗:</span>
                        <span id="batteryDetailsTotalCost">0.000</span>
                    </div>
                    <div class="battery-summary-item battery-summary-remaining">
                        <span>电池剩余:</span>
                        <span id="batteryDetailsRemaining">0.000</span>
                    </div>

                    <div class="time-card-summary" id="timeCardSummary" style="display: none; margin-top: 10px; padding: 10px; background-color: rgba(16, 185, 129, 0.1); border-radius: 5px;">
                        <div class="time-card-summary-item">
                            <i class="fas fa-crown"></i>
                            <span>当前状态:</span>
                            <span id="timeCardStatus"></span>
                        </div>
                        <div class="time-card-summary-item">
                            <i class="fas fa-clock"></i>
                            <span>到期时间:</span>
                            <span id="timeCardExpire"></span>
                        </div>
                        <div class="time-card-summary-item">
                            <i class="fas fa-hourglass-half"></i>
                            <span>剩余时间:</span>
                            <span id="timeCardRemaining"></span>
                        </div>
                    </div>
                </div>
                
                <div class="price-table-section" style="margin-top: 30px;">
                    <h4 style="margin-bottom: 20px; color: var(--primary-color); border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">价目表</h4>
                    
                    <div class="price-table-container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        
                        <div class="battery-pricing">
                            <h5 style="color: var(--secondary-color); margin-bottom: 15px;"><i class="fas fa-battery-full"></i> 电池计费</h5>
                            <div class="price-item" style="background-color: rgba(255, 255, 255, 0.03); border-radius: 8px; padding: 12px; margin-bottom: 10px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span>1元</span>
                                    <span style="color: var(--secondary-color); font-weight: 500;">200电池</span>
                                </div>
                            </div>
                            <div class="price-item" style="background-color: rgba(255, 255, 255, 0.03); border-radius: 8px; padding: 12px; margin-bottom: 10px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span>5元</span>
                                    <span style="color: var(--secondary-color); font-weight: 500;">1100电池</span>
                                </div>
                            </div>
                            <div class="price-item" style="background-color: rgba(255, 255, 255, 0.03); border-radius: 8px; padding: 12px; margin-bottom: 10px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span>20元</span>
                                    <span style="color: var(--secondary-color); font-weight: 500;">5000电池</span>
                                </div>
                            </div>
                            <div class="price-item" style="background-color: rgba(255, 255, 255, 0.03); border-radius: 8px; padding: 12px; margin-bottom: 10px; opacity: 0.6;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span>15000电池</span>
                                    <span style="color: var(--text-secondary); font-style: italic;">暂未开放购买</span>
                                </div>
                            </div>
                            <div class="price-item" style="background-color: rgba(255, 255, 255, 0.03); border-radius: 8px; padding: 12px; margin-bottom: 10px; opacity: 0.6;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span>35000电池</span>
                                    <span style="color: var(--text-secondary); font-style: italic;">暂未开放购买</span>
                                </div>
                            </div>
                            <div class="price-item" style="background-color: rgba(255, 255, 255, 0.03); border-radius: 8px; padding: 12px; margin-bottom: 10px; opacity: 0.6;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span>80000电池</span>
                                    <span style="color: var(--text-secondary); font-style: italic;">暂未开放购买</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="membership-pricing">
                            <h5 style="color: var(--warning-color); margin-bottom: 15px;"><i class="fas fa-crown"></i> 会员卡</h5>
                            <div class="price-item" style="background-color: rgba(255, 255, 255, 0.03); border-radius: 8px; padding: 12px; margin-bottom: 10px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span>1元</span>
                                    <span style="color: var(--warning-color); font-weight: 500;">1天</span>
                                </div>
                            </div>
                            <div class="price-item" style="background-color: rgba(255, 255, 255, 0.03); border-radius: 8px; padding: 12px; margin-bottom: 10px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span>5元</span>
                                    <span style="color: var(--warning-color); font-weight: 500;">7天</span>
                                </div>
                            </div>
                            <div class="price-item" style="background-color: rgba(255, 255, 255, 0.03); border-radius: 8px; padding: 12px; margin-bottom: 10px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span>20元</span>
                                    <span style="color: var(--warning-color); font-weight: 500;">30天</span>
                                </div>
                            </div>
                            <div class="price-item" style="background-color: rgba(255, 255, 255, 0.03); border-radius: 8px; padding: 12px; margin-bottom: 10px; opacity: 0.6;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span>90天</span>
                                    <span style="color: var(--text-secondary); font-style: italic;">暂未开放购买</span>
                                </div>
                            </div>
                            <div class="price-item" style="background-color: rgba(255, 255, 255, 0.03); border-radius: 8px; padding: 12px; margin-bottom: 10px; opacity: 0.6;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span>180天</span>
                                    <span style="color: var(--text-secondary); font-style: italic;">暂未开放购买</span>
                                </div>
                            </div>
                            <div class="price-item" style="background-color: rgba(255, 255, 255, 0.03); border-radius: 8px; padding: 12px; margin-bottom: 10px; opacity: 0.6;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span>365天</span>
                                    <span style="color: var(--text-secondary); font-style: italic;">暂未开放购买</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px; padding: 15px; background-color: rgba(59, 130, 246, 0.1); border-radius: 8px; font-size: 0.9rem; color: var(--text-secondary);">
                        <i class="fas fa-info-circle"></i> 如需购买，请联系管理员获取充值码
                    </div>
                </div>

            </div>
        </div>
    </div>
    
    <div class="modal" id="renameModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">重命名对话</h3>
                <button class="modal-close" id="closeRenameModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">对话名称</label>
                    <input type="text" class="form-control" id="conversationName" placeholder="输入对话名称">
                </div>
                <button class="btn btn-primary" id="saveRenameBtn" style="width: 100%;">
                    <i class="fas fa-save"></i>
                    保存
                </button>
            </div>
        </div>
    </div>
    
    <div class="modal warning-modal" id="deleteApiModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title warning-header">
                    <i class="fas fa-exclamation-triangle"></i>
                    警告
                </h3>
            </div>
            <div class="warning-body">
                <div class="warning-icon">
                    <i class="fas fa-radiation-alt"></i>
                </div>
                <div class="warning-text">
                    您即将删除API密钥，此操作不可逆！<br>
                    删除后将无法使用AI功能，请谨慎操作！
                </div>
                <div class="warning-timer" id="deleteTimer">10</div>
                <div class="warning-actions">
                    <button class="btn btn-secondary" id="cancelDeleteApiBtn">取消</button>
                    <button class="btn btn-danger" id="confirmDeleteApiBtn" disabled>
                        <i class="fas fa-trash-alt"></i>
                        确认删除 (<span id="deleteCountdown">10</span>)
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="apiModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">API 管理</h3>
                <button class="modal-close" id="closeApiModal">&times;</button>
            </div>
            <div class="modal-body">
                <h4 style="margin-bottom: 15px;">添加新API</h4>
                <div class="form-group">
                    <label class="form-label">API名称</label>
                    <input type="text" class="form-control" id="apiName" placeholder="如: DeepSeek API">
                </div>
                <div class="form-group">
                    <label class="form-label">API密钥</label>
                    <input type="password" class="form-control" id="apiKey" placeholder="输入API密钥">
                </div>
                <div class="form-group">
                    <label class="form-label">端点URL</label>
                    <input type="text" class="form-control" id="apiEndpoint" placeholder="https://api.deepseek.com/v1">
                </div>
                <div class="form-group">
                    <label class="form-label">模型</label>
                    <input type="text" class="form-control" id="apiModel" placeholder="deepseek-chat">
                </div>
                <button class="btn btn-primary" id="addApiBtn" style="width: 100%; margin-bottom: 25px;">
                    <i class="fas fa-plus"></i>
                    添加API
                </button>
                
                <h4 style="margin-bottom: 15px;">已保存的 API</h4>
                <div class="api-list" id="apiList">
                </div>
                
                <div style="text-align: center; margin-top: 20px; color: var(--text-secondary); font-size: 0.9rem;">
                    <i class="fas fa-info-circle"></i> 此页面仅供高级用户使用
                </div>
            </div>
        </div>
    </div>
    
    <div class="notification" id="notification">
        <i class="fas fa-info-circle"></i>
        <span id="notificationMessage">通知内容</span>
    </div>
    
    <script>
        const TOKEN_COST_CONFIG = {
            COST_PER_TOKEN: 0.001,
            WEIGHTS: {
                CHINESE_CHAR: 0.65,
                ENGLISH_CHAR: 0.35,
                DIGIT: 0.25,
                COMMON_PUNCTUATION: 1.0,
                WHITESPACE: 0.25,
                OTHER: 1.0,
                SYSTEM_MESSAGE_OVERHEAD: 0,
                MESSAGE_FORMAT_OVERHEAD: 0
            }
        };
        
        let currentUser = null;
        let currentMode = 'chat';
        let conversations = {
            chat: [],
            document: []
        };
        let currentConversationId = null;
        let apis = [];
        let currentApiId = null;
        
        let customPresets = [];
        
        let battery = 0.000;
        let isRechargeCodeUsed = false;
        let apiToDelete = null;
        let deleteTimer = null;
        let deleteCountdown = 10;
        let temperature = 0.7;
        let contextLength = 10;
        let currentConversationCost = 0;
        let todayCost = 0;
        let totalCost = 0;
        
        const ENCRYPTION_KEY = 'sakura-ai-encryption-key-2024';
        
        const loginContainer = document.getElementById('loginContainer');
        const appContainer = document.getElementById('appContainer');
        const loginTabs = document.querySelectorAll('.login-tab');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const loginEmail = document.getElementById('loginEmail');
        const loginUsername = document.getElementById('loginUsername');
        const loginPassword = document.getElementById('loginPassword');
        const registerEmail = document.getElementById('registerEmail');
        const registerUsername = document.getElementById('registerUsername');
        const registerPassword = document.getElementById('registerPassword');
        const confirmPassword = document.getElementById('confirmPassword');
        const sidebar = document.getElementById('sidebar');
        const menuToggle = document.getElementById('menuToggle');
        const userInfo = document.getElementById('userInfo');
        const userAvatar = document.getElementById('userAvatar');
        const userName = document.getElementById('userName');
        const userEmail = document.getElementById('userEmail');
        const logoutBtn = document.getElementById('logoutBtn');
        const batteryAmount = document.getElementById('batteryAmount');
        const rechargeBtn = document.getElementById('rechargeBtn');
        const currentTimeElement = document.getElementById('currentTime');
        const recentConversationsTitle = document.getElementById('recentConversationsTitle');
        const recentConversations = document.getElementById('recentConversations');
        const modeItems = document.querySelectorAll('.mode-item[data-mode]');
        const conversationTitle = document.getElementById('conversationTitle');
        const conversationMode = document.getElementById('conversationMode');
        const conversationListChat = document.getElementById('conversationListChat');
        const conversationListDocument = document.getElementById('conversationListDocument');
        const messagesContainer = document.getElementById('messagesContainer');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const presetManagementBtn = document.getElementById('presetManagementBtn');
        const rechargeModal = document.getElementById('rechargeModal');
        const closeRechargeModal = document.getElementById('closeRechargeModal');
        const rechargeCode = document.getElementById('rechargeCode');
        const useRechargeCodeBtn = document.getElementById('useRechargeCodeBtn');
        const rechargeInfo = document.getElementById('rechargeInfo');
        const rechargeEmail = document.getElementById('rechargeEmail');
        const rechargeUsername = document.getElementById('rechargeUsername');
        const rechargeBattery = document.getElementById('rechargeBattery');
        const rechargeTime = document.getElementById('rechargeTime');
        const rechargeSecurityCode = document.getElementById('rechargeSecurityCode');
        const rechargeCurrentTime = document.getElementById('rechargeCurrentTime');
        const presetModal = document.getElementById('presetModal');
        const renameModal = document.getElementById('renameModal');
        const closePresetModal = document.getElementById('closePresetModal');
        const closeRenameModal = document.getElementById('closeRenameModal');
        const presetSelect = document.getElementById('presetSelect');
        const presetInstruction = document.getElementById('presetInstruction');
        const savePresetBtn = document.getElementById('savePresetBtn');
        const conversationNameInput = document.getElementById('conversationName');
        const saveRenameBtn = document.getElementById('saveRenameBtn');
        const documentUpload = document.getElementById('documentUpload');
        const uploadDocumentBtn = document.getElementById('uploadDocumentBtn');
        const fileInput = document.getElementById('fileInput');
        const documentInfo = document.getElementById('documentInfo');
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsPanel = document.getElementById('settingsPanel');
        const closeSettingsBtn = document.getElementById('closeSettingsBtn');
        const temperatureSlider = document.getElementById('temperatureSlider');
        const temperatureValue = document.getElementById('temperatureValue');
        const contextSlider = document.getElementById('contextSlider');
        const contextValue = document.getElementById('contextValue');
        const exportConversationBtn = document.getElementById('exportConversationBtn');
        const apiModal = document.getElementById('apiModal');
        const closeApiModal = document.getElementById('closeApiModal');
        const apiList = document.getElementById('apiList');
        const apiName = document.getElementById('apiName');
        const apiKey = document.getElementById('apiKey');
        const apiEndpoint = document.getElementById('apiEndpoint');
        const apiModel = document.getElementById('apiModel');
        const addApiBtn = document.getElementById('addApiBtn');
        const deleteApiModal = document.getElementById('deleteApiModal');
        const cancelDeleteApiBtn = document.getElementById('cancelDeleteApiBtn');
        const confirmDeleteApiBtn = document.getElementById('confirmDeleteApiBtn');
        const deleteTimerElement = document.getElementById('deleteTimer');
        const deleteCountdownElement = document.getElementById('deleteCountdown');
        const notification = document.getElementById('notification');
        const notificationMessage = document.getElementById('notificationMessage');
        const costEstimate = document.getElementById('costEstimate');
        const currentContextLengthDisplay = document.getElementById('currentContextLengthDisplay');
        const totalCostEstimate = document.getElementById('totalCostEstimate');
        const contextCostEstimate = document.getElementById('contextCostEstimate');
        const contextTokensEstimate = document.getElementById('contextTokensEstimate');
        const presetTokensDisplay = document.getElementById('presetTokensDisplay');
        const presetStatusDisplay = document.getElementById('presetStatusDisplay');
        const customPresetName = document.getElementById('customPresetName');
        const aiNickname = document.getElementById('aiNickname');
        const userNickname = document.getElementById('userNickname');
        const newPresetBtn = document.getElementById('newPresetBtn');
        const deletePresetBtn = document.getElementById('deletePresetBtn');
        const exportSelectedPresetsBtn = document.getElementById('exportSelectedPresetsBtn');
        const importPresetsBtn = document.getElementById('importPresetsBtn');
        const presetList = document.getElementById('presetList');
        const batteryDetailsBtn = document.getElementById('batteryDetailsBtn');
        const batteryDetailsModal = document.getElementById('batteryDetailsModal');
        const closeBatteryDetailsModal = document.getElementById('closeBatteryDetailsModal');
        const batteryDetailsTotalCost = document.getElementById('batteryDetailsTotalCost');
        const aiFirstButton = document.getElementById('aiFirstButton');
        const continueButton = document.getElementById('continueButton');
        
        function estimateTextTokens(text) {
            if (!text || typeof text !== 'string') return 0;
            
            let totalTokens = 0;
            
            for (let i = 0; i < text.length; i++) {
                const charCode = text.charCodeAt(i);
                const char = text.charAt(i);
                
                if (charCode >= 0x4E00 && charCode <= 0x9FFF) {
                    totalTokens += TOKEN_COST_CONFIG.WEIGHTS.CHINESE_CHAR;
                } else if (/[a-zA-Z]/.test(char)) {
                    totalTokens += TOKEN_COST_CONFIG.WEIGHTS.ENGLISH_CHAR;
                } else if (/[0-9]/.test(char)) {
                    totalTokens += TOKEN_COST_CONFIG.WEIGHTS.DIGIT;
                } else if (/[,.;:'"!?，。；："！？、]/.test(char)) {
                    totalTokens += TOKEN_COST_CONFIG.WEIGHTS.COMMON_PUNCTUATION;
                } else if (/\s/.test(char)) {
                    totalTokens += TOKEN_COST_CONFIG.WEIGHTS.WHITESPACE;
                } else {
                    totalTokens += TOKEN_COST_CONFIG.WEIGHTS.OTHER;
                }
            }
            
            return Math.max(1, totalTokens);
        }
        
        function calculateMessageTokens(message, isSystemMessage = false) {
            let tokens = estimateTextTokens(message);
            
            tokens += TOKEN_COST_CONFIG.WEIGHTS.MESSAGE_FORMAT_OVERHEAD;
            
            if (isSystemMessage) {
                tokens += TOKEN_COST_CONFIG.WEIGHTS.SYSTEM_MESSAGE_OVERHEAD;
            }
            
            return tokens;
        }
        
        function calculateRequestTokens(conversation, newUserMessage = null) {
            let totalTokens = 0;
            
            if (conversation.presetIndex !== -1 && conversation.presetContent) {
                totalTokens += calculateMessageTokens(conversation.presetContent, true);
            }
            
            if (conversation.aiNickname && conversation.userNickname) {
                const nicknameMessage = `[你的名字:${conversation.aiNickname}][你对用户的称呼:${conversation.userNickname}]`;
                totalTokens += calculateMessageTokens(nicknameMessage, true);
            }
            
            if (currentMode === 'document' && conversation.document) {
                const docMessage = `用户上传了一个文档，内容如下:\n\n${conversation.document.content}\n\n请根据文档内容回答用户的问题。`;
                totalTokens += calculateMessageTokens(docMessage, true);
            }
            
            const messages = [...conversation.messages];
            
            if (newUserMessage) {
                const tempMessage = {
                    role: 'user',
                    content: newUserMessage,
                    timestamp: new Date().toISOString()
                };
                messages.push(tempMessage);
            }
            
            const contextLength = conversation.contextLength || 5;
            const startIndex = Math.max(0, messages.length - contextLength * 2);
            
            for (let i = startIndex; i < messages.length; i++) {
                const msg = messages[i];
                const isSystemMsg = msg.role === 'system';
                totalTokens += calculateMessageTokens(msg.content, isSystemMsg);
            }
            
            return Math.ceil(totalTokens);
        }
        
        function calculateBatteryCostByTokens(conversation, userMessage = null, aiResponse = null) {
            const requestTokens = calculateRequestTokens(conversation, userMessage);
            
            const responseTokens = aiResponse ? estimateTextTokens(aiResponse) : 0;
            
            const totalTokens = requestTokens + responseTokens;
            
            const cost = totalTokens * TOKEN_COST_CONFIG.COST_PER_TOKEN;
            
            return {
                totalTokens: totalTokens,
                requestTokens: requestTokens,
                responseTokens: responseTokens,
                cost: parseFloat(cost.toFixed(6))
            };
        }
        
        function calculateBatteryCostByTokensForText(text) {
            const tokens = estimateTextTokens(text);
            const cost = tokens * TOKEN_COST_CONFIG.COST_PER_TOKEN;
            return parseFloat(cost.toFixed(6));
        }
        
        function calculateContextCost(conversation, userMessage = null) {
            const requestTokens = calculateRequestTokens(conversation, userMessage);
            const cost = requestTokens * TOKEN_COST_CONFIG.COST_PER_TOKEN;
            
            return {
                tokens: requestTokens,
                cost: parseFloat(cost.toFixed(6))
            };
        }
        
        function updateCostEstimate() {
            const conversation = getCurrentConversation();
            if (!conversation) {
                costEstimate.style.display = 'none';
                return;
            }
            
            const userMessage = messageInput.value.trim();
            const contextCost = calculateContextCost(conversation, userMessage);
            
            currentContextLengthDisplay.textContent = conversation.contextLength || contextLength;
            totalCostEstimate.textContent = contextCost.cost.toFixed(3);
            
            costEstimate.style.display = 'flex';
            
            updateContextCostInfo();
        }
        
        function updateContextCostInfo() {
            const conversation = getCurrentConversation();
            if (!conversation) return;
            
            const contextCost = calculateContextCost(conversation);
            contextCostEstimate.textContent = contextCost.cost.toFixed(3);
            contextTokensEstimate.textContent = contextCost.tokens;
        }
        
        function updatePresetTokensDisplay() {
            const tokens = estimateTextTokens(presetInstruction.value);
            presetTokensDisplay.textContent = `(tokens: ${tokens})`;
        }
        
        function updateActionButtons() {
            const conversation = getCurrentConversation();
            if (!conversation) {
                aiFirstButton.style.display = 'none';
                continueButton.style.display = 'none';
                return;
            }
            
            const messageCount = conversation.messages.length;
            
            if (messageCount === 0) {
                aiFirstButton.style.display = 'flex';
                continueButton.style.display = 'none';
            } else {
                aiFirstButton.style.display = 'none';
                continueButton.style.display = 'flex';
            }
            
            const isTimeCardActive = currentUser && currentUser.timeCard && currentUser.timeCard.active;
            aiFirstButton.disabled = battery <= 0 && !isTimeCardActive;
            continueButton.disabled = battery <= 0 && !isTimeCardActive;
        }


        let mobileSettings = {
            isMobileMode: false,
            autoDetect: true,
            compactMode: false,
            gestureSupport: true
        };

        function detectDeviceType() {
            const userAgent = navigator.userAgent.toLowerCase();
            const isMobile = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent);
            const isTablet = /ipad|android(?!.*mobile)|tablet/i.test(userAgent);
            const screenWidth = window.innerWidth;
            
            if (isMobile || screenWidth <= 768) {
                return 'mobile';
            } else if (isTablet || (screenWidth > 768 && screenWidth <= 1024)) {
                return 'tablet';
            } else {
                return 'desktop';
            }
        }

        function applyMobileMode() {
            const deviceType = detectDeviceType();
            const shouldApplyMobile = mobileSettings.autoDetect ? 
                (deviceType === 'mobile' || deviceType === 'tablet') : 
                mobileSettings.isMobileMode;
            
            document.body.classList.toggle('mobile-mode', shouldApplyMobile);
            
            if (shouldApplyMobile) {
                document.body.classList.toggle('compact-mode', mobileSettings.compactMode);
                document.body.classList.toggle('gesture-support', mobileSettings.gestureSupport);
                

                if (mobileSettings.gestureSupport) {
                    initMobileGestures();
                }
            }
            

            updateSettingsUI();
            updateDeviceToggleButton();
        }

        function updateDeviceToggleButton() {
            const deviceToggleBtn = document.getElementById('deviceToggleBtn');
            if (deviceToggleBtn) {
                const isMobileMode = document.body.classList.contains('mobile-mode');
                deviceToggleBtn.innerHTML = isMobileMode ? 
                    '<i class="fas fa-mobile-alt"></i>' : 
                    '<i class="fas fa-desktop"></i>';
                deviceToggleBtn.title = isMobileMode ? '切换到桌面模式' : '切换到移动模式';
            }
        }

        function toggleDeviceMode() {
            mobileSettings.autoDetect = false;
            mobileSettings.isMobileMode = !document.body.classList.contains('mobile-mode');
            applyMobileMode();
        }

        function initMobileGestures() {
            let startY = 0;
            let currentY = 0;
            
            document.addEventListener('touchstart', function(e) {
                startY = e.touches[0].clientY;
            });
            
            document.addEventListener('touchmove', function(e) {
                if (!mobileSettings.gestureSupport) return;
                
                currentY = e.touches[0].clientY;
                const deltaY = currentY - startY;
                

                if (window.scrollY === 0 && deltaY > 50) {
                    e.preventDefault();

                }
            });
            

            let lastTap = 0;
            document.addEventListener('touchend', function(e) {
                const currentTime = new Date().getTime();
                const tapLength = currentTime - lastTap;
                
                if (tapLength < 300 && tapLength > 0) {

                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
                lastTap = currentTime;
            });
        }

        function updateSettingsUI() {
            const mobileModeToggle = document.getElementById('mobileModeToggle');
            const autoDetectCheckbox = document.getElementById('autoDetectDevice');
            const compactModeCheckbox = document.getElementById('compactMode');
            const gestureSupportCheckbox = document.getElementById('gestureSupport');
            
            if (mobileModeToggle) {
                mobileModeToggle.classList.toggle('active', mobileSettings.isMobileMode);
            }
            if (autoDetectCheckbox) {
                autoDetectCheckbox.checked = mobileSettings.autoDetect;
            }
            if (compactModeCheckbox) {
                compactModeCheckbox.checked = mobileSettings.compactMode;
            }
            if (gestureSupportCheckbox) {
                gestureSupportCheckbox.checked = mobileSettings.gestureSupport;
            }
        }

        function loadMobileSettings() {
            const savedSettings = localStorage.getItem('sakuraAI_mobileSettings');
            if (savedSettings) {
                Object.assign(mobileSettings, JSON.parse(savedSettings));
            }
            applyMobileMode();
        }

        function saveMobileSettings() {
            localStorage.setItem('sakuraAI_mobileSettings', JSON.stringify(mobileSettings));
            applyMobileMode();
        }

        function setupMobileEventListeners() {
            const mobileSettingsBtn = document.getElementById('mobileSettingsBtn');
            const settingsModal = document.getElementById('settingsModal');
            const closeSettings = document.getElementById('closeSettings');
            const mobileModeToggle = document.getElementById('mobileModeToggle');
            const saveSettingsBtn = document.getElementById('saveSettings');
            const sidebar = document.getElementById('sidebar');
            const menuToggle = document.getElementById('menuToggle');
            
            if (mobileSettingsBtn) {
                mobileSettingsBtn.addEventListener('click', function() {
                    settingsModal.style.display = 'block';
                });
            }
            
            if (closeSettings) {
                closeSettings.addEventListener('click', function() {
                    settingsModal.style.display = 'none';
                });
            }
            
            if (settingsModal) {
                settingsModal.addEventListener('click', function(e) {
                    if (e.target === settingsModal) {
                        settingsModal.style.display = 'none';
                    }
                });
            }
            
            if (mobileModeToggle) {
                mobileModeToggle.addEventListener('click', function() {
                    mobileSettings.isMobileMode = !mobileSettings.isMobileMode;
                    updateSettingsUI();
                });
            }
            
            if (saveSettingsBtn) {
                saveSettingsBtn.addEventListener('click', function() {
                    mobileSettings.autoDetect = document.getElementById('autoDetectDevice').checked;
                    mobileSettings.compactMode = document.getElementById('compactMode').checked;
                    mobileSettings.gestureSupport = document.getElementById('gestureSupport').checked;
                    
                    saveMobileSettings();
                    settingsModal.style.display = 'none';
                    

                    showNotification('设置已保存', 'success');
                });
            }
            

            if (sidebar) {
                let startX = 0;
                let currentX = 0;
                
                sidebar.addEventListener('touchstart', function(e) {
                    startX = e.touches[0].clientX;
                });
                
                sidebar.addEventListener('touchmove', function(e) {
                    if (!mobileSettings.gestureSupport) return;
                    
                    currentX = e.touches[0].clientX;
                    const deltaX = currentX - startX;
                    

                    if (deltaX < -50 && sidebar.classList.contains('active')) {
                        sidebar.classList.remove('active');
                    }
                });
                

                document.addEventListener('click', function(e) {
                    if (mobileSettings.isMobileMode && 
                        sidebar.classList.contains('active') && 
                        !sidebar.contains(e.target) && 
                        e.target !== menuToggle) {
                        sidebar.classList.remove('active');
                    }
                });
            }
            

            window.addEventListener('resize', function() {
                if (mobileSettings.autoDetect) {
                    applyMobileMode();
                }
            });
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background-color: ${type === 'success' ? 'var(--secondary-color)' : 'var(--info-color)'};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }


        const mobileStyles = document.createElement('style');
        mobileStyles.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
            
            .mobile-mode .sidebar {
                transition: all 0.3s ease;
            }
            
            .compact-mode .message {
                padding: 8px 12px;
                margin: 6px 0;
            }
            
            .compact-mode .message-content {
                font-size: 0.9rem;
                line-height: 1.4;
            }
            
            .gesture-support {
                -webkit-user-select: none;
                -webkit-touch-callout: none;
                -webkit-tap-highlight-color: transparent;
            }
            

            .mobile-mode .message-input {
                font-size: 16px;
            }
            

            .mobile-mode .btn {
                min-height: 44px;
                min-width: 44px;
            }
            

            .mobile-mode .conversation-area {
                -webkit-overflow-scrolling: touch;
                overflow-scrolling: touch;
            }
            

            @supports (padding: max(0px)) {
                .mobile-mode .main-content {
                    padding-top: env(safe-area-inset-top);
                }
                
                .mobile-mode .message-input-area {
                    padding-bottom: env(safe-area-inset-bottom);
                }
            }
        `;
        document.head.appendChild(mobileStyles);
        

        function startLoadingAnimation() {
            const loadingContainer = document.getElementById('loadingContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const loadingComplete = document.getElementById('loadingComplete');
            
            let progress = 0;
            const startTime = Date.now();
            const minDisplayTime = 2000;
            
            function updateProgress() {
                const elapsedTime = Date.now() - startTime;
                const targetProgress = Math.min(100, (elapsedTime / minDisplayTime) * 100);
                

                progress = Math.min(progress + 2, targetProgress);
                
                progressFill.style.width = progress + '%';
                progressText.textContent = Math.round(progress) + '%';
                
                if (progress < 100) {
                    setTimeout(updateProgress, 30);
                } else {

                    const remainingTime = minDisplayTime - elapsedTime;
                    if (remainingTime > 0) {
                        setTimeout(showLoadingComplete, remainingTime);
                    } else {
                        showLoadingComplete();
                    }
                }
            }
            
            function showLoadingComplete() {

                loadingComplete.style.display = 'block';
                

                loadingContainer.style.cursor = 'pointer';
                loadingContainer.addEventListener('click', function() {
                    hideLoading();
                });
            }
            
            function hideLoading() {
                loadingContainer.classList.add('hidden');
                setTimeout(() => {
                    loadingContainer.style.display = 'none';

                    const autoFullscreenEnabled = localStorage.getItem('autoFullscreenEnabled') !== 'false';
                    if (autoFullscreenEnabled) {
                        enterFullscreen();
                    }
                }, 500);
            }
            
            updateProgress();
        }
        

        function enterFullscreen() {
            const docEl = document.documentElement;
            if (docEl.requestFullscreen) {
                docEl.requestFullscreen();
            } else if (docEl.webkitRequestFullscreen) {
                docEl.webkitRequestFullscreen();
            } else if (docEl.mozRequestFullScreen) {
                docEl.mozRequestFullScreen();
            } else if (docEl.msRequestFullscreen) {
                docEl.msRequestFullscreen();
            }
        }
        

        
        document.addEventListener('DOMContentLoaded', function() {
            startLoadingAnimation();
            checkLoginStatus();
            setupEventListeners();
            
            // 初始化设备模式检测
            applyMobileMode();
            
            // 监听窗口大小变化
            window.addEventListener('resize', function() {
                if (mobileSettings.autoDetect) {
                    applyMobileMode();
                }
            });
            
            document.addEventListener('keydown', handleKeyboardShortcuts);
            
            setTimeout(() => {
                if (!recentConversations.classList.contains('collapsed')) {
                    toggleRecentConversations();
                }
            }, 100);
            
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
        });
        
        function updateCurrentTime() {
            const now = new Date();
            const formattedTime = formatDateTime(now);
            currentTimeElement.textContent = formattedTime;
            
            if (rechargeModal.classList.contains('active')) {
                rechargeCurrentTime.textContent = formattedTime;
            }
            
            
            if (currentUser && currentUser.timeCard && currentUser.timeCard.active) {
                const timeCardInfo = document.getElementById('timeCardInfo');
                const remainingTime = document.getElementById('remainingTime');
                
                if (timeCardInfo && timeCardInfo.style.display !== 'none' && remainingTime) {
                    const endTime = new Date(currentUser.timeCard.endTime);
                    const remainingMs = endTime.getTime() - now.getTime();
                    remainingTime.textContent = formatRemainingTime(remainingMs);
                }
                
                
                const batteryDetailsModal = document.getElementById('batteryDetailsModal');
                const timeCardRemaining = document.getElementById('timeCardRemaining');
                
                if (batteryDetailsModal && batteryDetailsModal.classList.contains('active') && timeCardRemaining) {
                    const endTime = new Date(currentUser.timeCard.endTime);
                    const remainingMs = endTime.getTime() - now.getTime();
                    timeCardRemaining.textContent = formatRemainingTime(remainingMs);
                }
                
                
                const endTime = new Date(currentUser.timeCard.endTime);
                const remainingMs = endTime.getTime() - now.getTime();
                if (remainingMs <= 0) {
                    
                    battery = currentUser.timeCard.originalBattery || 0.000;
                    currentUser.timeCard.active = false;
                    currentUser.timeCard.type = null;
                    currentUser.timeCard.startTime = null;
                    currentUser.timeCard.endTime = null;
                    currentUser.timeCard.originalBattery = battery;
                    
                    saveUserData();
                    updateUserUI();
                    showNotification('时长卡已到期', 'info');
                }
            }
        }
        
        function checkLoginStatus() {
            const savedUser = localStorage.getItem('sakuraAI_currentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    
                    loadUserData();
                    
                    loginContainer.style.display = 'none';
                    appContainer.style.display = 'flex';
                    
                    updateUserUI();
                    
                    if (apis.length === 0) {
                        showNotification('您还没有激活此软件', 'warning');
                    }
                    
                    if (conversations[currentMode].length === 0) {
                        createNewConversation();
                    } else {
                        switchConversation(conversations[currentMode][0].id);
                    }
                    
                    updatePresetStatusDisplay();
                } catch (error) {
                    console.error('加载用户数据失败:', error);
                    localStorage.removeItem('sakuraAI_currentUser');
                }
            }
        }
        
        function setupEventListeners() {
            loginTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    
                    loginTabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    loginForm.classList.remove('active');
                    registerForm.classList.remove('active');
                    
                    if (tabName === 'login') {
                        loginForm.classList.add('active');
                    } else {
                        registerForm.classList.add('active');
                    }
                });
            });
            
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                loginUser();
            });
            
            registerForm.addEventListener('submit', function(e) {
                e.preventDefault();
                registerUser();
            });
            
            menuToggle.addEventListener('click', toggleMenu);
            
            recentConversationsTitle.addEventListener('click', toggleRecentConversations);
            
            modeItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const mode = this.dataset.mode;
                    switchMode(mode);
                    
                    if (window.innerWidth <= 768) {
                        sidebar.classList.remove('active');
                    }
                });
            });
            
            logoutBtn.addEventListener('click', logoutUser);
            
            userAvatar.addEventListener('click', function() {
                avatarUploadInput.click();
            });
            
            avatarUploadInput.addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    const file = e.target.files[0];
                    
                    if (!file.type.startsWith('image/')) {
                        customAlert('请选择有效的图片文件！', '文件类型错误');
                        return;
                    }
                    
                    const img = new Image();
                    img.onload = function() {
                        const width = this.width;
                        const height = this.height;
                        
                        if (Math.abs(width - height) / Math.max(width, height) > 0.2) {
                            customConfirm('检测到图片不是正方形比例（1:1），上传后可能会被裁剪。建议使用正方形图片以获得最佳效果。\n\n是否继续上传？', '图片比例提示').then((confirmed) => {
                                if (!confirmed) return;
                            });
                        }
                        
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        canvas.width = 48;
                        canvas.height = 48;
                        
                        const scale = Math.max(48 / width, 48 / height);
                        const scaledWidth = width * scale;
                        const scaledHeight = height * scale;
                        const offsetX = (scaledWidth - 48) / 2;
                        const offsetY = (scaledHeight - 48) / 2;
                        
                        ctx.drawImage(img, -offsetX, -offsetY, scaledWidth, scaledHeight);
                        
                        const dataURL = canvas.toDataURL('image/jpeg', 0.8);
                        userAvatar.style.backgroundImage = `url(${dataURL})`;
                        userAvatar.style.backgroundSize = 'cover';
                        userAvatar.style.backgroundPosition = 'center';
                        userAvatar.textContent = '';
                        
                        
                        if (currentUser) {
                            currentUser.avatar = dataURL;
                            saveUserData();
                        } else {
                            const savedUser = JSON.parse(localStorage.getItem('sakuraAI_currentUser') || '{}');
                            savedUser.avatar = dataURL;
                            localStorage.setItem('sakuraAI_currentUser', JSON.stringify(savedUser));
                        }
                        
                        renderMessages();
                        showNotification('头像上传成功！', 'success');
                    };
                    
                    img.onerror = function() {
                        customAlert('图片加载失败，请选择有效的图片文件！', '图片加载错误');
                    };
                    
                    img.src = URL.createObjectURL(file);
                }
            });
            
            rechargeBtn.addEventListener('click', () => {
                rechargeModal.classList.add('active');
                updateCurrentTime();
            });
            
            closeRechargeModal.addEventListener('click', () => {
                rechargeModal.classList.remove('active');
                rechargeInfo.style.display = 'none';
                rechargeCode.value = '';
            });
            
            useRechargeCodeBtn.addEventListener('click', useRechargeCode);
            rechargeCode.addEventListener('input', function() {
                if (rechargeInfo.style.display !== 'none') {
                    rechargeInfo.style.display = 'none';
                }
            });
            
            presetManagementBtn.addEventListener('click', function(e) {
                e.preventDefault();
                openPresetModal();
                
                if (window.innerWidth <= 768) {
                    sidebar.classList.remove('active');
                }
            });
            
            document.querySelectorAll('.new-conversation-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const mode = this.dataset.mode;
                    if (currentMode !== mode) {
                        switchMode(mode);
                    }
                    createNewConversation();
                });
            });
            
            document.querySelectorAll('.section-title.mode-expandable').forEach(title => {
                title.addEventListener('click', function(e) {
                    if (e.target.closest('.new-conversation-btn')) return;
                    
                    const mode = this.dataset.mode;
                    const dropdown = document.querySelector(`.conversation-dropdown[data-mode="${mode}"]`);
                    
                    if (currentMode !== mode) {
                        switchMode(mode);
                    }
                    
                    if (dropdown) {
                        const isExpanded = dropdown.classList.contains('expanded');
                        document.querySelectorAll('.conversation-dropdown').forEach(d => d.classList.remove('expanded'));
                        document.querySelectorAll('.section-title.mode-expandable').forEach(t => t.classList.remove('active'));
                        
                        if (!isExpanded) {
                            dropdown.classList.add('expanded');
                            this.classList.add('active');
                        }
                    }
                });
            });
            
            sendButton.addEventListener('click', sendMessage);
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            messageInput.addEventListener('input', function() {
                updateCostEstimate();
            });
            
            const resizeHandle = document.getElementById('resizeHandle');
            let isResizing = false;
            let startY = 0;
            let startHeight = 0;
            
            resizeHandle.addEventListener('mousedown', function(e) {
                isResizing = true;
                startY = e.clientY;
                startHeight = messageInput.offsetHeight;
                resizeHandle.classList.add('active');
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', function(e) {
                if (!isResizing) return;
                
                const deltaY = startY - e.clientY;
                const newHeight = Math.max(60, Math.min(400, startHeight + deltaY));
                
                messageInput.style.height = newHeight + 'px';
            });
            
            document.addEventListener('mouseup', function() {
                if (isResizing) {
                    isResizing = false;
                    resizeHandle.classList.remove('active');
                    
                    localStorage.setItem('messageInputHeight', messageInput.style.height);
                }
            });
            
            window.addEventListener('load', function() {
                const savedHeight = localStorage.getItem('messageInputHeight');
                if (savedHeight) {
                    messageInput.style.height = savedHeight;
                }
            });
            
            closePresetModal.addEventListener('click', () => presetModal.classList.remove('active'));
            closeRenameModal.addEventListener('click', () => renameModal.classList.remove('active'));
            closeApiModal.addEventListener('click', () => apiModal.classList.remove('active'));
            closeBatteryDetailsModal.addEventListener('click', () => batteryDetailsModal.classList.remove('active'));
            
            [rechargeModal, presetModal, renameModal, apiModal, deleteApiModal, batteryDetailsModal].forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.remove('active');
                        if (this === deleteApiModal) {
                            clearDeleteTimer();
                        }
                        if (this === rechargeModal) {
                            rechargeInfo.style.display = 'none';
                            rechargeCode.value = '';
                        }
                    }
                });
            });
            
            presetInstruction.addEventListener('input', updatePresetTokensDisplay);
            
            savePresetBtn.addEventListener('click', savePreset);
            newPresetBtn.addEventListener('click', createNewPreset);
            deletePresetBtn.addEventListener('click', deleteCurrentPreset);
            exportSelectedPresetsBtn.addEventListener('click', exportSelectedPresets);
            importPresetsBtn.addEventListener('click', importPresets);
            
            saveRenameBtn.addEventListener('click', saveConversationRename);
            
            uploadDocumentBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileUpload);
            
            settingsBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                settingsPanel.classList.toggle('active');
            });
            
            closeSettingsBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                settingsPanel.classList.remove('active');
            });
            
            // 存储管理功能
            const refreshStorageBtn = document.getElementById('refreshStorageBtn');
            const cleanupStorageBtn = document.getElementById('cleanupStorageBtn');
            const storageDetails = document.getElementById('storageDetails');
            
            function updateStorageStats() {
                const storageInfo = analyzeStorageUsage();
                
                document.getElementById('storageUsage').textContent = storageInfo.totalSizeFormatted;
                document.getElementById('storageItemCount').textContent = storageInfo.itemCount;
                
                const statusElement = document.getElementById('storageStatus');
                if (storageInfo.quotaAvailable) {
                    statusElement.textContent = '正常';
                    statusElement.style.color = 'var(--success-color)';
                } else {
                    statusElement.textContent = '空间不足';
                    statusElement.style.color = 'var(--error-color)';
                }
                
                // 更新存储详情
                const storageItemsList = document.getElementById('storageItemsList');
                storageItemsList.innerHTML = '';
                
                Object.entries(storageInfo.items).forEach(([key, item]) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);';
                    
                    const keySpan = document.createElement('span');
                    keySpan.textContent = key;
                    keySpan.style.cssText = 'font-weight: 500; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;';
                    
                    const sizeSpan = document.createElement('span');
                    sizeSpan.textContent = item.sizeFormatted;
                    sizeSpan.style.cssText = 'color: var(--primary-color); font-weight: 500;';
                    
                    itemDiv.appendChild(keySpan);
                    itemDiv.appendChild(sizeSpan);
                    storageItemsList.appendChild(itemDiv);
                });
            }
            
            function toggleStorageDetails() {
                storageDetails.style.display = storageDetails.style.display === 'none' ? 'block' : 'none';
            }
            
            async function performCleanup() {
                const confirmed = await customConfirm('确定要清理存储空间吗？这将删除过大的背景图片、过期的会话数据和临时文件。', '存储清理确认');
                if (confirmed) {
                    const cleanupResult = cleanupStorage();
                    updateStorageStats();
                    
                    if (cleanupResult.cleanedItems.length > 0) {
                        showNotification(`存储清理完成，释放了 ${cleanupResult.freedSizeFormatted}，清理了 ${cleanupResult.cleanedItems.length} 个项目`, 'success');
                    } else {
                        showNotification('存储空间已优化，无需清理', 'info');
                    }
                }
            }
            
            refreshStorageBtn.addEventListener('click', function() {
                updateStorageStats();
                showNotification('存储统计已刷新', 'info');
            });
            
            cleanupStorageBtn.addEventListener('click', performCleanup);
            
            // 点击存储详情区域显示/隐藏详情
            document.getElementById('storageUsage').addEventListener('click', toggleStorageDetails);
            document.getElementById('storageItemCount').addEventListener('click', toggleStorageDetails);
            
            // 初始化存储统计
            setTimeout(updateStorageStats, 100);
            
            const changeAiAvatarBtn = document.getElementById('changeAiAvatarBtn');
        const resetAiAvatarBtn = document.getElementById('resetAiAvatarBtn');
        const aiAvatarUpload = document.getElementById('aiAvatarUpload');
        
        const changeBackgroundBtn = document.getElementById('changeBackgroundBtn');
        const resetBackgroundBtn = document.getElementById('resetBackgroundBtn');
        const backgroundUpload = document.getElementById('backgroundUpload');
        const backgroundPreview = document.getElementById('backgroundPreview');
        const backgroundBlurBtn = document.getElementById('backgroundBlurBtn');
        const backgroundDarkenBtn = document.getElementById('backgroundDarkenBtn');
            
            if (changeAiAvatarBtn) {
                changeAiAvatarBtn.addEventListener('click', function() {
                    aiAvatarUpload.click();
                });
            }
            
            if (resetAiAvatarBtn) {
                resetAiAvatarBtn.addEventListener('click', function() {
                    if (currentUser) {
                        currentUser.aiAvatar = null;
                        saveUserData();
                        updateAiAvatarUI();
                        renderMessages();
                        showNotification('AI头像已重置', 'success');
                    }
                });
            }
            
            if (aiAvatarUpload) {
                aiAvatarUpload.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    if (!file.type.startsWith('image/')) {
                        showNotification('请选择有效的图片文件', 'error');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const dataURL = event.target.result;
                        
                        if (currentUser) {
                            currentUser.aiAvatar = dataURL;
                            saveUserData();
                            updateAiAvatarUI();
                            renderMessages();
                            showNotification('AI头像设置成功', 'success');
                        }
                    };
                    
                    reader.readAsDataURL(file);
                });
            }
            
            if (changeBackgroundBtn) {
                changeBackgroundBtn.addEventListener('click', function() {
                    backgroundUpload.click();
                });
            }
            
            if (resetBackgroundBtn) {
                resetBackgroundBtn.addEventListener('click', function() {
                    if (currentUser) {
                        currentUser.chatBackground = null;
                        currentUser.backgroundBlur = false;
                        currentUser.backgroundDarken = false;
                        saveUserData();
                        updateChatBackgroundUI();
                        showNotification('聊天背景已重置', 'success');
                    }
                });
            }
            
            if (backgroundUpload) {
                backgroundUpload.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    if (!file.type.startsWith('image/')) {
                        showNotification('请选择有效的图片文件', 'error');
                        return;
                    }
                    
                    // 检查文件大小，超过2MB的图片需要压缩
                    const maxSize = 2 * 1024 * 1024; // 2MB
                    if (file.size > maxSize) {
                        compressImage(file, function(compressedDataURL) {
                            if (currentUser) {
                                currentUser.chatBackground = compressedDataURL;
                                saveUserData();
                                updateChatBackgroundUI();
                                
                                
                                analyzeBackgroundImage(compressedDataURL);
                                
                                showNotification('聊天背景设置成功（已自动压缩）', 'success');
                            }
                        });
                    } else {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            const dataURL = event.target.result;
                            
                            if (currentUser) {
                                currentUser.chatBackground = dataURL;
                                saveUserData();
                                updateChatBackgroundUI();
                                
                                
                                analyzeBackgroundImage(dataURL);
                                
                                showNotification('聊天背景设置成功', 'success');
                            }
                        };
                        
                        reader.readAsDataURL(file);
                    }
                });
            }
            
            if (backgroundBlurBtn) {
                backgroundBlurBtn.addEventListener('click', function() {
                    if (currentUser) {
                        currentUser.backgroundBlur = !currentUser.backgroundBlur;
                        saveUserData();
                        updateChatBackgroundUI();
                        showNotification(currentUser.backgroundBlur ? '模糊效果已开启' : '模糊效果已关闭', 'success');
                    }
                });
            }
            
            if (backgroundDarkenBtn) {
                backgroundDarkenBtn.addEventListener('click', function() {
                    if (currentUser) {
                        currentUser.backgroundDarken = !currentUser.backgroundDarken;
                        saveUserData();
                        updateChatBackgroundUI();
                        showNotification(currentUser.backgroundDarken ? '暗化效果已开启' : '暗化效果已关闭', 'success');
                    }
                });
            }
            
            temperatureSlider.addEventListener('input', function() {
                temperatureValue.textContent = this.value;
                temperature = parseFloat(this.value);
                
                if (currentConversationId) {
                    const conversation = getCurrentConversation();
                    if (conversation) {
                        conversation.temperature = temperature;
                        saveUserData();
                    }
                }
            });
            
            contextSlider.addEventListener('input', function() {
                contextValue.textContent = this.value;
                contextLength = parseInt(this.value);
                
                if (currentConversationId) {
                    const conversation = getCurrentConversation();
                    if (conversation) {
                        conversation.contextLength = contextLength;
                        saveUserData();
                        
                        updateCostEstimate();
                        updateContextCostInfo();
                    }
                }
            });
            
            exportConversationBtn.addEventListener('click', exportConversation);
            
            importConversationBtn.addEventListener('click', function() {
                importConversationFile.click();
            });
            
            importConversationFile.addEventListener('change', handleImportConversation);
            
            
             document.getElementById('closeNicknameSelectModal').addEventListener('click', function() {
                 document.getElementById('nicknameSelectModal').classList.remove('active');
             });
             
             document.getElementById('confirmNicknameSelect').addEventListener('click', confirmNicknameSelection);
             
             
             document.getElementById('nicknameSelectModal').addEventListener('click', function(e) {
                 if (e.target === this) {
                     this.classList.remove('active');
                 }
             });
            
            addApiBtn.addEventListener('click', addNewApi);
            
            cancelDeleteApiBtn.addEventListener('click', function() {
                deleteApiModal.classList.remove('active');
                clearDeleteTimer();
            });
            
            confirmDeleteApiBtn.addEventListener('click', deleteApi);
            
            document.addEventListener('click', function(e) {
                if (!settingsPanel.contains(e.target) && e.target !== settingsBtn) {
                    settingsPanel.classList.remove('active');
                }
            });
            

            const themeButtons = document.querySelectorAll('.theme-btn');
            themeButtons.forEach(btn => {
                btn.addEventListener('click', function() {

                    themeButtons.forEach(b => {
                        b.classList.remove('active');
                        b.style.borderColor = 'var(--border-color)';
                    });
                    

                    this.classList.add('active');
                    this.style.borderColor = 'var(--primary-color)';
                    

                    const theme = this.getAttribute('data-theme');
                    

                    document.body.classList.remove('theme-purple', 'theme-blue', 'theme-green', 'theme-pink', 'theme-orange', 'theme-red');
                    

                    document.body.classList.add(`theme-${theme}`);
                    

                    localStorage.setItem('selectedTheme', theme);
                });
            });
            

            const savedTheme = localStorage.getItem('selectedTheme') || 'purple';
            const savedThemeBtn = document.querySelector(`.theme-btn[data-theme="${savedTheme}"]`);
            if (savedThemeBtn) {
                savedThemeBtn.click();
            }
            
            
            const bubbleStyleButtons = document.querySelectorAll('.bubble-style-btn');
            const smartTextColorToggle = document.getElementById('smartTextColorToggle');
            
            
            function updateBubbleStyles() {
                const bubbleStyle = localStorage.getItem('bubbleStyle') || 'original';
                const smartTextColor = localStorage.getItem('smartTextColor') !== 'false';
                
                
                document.body.classList.remove('bubble-style-original', 'bubble-style-transparent', 'bubble-style-glass', 'bubble-style-semi-transparent');
                document.body.classList.add(`bubble-style-${bubbleStyle}`);
                
                
                bubbleStyleButtons.forEach(btn => {
                    btn.classList.remove('active');
                    btn.style.borderColor = 'var(--border-color)';
                });
                
                const activeBtn = document.querySelector(`.bubble-style-btn[data-style="${bubbleStyle}"]`);
                if (activeBtn) {
                    activeBtn.classList.add('active');
                    activeBtn.style.borderColor = 'var(--primary-color)';
                }
                
                
                smartTextColorToggle.checked = smartTextColor;
                
                
                applySmartTextColor();
            }
            
            
            function applySmartTextColor() {
                const smartTextColor = smartTextColorToggle.checked;
                const messageBubbles = document.querySelectorAll('.ai-message-bubble, .user-message-bubble');
                
                if (!smartTextColor) {
                    
                    messageBubbles.forEach(bubble => {
                        bubble.style.color = '';
                    });
                    return;
                }
                
                messageBubbles.forEach(bubble => {
                    const effectiveBgColor = getEffectiveBackgroundColor(bubble);
                    
                    
                    if (backgroundImageData) {
                        const rect = bubble.getBoundingClientRect();
                        const centerX = rect.left + rect.width / 2;
                        const centerY = rect.top + rect.height / 2;
                        
                        const imageBgColor = getBackgroundColorAtPosition(centerX, centerY);
                        if (imageBgColor) {
                            
                            const bubbleStyle = getComputedStyle(bubble);
                            const bubbleAlpha = getAlphaFromColor(bubbleStyle.backgroundColor);
                            
                            if (bubbleAlpha < 0.5) {
                                
                                const textColor = getOptimalTextColor(imageBgColor);
                                bubble.style.color = textColor;
                                return;
                            }
                        }
                    }
                    
                    
                    const textColor = getOptimalTextColor(effectiveBgColor);
                    bubble.style.color = textColor;
                });
            }
            
            
            function getEffectiveBackgroundColor(element) {
                const bubbleStyle = getComputedStyle(element);
                const bubbleBgColor = bubbleStyle.backgroundColor;
                
                
                const bubbleAlpha = getAlphaFromColor(bubbleBgColor);
                
                
                if (bubbleAlpha > 0.8) {
                    return bubbleBgColor;
                }
                
                
                const bodyBgColor = getComputedStyle(document.body).backgroundColor;
                
                
                if (bubbleAlpha < 0.2) {
                    
                    return getBackgroundColorBehindElement(element);
                }
                
                
                const blendedColor = blendColors(bubbleBgColor, bodyBgColor, bubbleAlpha);
                return blendedColor;
            }
            
            function getAlphaFromColor(color) {
                const rgba = color.match(/[\d.]+/g);
                if (!rgba || rgba.length < 4) return 1;
                return parseFloat(rgba[3]);
            }
            
            function blendColors(foreground, background, alpha) {
                const fg = parseColor(foreground);
                const bg = parseColor(background);
                
                const r = Math.round(fg.r * alpha + bg.r * (1 - alpha));
                const g = Math.round(fg.g * alpha + bg.g * (1 - alpha));
                const b = Math.round(fg.b * alpha + bg.b * (1 - alpha));
                
                return `rgb(${r}, ${g}, ${b})`;
            }
            
            function parseColor(color) {
                const rgba = color.match(/[\d.]+/g);
                if (!rgba) return { r: 255, g: 255, b: 255 };
                
                return {
                    r: parseInt(rgba[0]),
                    g: parseInt(rgba[1]),
                    b: parseInt(rgba[2])
                };
            }
            
            function getBackgroundColorBehindElement(element) {
                
                const rect = element.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                
                
                const elementAtPoint = document.elementFromPoint(centerX, centerY);
                
                if (!elementAtPoint || elementAtPoint === element) {
                    return getComputedStyle(document.body).backgroundColor;
                }
                
                
                let currentElement = elementAtPoint;
                while (currentElement && currentElement !== document.body) {
                    const style = getComputedStyle(currentElement);
                    const bgColor = style.backgroundColor;
                    const bgImage = style.backgroundImage;
                    
                    
                    if (bgImage && bgImage !== 'none') {
                        const imageColor = getBackgroundImageColor(currentElement, centerX, centerY);
                        if (imageColor) {
                            return imageColor;
                        }
                    }
                    
                    const alpha = getAlphaFromColor(bgColor);
                    if (alpha > 0.1 && bgColor !== 'rgba(0, 0, 0, 0)' && bgColor !== 'transparent') {
                        return bgColor;
                    }
                    currentElement = currentElement.parentElement;
                }
                
                
                const bodyStyle = getComputedStyle(document.body);
                const bodyBgImage = bodyStyle.backgroundImage;
                if (bodyBgImage && bodyBgImage !== 'none') {
                    const imageColor = getBackgroundImageColor(document.body, centerX, centerY);
                    if (imageColor) {
                        return imageColor;
                    }
                }
                
                return bodyStyle.backgroundColor;
            }
            
            function getBackgroundImageColor(element, x, y) {
                
                const style = getComputedStyle(element);
                const bgImage = style.backgroundImage;
                
                if (!bgImage || bgImage === 'none') return null;
                
                
                const rect = element.getBoundingClientRect();
                const relativeX = x - rect.left;
                const relativeY = y - rect.top;
                
                
                const isLightBg = isElementBackgroundLight(element, relativeX, relativeY);
                return isLightBg ? '#ffffff' : '#000000';
            }
            
            function isElementBackgroundLight(element, x, y) {
                
                const style = getComputedStyle(element);
                
                
                const bgColor = style.backgroundColor;
                if (bgColor && bgColor !== 'rgba(0, 0, 0, 0)' && bgColor !== 'transparent') {
                    const alpha = getAlphaFromColor(bgColor);
                    if (alpha > 0.5) {
                        return isLightColor(bgColor);
                    }
                }
                
                
                const bgImage = style.backgroundImage;
                if (bgImage && bgImage !== 'none') {
                    
                    const urlMatch = bgImage.match(/url\(["']?([^"']+)["']?\)/);
                    if (urlMatch) {
                        const imageUrl = urlMatch[1];
                        
                        
                        if (imageUrl.includes('light') || imageUrl.includes('white') || imageUrl.includes('bright')) {
                            return true;
                        }
                        if (imageUrl.includes('dark') || imageUrl.includes('black') || imageUrl.includes('night')) {
                            return false;
                        }
                    }
                }
                
                
                const computedColor = getComputedStyle(element).color;
                if (computedColor) {
                    const brightness = getColorBrightness(computedColor);
                    return brightness > 128;
                }
                
                
                return true;
            }
            
            function getColorBrightness(color) {
                const rgb = color.match(/\d+/g);
                if (!rgb || rgb.length < 3) return 255;
                
                const r = parseInt(rgb[0]);
                const g = parseInt(rgb[1]);
                const b = parseInt(rgb[2]);
                
                return (r * 299 + g * 587 + b * 114) / 1000;
            }
            
            
            let backgroundImageData = null;
            let backgroundImageWidth = 0;
            let backgroundImageHeight = 0;
            
            
            function analyzeBackgroundImage(imageUrl) {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    
                    
                    backgroundImageData = ctx.getImageData(0, 0, img.width, img.height);
                    backgroundImageWidth = img.width;
                    backgroundImageHeight = img.height;
                    
                    console.log('背景图像分析完成，尺寸:', img.width, 'x', img.height);
                    
                    
                    setupScrollListener();
                };
                
                img.onerror = function() {
                    console.warn('无法加载背景图像进行分析');
                    backgroundImageData = null;
                };
                
                img.src = imageUrl;
            }
            
            
            function getBackgroundColorAtPosition(x, y) {
                if (!backgroundImageData) return null;
                
                const rect = document.body.getBoundingClientRect();
                const scrollX = window.pageXOffset || document.documentElement.scrollLeft;
                const scrollY = window.pageYOffset || document.documentElement.scrollTop;
                
                
                const imageX = Math.floor((x + scrollX) / rect.width * backgroundImageWidth);
                const imageY = Math.floor((y + scrollY) / rect.height * backgroundImageHeight);
                
                
                const pixelIndex = (imageY * backgroundImageWidth + imageX) * 4;
                
                if (pixelIndex >= 0 && pixelIndex < backgroundImageData.data.length) {
                    const r = backgroundImageData.data[pixelIndex];
                    const g = backgroundImageData.data[pixelIndex + 1];
                    const b = backgroundImageData.data[pixelIndex + 2];
                    
                    return `rgb(${r}, ${g}, ${b})`;
                }
                
                return null;
            }
            
            
            function setupScrollListener() {
                
                if (window.backgroundScrollHandler) {
                    window.removeEventListener('scroll', window.backgroundScrollHandler);
                    if (messagesContainer) {
                        messagesContainer.removeEventListener('scroll', window.backgroundScrollHandler);
                    }
                }
                
                window.backgroundScrollHandler = function() {
                    if (!backgroundImageData) return;
                    
                    
                    setTimeout(() => {
                        applySmartTextColor();
                    }, 50);
                };
                
                
                window.addEventListener('scroll', window.backgroundScrollHandler, { passive: true });
                
                
                if (messagesContainer) {
                    messagesContainer.addEventListener('scroll', window.backgroundScrollHandler, { passive: true });
                }
                
                
                window.backgroundResizeHandler = function() {
                    setTimeout(() => {
                        applySmartTextColor();
                    }, 100);
                };
                
                window.addEventListener('resize', window.backgroundResizeHandler, { passive: true });
            }
            
            
            function getOptimalTextColor(backgroundColor) {
                if (!backgroundColor) return '#ffffff';
                
                const brightness = getColorBrightness(backgroundColor);
                
                
                const contrastRatio = getContrastRatio(backgroundColor);
                
                
                if (brightness > 180 && contrastRatio > 4.5) {
                    return '#000000';
                } else if (brightness > 150 && contrastRatio > 3) {
                    return '#222222';
                } else if (brightness > 120) {
                    return '#444444';
                } else if (brightness > 80) {
                    return '#666666';
                } else if (brightness > 50) {
                    return '#aaaaaa';
                } else if (brightness > 30) {
                    return '#dddddd';
                } else {
                    return '#ffffff';
                }
            }
            
            
            function getContrastRatio(backgroundColor) {
                const bgBrightness = getColorBrightness(backgroundColor);
                
                
                const whiteContrast = (255 + 0.05) / (bgBrightness + 0.05);
                const blackContrast = (bgBrightness + 0.05) / (0 + 0.05);
                
                return Math.max(whiteContrast, blackContrast);
            }
            
            function isLightColor(color) {
                const rgb = color.match(/\d+/g);
                if (!rgb || rgb.length < 3) return false;
                
                const r = parseInt(rgb[0]);
                const g = parseInt(rgb[1]);
                const b = parseInt(rgb[2]);
                
                
                const brightness = (r * 299 + g * 587 + b * 114) / 1000;
                return brightness > 128;
            }
            
            
            bubbleStyleButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const style = this.getAttribute('data-style');
                    
                    
                    bubbleStyleButtons.forEach(b => {
                        b.classList.remove('active');
                        b.style.borderColor = 'var(--border-color)';
                    });
                    
                    this.classList.add('active');
                    this.style.borderColor = 'var(--primary-color)';
                    
                    
                    document.body.classList.remove('bubble-style-original', 'bubble-style-transparent', 'bubble-style-glass', 'bubble-style-semi-transparent');
                    document.body.classList.add(`bubble-style-${style}`);
                    
                    
                    localStorage.setItem('bubbleStyle', style);
                    
                    
                    applySmartTextColor();
                });
            });
            
            
            smartTextColorToggle.addEventListener('change', function() {
                localStorage.setItem('smartTextColor', this.checked);
                applySmartTextColor();
            });
            
            
            updateBubbleStyles();
            
            
            if (currentUser && currentUser.chatBackground) {
                analyzeBackgroundImage(currentUser.chatBackground);
            }
            
            
            const fullscreenStatus = document.getElementById('fullscreenStatus');
            const reEnterFullscreenBtn = document.getElementById('reEnterFullscreenBtn');
            

            function updateFullscreenStatus() {
                const isFullscreen = document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement;
                fullscreenStatus.textContent = isFullscreen ? '已开启全屏模式' : '已退出全屏模式';
                

                localStorage.setItem('fullscreenEnabled', isFullscreen);
            }
            

            function exitFullscreen() {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
            }
            

            function toggleFullscreen() {
                if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.mozFullScreenElement && !document.msFullscreenElement) {
                    window.enterFullscreen();
                } else {
                    exitFullscreen();
                }
            }
            

            document.addEventListener('fullscreenchange', updateFullscreenStatus);
            document.addEventListener('webkitfullscreenchange', updateFullscreenStatus);
            document.addEventListener('mozfullscreenchange', updateFullscreenStatus);
            document.addEventListener('MSFullscreenChange', updateFullscreenStatus);
            

            reEnterFullscreenBtn.addEventListener('click', function() {
                enterFullscreen();
            });
            

            const autoFullscreenToggle = document.getElementById('autoFullscreenToggle');
            

            const autoFullscreenEnabled = localStorage.getItem('autoFullscreenEnabled');
            if (autoFullscreenEnabled !== null) {
                autoFullscreenToggle.checked = autoFullscreenEnabled === 'true';
            }
            

            autoFullscreenToggle.addEventListener('change', function() {
                localStorage.setItem('autoFullscreenEnabled', this.checked);
            });
            

            updateFullscreenStatus();
            
            window.addEventListener('resize', function() {
                if (window.innerWidth > 768) {
                    sidebar.classList.add('active');
                    const conversationSidebar = document.getElementById('conversationSidebar');
                    if (conversationSidebar) {
                        conversationSidebar.classList.add('active');
                    }
                }
            });
            
            presetSelect.addEventListener('change', function() {
                handlePresetSelectChange();
            });
            
            aiNickname.addEventListener('input', function() {
                handleNicknameChange();
            });
            
            userNickname.addEventListener('input', function() {
                handleNicknameChange();
            });
            
            batteryDetailsBtn.addEventListener('click', function() {
                batteryDetailsModal.classList.add('active');
                loadBatteryDetails();
            });
            
            aiFirstButton.addEventListener('click', aiFirst);
            continueButton.addEventListener('click', continueConversation);
        }
        
        function handleKeyboardShortcuts(e) {
            if (e.shiftKey && e.altKey && e.key === 'S') {
                e.preventDefault();
                if (apiModal.classList.contains('active')) {
                    apiModal.classList.remove('active');
                } else {
                    apiModal.classList.add('active');
                    renderApiList();
                }
            }
        }
        
        function toggleMenu() {
            sidebar.classList.toggle('active');
        }
        
        function toggleRecentConversations() {
            const isCollapsed = recentConversations.classList.contains('collapsed');
            const icon = recentConversationsTitle.querySelector('i');
            
            if (isCollapsed) {
                recentConversations.classList.remove('collapsed');
                recentConversationsTitle.classList.remove('collapsed');
                icon.style.transform = 'rotate(0deg)';
            } else {
                recentConversations.classList.add('collapsed');
                recentConversationsTitle.classList.add('collapsed');
                icon.style.transform = 'rotate(-90deg)';
            }
        }
        
        function loginUser() {
            const email = loginEmail.value.trim();
            const username = loginUsername.value.trim();
            const password = loginPassword.value.trim();
            
            if (!email || !username || !password) {
                showNotification('请输入完整的登录信息', 'error');
                return;
            }
            
            const users = JSON.parse(localStorage.getItem('sakuraAI_users') || '[]');
            
            const user = users.find(u => 
                u.email === email && 
                u.username === username && 
                u.password === password
            );
            
            if (!user) {
                showNotification('邮箱、账号或密码错误', 'error');
                return;
            }
            
            currentUser = {
                email: user.email,
                username: user.username,
                battery: user.battery || 0.000,
                totalCost: user.totalCost || 0,
                todayCost: user.todayCost || 0,
                apis: user.apis || [],
                customPresets: user.customPresets || [],
                conversations: user.conversations || {
                    chat: [],
                    document: []
                },
                batteryHash: user.batteryHash || '',
                timeCard: user.timeCard || null,
                avatar: user.avatar || null
            };
            
            if (currentUser.batteryHash) {
                const calculatedHash = simpleHash(currentUser.battery.toString() + ENCRYPTION_KEY);
                if (calculatedHash !== currentUser.batteryHash) {
                    showNotification('电池数据异常，已重置为0', 'warning');
                    currentUser.battery = 0.000;
                    currentUser.batteryHash = simpleHash('0.000' + ENCRYPTION_KEY);
                }
            }
            
            localStorage.setItem('sakuraAI_currentUser', JSON.stringify(currentUser));
            
            battery = currentUser.battery;
            totalCost = currentUser.totalCost || 0;
            todayCost = currentUser.todayCost || 0;
            apis = currentUser.apis;
            customPresets = currentUser.customPresets;
            conversations = currentUser.conversations;
            
            if (apis.length > 0) {
                currentApiId = apis[0].id;
            }
            
            loginContainer.style.display = 'none';
            appContainer.style.display = 'flex';
            
            updateUserUI();
            
            renderConversationList();
            updateRecentConversations();
            
            if (conversations[currentMode].length > 0) {
                switchConversation(conversations[currentMode][0].id);
            } else {
                createNewConversation();
            }
            
            showNotification('登录成功', 'success');
        }
        
        function registerUser() {
            const email = registerEmail.value.trim();
            const username = registerUsername.value.trim();
            const password = registerPassword.value.trim();
            const confirm = confirmPassword.value.trim();
            
            if (!email || !username || !password || !confirm) {
                showNotification('请输入完整的注册信息', 'error');
                return;
            }
            
            if (password !== confirm) {
                showNotification('两次输入的密码不一致', 'error');
                return;
            }
            
            if (password.length < 6) {
                showNotification('密码长度至少为6位', 'error');
                return;
            }
            
            const users = JSON.parse(localStorage.getItem('sakuraAI_users') || '[]');
            
            if (users.some(u => u.email === email)) {
                showNotification('该邮箱已被注册', 'error');
                return;
            }
            
            if (users.some(u => u.username === username)) {
                showNotification('该用户名已被使用', 'error');
                return;
            }
            
            const newUser = {
                email: email,
                username: username,
                password: password,
                battery: 0.000,
                totalCost: 0,
                todayCost: 0,
                batteryHash: simpleHash('0.000' + ENCRYPTION_KEY),
                apis: [],
                customPresets: [],
                conversations: {
                    chat: [],
                    document: []
                },
                timeCard: null,
                avatar: null,
                aiAvatar: null,
                chatBackground: null,
                backgroundBlur: false,
                backgroundDarken: false,
                createdAt: new Date().toISOString()
            };
            
            users.push(newUser);
            localStorage.setItem('sakuraAI_users', JSON.stringify(users));
            
            currentUser = { ...newUser };
            delete currentUser.password;
            
            localStorage.setItem('sakuraAI_currentUser', JSON.stringify(currentUser));
            
            battery = currentUser.battery;
            totalCost = currentUser.totalCost;
            todayCost = currentUser.todayCost;
            apis = currentUser.apis;
            customPresets = currentUser.customPresets;
            conversations = currentUser.conversations;
            
            loginContainer.style.display = 'none';
            appContainer.style.display = 'flex';
            
            updateUserUI();
            
            createNewConversation();
            
            showNotification('注册成功', 'success');
        }
        
        async function logoutUser() {
            const confirmed = await customConfirm('确定要退出登录吗？', '退出登录确认');
            if (confirmed) {
                localStorage.removeItem('sakuraAI_currentUser');
                currentUser = null;
                
                appContainer.style.display = 'none';
                loginContainer.style.display = 'flex';
                
                loginEmail.value = '';
                loginUsername.value = '';
                loginPassword.value = '';
                
                showNotification('已退出登录', 'success');
            }
        }
        
        function updateUserUI() {
            if (!currentUser) return;
            
            userName.textContent = currentUser.username;
            userEmail.textContent = currentUser.email;
            
            if (currentUser.avatar) {
                userAvatar.style.backgroundImage = `url(${currentUser.avatar})`;
                userAvatar.style.backgroundSize = 'cover';
                userAvatar.style.backgroundPosition = 'center';
                userAvatar.textContent = '';
            } else {
                userAvatar.style.backgroundImage = '';
                userAvatar.textContent = currentUser.username.charAt(0).toUpperCase();
            }
            
            updateAiAvatarUI();
            updateBatteryUI();
            updateChatBackgroundUI();
        }
        
        function updateAiAvatarUI() {
            const aiAvatarPreview = document.getElementById('aiAvatarPreview');
            if (!aiAvatarPreview) return;
            
            if (currentUser.aiAvatar) {
                aiAvatarPreview.style.backgroundImage = `url(${currentUser.aiAvatar})`;
                aiAvatarPreview.style.backgroundSize = 'cover';
                aiAvatarPreview.style.backgroundPosition = 'center';
                aiAvatarPreview.textContent = '';
            } else {
                aiAvatarPreview.style.backgroundImage = '';
                aiAvatarPreview.textContent = 'AI';
                aiAvatarPreview.style.backgroundColor = 'var(--primary-color)';
                aiAvatarPreview.style.color = 'white';
            }
        }
        
        function updateChatBackgroundUI() {
            const chatContainer = document.querySelector('.chat-container');
            const chatBackgroundOverlay = document.getElementById('chatBackgroundOverlay');
            const backgroundPreview = document.getElementById('backgroundPreview');
            const backgroundBlurBtn = document.getElementById('backgroundBlurBtn');
            const backgroundDarkenBtn = document.getElementById('backgroundDarkenBtn');
            
            if (!chatContainer || !chatBackgroundOverlay || !currentUser) return;
            
            if (currentUser.chatBackground) {
                chatBackgroundOverlay.style.backgroundImage = `url(${currentUser.chatBackground})`;
                
                if (backgroundPreview) {
                    backgroundPreview.style.backgroundImage = `url(${currentUser.chatBackground})`;
                    backgroundPreview.style.backgroundColor = 'transparent';
                }
            } else {
                chatBackgroundOverlay.style.backgroundImage = '';
                
                if (backgroundPreview) {
                    backgroundPreview.style.backgroundImage = '';
                    backgroundPreview.style.backgroundColor = 'var(--background-card)';
                }
            }
            
            chatContainer.classList.toggle('background-blur', currentUser.backgroundBlur);
            chatContainer.classList.toggle('background-darken', currentUser.backgroundDarken);
            
            if (backgroundBlurBtn) {
                backgroundBlurBtn.textContent = currentUser.backgroundBlur ? '取消模糊' : '模糊效果';
                backgroundBlurBtn.classList.toggle('active', currentUser.backgroundBlur);
            }
            
            if (backgroundDarkenBtn) {
                backgroundDarkenBtn.textContent = currentUser.backgroundDarken ? '取消暗化' : '暗化效果';
                backgroundDarkenBtn.classList.toggle('active', currentUser.backgroundDarken);
            }
        }
        
        function getAiAvatar() {
            if (!currentUser) return null;
            return currentUser.aiAvatar || null;
        }
        
        function getUserAvatar() {
            if (!currentUser) return null;
            return currentUser.avatar || null;
        }
        
        function updateBatteryUI() {
            const timeCardInfo = document.getElementById('timeCardInfo');
            const expireTime = document.getElementById('expireTime');
            const remainingTime = document.getElementById('remainingTime');
            
            
            if (currentUser && currentUser.timeCard && currentUser.timeCard.active) {
                
                batteryAmount.textContent = '∞';
                batteryAmount.classList.remove('battery-low');
                
                
                timeCardInfo.style.display = 'block';
                
                
                const now = new Date();
                const endTime = new Date(currentUser.timeCard.endTime);
                
                
                expireTime.textContent = endTime.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                
                const remainingMs = endTime.getTime() - now.getTime();
                remainingTime.textContent = formatRemainingTime(remainingMs);
                
                
                sendButton.disabled = false;
                aiFirstButton.disabled = false;
                continueButton.disabled = false;
                messageInput.placeholder = '输入消息...';
            } else {
                
                batteryAmount.textContent = battery.toFixed(3);
                
                if (battery < 1) {
                    batteryAmount.classList.add('battery-low');
                } else {
                    batteryAmount.classList.remove('battery-low');
                }
                
                
                timeCardInfo.style.display = 'none';
                
                
                const isTimeCardActive = currentUser && currentUser.timeCard && currentUser.timeCard.active;
                sendButton.disabled = battery <= 0 && !isTimeCardActive;
                aiFirstButton.disabled = battery <= 0 && !isTimeCardActive;
                continueButton.disabled = battery <= 0 && !isTimeCardActive;
                messageInput.placeholder = (battery <= 0 && !isTimeCardActive) ? '电池不足，请充值后使用' : '输入消息...';
            }
        }
        
        function consumeBattery(cost, conversationId = null, conversationTitle = null) {
            
            if (currentUser && currentUser.timeCard && currentUser.timeCard.active) {
                
                
                return battery;
            }
            
            
            battery -= cost;
            
            if (battery < 0) battery = 0;
            
            totalCost += cost;
            todayCost += cost;
            
            if (conversationId && conversationTitle) {
                const consumptionRecord = {
                    id: Date.now(),
                    conversationId: conversationId,
                    conversationTitle: conversationTitle,
                    amount: cost,
                    timestamp: new Date().toISOString()
                };
                
                if (currentUser && currentUser.consumptionRecords) {
                    currentUser.consumptionRecords.push(consumptionRecord);
                } else if (currentUser) {
                    currentUser.consumptionRecords = [consumptionRecord];
                }
            }
            
            if (currentUser) {
                currentUser.battery = battery;
                currentUser.totalCost = totalCost;
                currentUser.todayCost = todayCost;
                currentUser.batteryHash = simpleHash(battery.toString() + ENCRYPTION_KEY);
                saveUserData();
            }
            
            updateBatteryUI();
            
            return battery;
        }
        
        function rechargeBatteryFunc(amount) {
            battery += amount;
            
            const rechargeRecord = {
                id: Date.now(),
                amount: amount,
                timestamp: new Date().toISOString()
            };
            
            if (currentUser) {
                currentUser.battery = battery;
                currentUser.batteryHash = simpleHash(battery.toString() + ENCRYPTION_KEY);
                
                
                if (currentUser.timeCard && currentUser.timeCard.active) {
                    currentUser.timeCard.originalBattery = battery;
                }
                
                if (currentUser.rechargeRecords) {
                    currentUser.rechargeRecords.push(rechargeRecord);
                } else {
                    currentUser.rechargeRecords = [rechargeRecord];
                }
                saveUserData();
            }
            
            updateBatteryUI();
            
            return battery;
        }
        
        function activateTimeCard(type, duration) {
            const now = new Date();
            let endTime;
            let originalBattery = battery;
            
            
            if (currentUser.timeCard && currentUser.timeCard.active) {
                
                const currentEndTime = new Date(currentUser.timeCard.endTime);
                endTime = new Date(currentEndTime.getTime() + duration * 24 * 60 * 60 * 1000);
                
                originalBattery = currentUser.timeCard.originalBattery;
            } else {
                
                endTime = new Date(now.getTime() + duration * 24 * 60 * 60 * 1000);
            }
            
            
            currentUser.timeCard = {
                active: true,
                type: type,
                startTime: now.toISOString(),
                endTime: endTime.toISOString(),
                originalBattery: originalBattery
            };
            
            
            const rechargeRecord = {
                id: Date.now(),
                type: 'timeCard',
                timeCardType: type,
                duration: duration,
                startTime: now.toISOString(),
                endTime: endTime.toISOString(),
                timestamp: now.toISOString()
            };
            
            if (currentUser.rechargeRecords) {
                currentUser.rechargeRecords.push(rechargeRecord);
            } else {
                currentUser.rechargeRecords = [rechargeRecord];
            }
            
            saveUserData();
            updateBatteryUI();
        }
        
        async function useRechargeCode() {
            const code = rechargeCode.value.trim();
            
            if (!code) {
                showNotification('请输入充值码', 'error');
                return;
            }
            
            try {
                const decoded = atob(code);
                const data = JSON.parse(decoded);
                
                if (!data.email || !data.username || data.battery === undefined || !data.securityCode || !data.timestamp) {
                    showNotification('充值码格式错误', 'error');
                    return;
                }
                
                if (data.email !== currentUser.email || data.username !== currentUser.username) {
                    showNotification('此充值码不属于当前用户', 'error');
                    return;
                }
                
                const securityCodeRegex = /^[0-9A-Za-z]{6}$/;
                if (!securityCodeRegex.test(data.securityCode)) {
                    showNotification('充值码防伪码格式错误', 'error');
                    return;
                }
                
                const usedCodes = JSON.parse(localStorage.getItem('sakuraAI_usedRechargeCodes') || '[]');
                if (usedCodes.includes(code)) {
                    showNotification('此充值码已被使用', 'error');
                    return;
                }
                
                const now = new Date().getTime();
                const codeTime = new Date(data.timestamp).getTime();
                const tenMinutes = 10 * 60 * 1000;
                
                if (now - codeTime > tenMinutes) {
                    showNotification('充值码已过期', 'error');
                    return;
                }
                
                if (data.apiKey) {
                    if (apis.length === 0) {
                        const apiId = Date.now();
                        apis.push({
                            id: apiId,
                            name: '充值码API',
                            key: data.apiKey,
                            endpoint: 'https://api.deepseek.com/v1',
                            model: 'deepseek-chat',
                            isActive: true
                        });
                        currentApiId = apiId;
                        currentUser.apis = apis;
                        
                        showNotification('密钥已自动添加', 'success');
                    } else {
                        const existingApi = apis.find(api => api.key === data.apiKey);
                        if (!existingApi) {
                            showNotification('充值码中的密钥与用户不匹配', 'error');
                            return;
                        }
                    }
                }
                
                
                const isTimeCard = data.timeCardType && data.timeCardDuration;
                
                rechargeEmail.textContent = data.email;
                rechargeUsername.textContent = data.username;
                
                if (isTimeCard) {
                    rechargeBattery.textContent = `时长卡 (无限电量)`;
                } else {
                    rechargeBattery.textContent = data.battery.toFixed(3);
                }
                
                rechargeTime.textContent = formatDateTime(new Date(data.timestamp));
                rechargeSecurityCode.textContent = data.securityCode;
                rechargeInfo.style.display = 'block';
                
                const isTimeCardActive = currentUser.timeCard && currentUser.timeCard.active;
                const confirmMessage = isTimeCard 
                    ? isTimeCardActive 
                        ? `确定要延长 时长卡 吗？延长: ${data.timeCardDuration}天`
                        : `确定要激活 时长卡 吗？有效期: ${data.timeCardDuration}天`
                    : `确定要充值 ${data.battery.toFixed(3)} 电池吗？`;
                
                const confirmed = await customConfirm(confirmMessage, '充值确认');
                if (confirmed) {
                    usedCodes.push(code);
                    localStorage.setItem('sakuraAI_usedRechargeCodes', JSON.stringify(usedCodes));
                    
                    if (isTimeCard) {
                        
                        activateTimeCard(data.timeCardType, data.timeCardDuration);
                        showNotification(isTimeCardActive 
                            ? `成功延长 时长卡！延长: ${data.timeCardDuration}天`
                            : `成功激活 时长卡！有效期: ${data.timeCardDuration}天`, 'success');
                    } else {
                        
                        rechargeBatteryFunc(data.battery);
                        showNotification(`成功充值 ${data.battery.toFixed(3)} 电池`, 'success');
                    }
                    
                    saveUserData();
                    
                    rechargeModal.classList.remove('active');
                    rechargeInfo.style.display = 'none';
                    rechargeCode.value = '';
                }
                
            } catch (error) {
                console.error('解析充值码失败:', error);
                showNotification('充值码无效', 'error');
            }
        }
        
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString(16);
        }
        
        function loadUserData() {
            if (!currentUser) return;
            
            battery = currentUser.battery || 0.000;
            totalCost = currentUser.totalCost || 0;
            todayCost = currentUser.todayCost || 0;
            apis = currentUser.apis;
            customPresets = currentUser.customPresets;
            conversations = currentUser.conversations;
            
            
            if (!currentUser.timeCard) {
                currentUser.timeCard = {
                    active: false,
                    type: null,
                    startTime: null,
                    endTime: null,
                    originalBattery: battery
                };
            }
            
            
            if (currentUser.timeCard.active && currentUser.timeCard.endTime) {
                const now = new Date().getTime();
                const endTime = new Date(currentUser.timeCard.endTime).getTime();
                if (now > endTime) {
                    
                    battery = currentUser.timeCard.originalBattery || 0.000;
                    currentUser.timeCard.active = false;
                    currentUser.timeCard.type = null;
                    currentUser.timeCard.startTime = null;
                    currentUser.timeCard.endTime = null;
                    currentUser.timeCard.originalBattery = battery;
                    saveUserData();
                }
            }
            
            if (apis.length > 0) {
                currentApiId = apis[0].id;
            }
            
            if (!currentUser.rechargeRecords) {
                currentUser.rechargeRecords = [];
            }
            if (!currentUser.consumptionRecords) {
                currentUser.consumptionRecords = [];
            }
        }
        
        function saveUserData() {
            if (!currentUser) return;
            
            currentUser.battery = battery;
            currentUser.totalCost = totalCost;
            currentUser.todayCost = todayCost;
            currentUser.batteryHash = simpleHash(battery.toString() + ENCRYPTION_KEY);
            currentUser.apis = apis;
            currentUser.customPresets = customPresets;
            currentUser.conversations = conversations;
            
            localStorage.setItem('sakuraAI_currentUser', JSON.stringify(currentUser));
            
            const users = JSON.parse(localStorage.getItem('sakuraAI_users') || '[]');
            const userIndex = users.findIndex(u => u.email === currentUser.email && u.username === currentUser.username);
            
            if (userIndex !== -1) {
                const updatedUser = {
                    ...users[userIndex],
                    battery: currentUser.battery,
                    totalCost: currentUser.totalCost,
                    todayCost: currentUser.todayCost,
                    batteryHash: currentUser.batteryHash,
                    apis: currentUser.apis,
                    customPresets: currentUser.customPresets,
                    conversations: currentUser.conversations,
                    timeCard: currentUser.timeCard || null,
                    avatar: currentUser.avatar || null
                };
                
                users[userIndex] = updatedUser;
                localStorage.setItem('sakuraAI_users', JSON.stringify(users));
            }
        }
        
        function switchMode(mode) {
            currentMode = mode;
            
            const modeNames = {
                chat: '文字对话',
                document: '文档分析'
            };
            conversationMode.textContent = modeNames[mode];
            
            updateConversationDropdowns();
            
            modeItems.forEach(item => {
                if (item.dataset.mode === mode) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            if (mode === 'document') {
                documentUpload.style.display = 'block';
            } else {
                documentUpload.style.display = 'none';
            }
            
            renderConversationList();
            
            if (conversations[mode].length === 0) {
                createNewConversation();
            } else {
                switchConversation(conversations[mode][0].id);
            }
        }
        
        function createNewConversation() {
            const conversationId = Date.now();
            const conversation = {
                id: conversationId,
                mode: currentMode,
                title: `新对话 ${conversations[currentMode].length + 1}`,
                messages: [],
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                temperature: temperature,
                contextLength: contextLength,
                isNew: true,
                totalCost: 0,
                presetIndex: -1,
                presetContent: '',
                aiNickname: '',
                userNickname: '',
                failedMessages: []
            };
            
            conversations[currentMode].unshift(conversation);
            currentConversationId = conversationId;
            
            saveUserData();
            
            renderConversationList();
            renderMessages();
            updateRecentConversations();
            
            messageInput.value = '';
            messageInput.focus();
            
            currentConversationCost = 0;
            updateCostEstimate();
            updatePresetStatusDisplay();
            updateActionButtons();
        }
        
        function switchConversation(conversationId) {
            currentConversationId = conversationId;
            
            renderConversationList();
            
            renderMessages();
            
            const conversation = getCurrentConversation();
            if (conversation) {
                conversationTitle.textContent = conversation.title || '新对话';
                
                temperatureSlider.value = conversation.temperature || temperature;
                temperatureValue.textContent = conversation.temperature || temperature;
                temperature = conversation.temperature || temperature;
                
                contextSlider.value = conversation.contextLength || contextLength;
                contextValue.textContent = conversation.contextLength || contextLength;
                contextLength = conversation.contextLength || contextLength;
                
                currentConversationCost = conversation.totalCost || 0;
                updateCostEstimate();
                updatePresetStatusDisplay();
                updateActionButtons();
                
                if (currentMode === 'document' && conversation.document) {
                    documentInfo.innerHTML = `
                        <div style="background: rgba(124, 58, 237, 0.1); padding: 10px; border-radius: 6px;">
                            <i class="fas fa-file"></i> 
                            已上传: ${conversation.document.name} (${formatFileSize(conversation.document.size)})
                        </div>
                    `;
                }
            }
        }
        
        function getCurrentConversation() {
            if (!currentConversationId) return null;
            
            for (const mode in conversations) {
                const conversation = conversations[mode].find(c => c.id === currentConversationId);
                if (conversation) return conversation;
            }
            
            return null;
        }
        
        function updateConversationDropdowns() {
            const modeNames = {
                chat: '文字对话',
                document: '文档分析'
            };
            
            Object.keys(modeNames).forEach(mode => {
                const list = document.getElementById(`conversationList${mode.charAt(0).toUpperCase() + mode.slice(1)}`);
                const sectionTitle = document.querySelector(`.section-title.mode-expandable[data-mode="${mode}"]`);
                
                if (!list) return;
                
                list.innerHTML = '';
                
                if (conversations[mode].length === 0) {
                    list.innerHTML = `
                        <div class="empty-state" style="padding: 10px; font-size: 0.8rem; color: var(--text-secondary);">
                            <i class="fas fa-comments"></i>
                            <p>没有对话记录</p>
                        </div>
                    `;
                } else {
                    conversations[mode].forEach(conversation => {
                        const item = document.createElement('div');
                        item.className = 'conversation-item-dropdown';
                        if (conversation.id === currentConversationId && currentMode === mode) {
                            item.classList.add('active');
                        }
                        
                        item.innerHTML = `
                            <div class="conversation-name-dropdown">${conversation.title}</div>
                            <div class="conversation-actions-dropdown">
                                <button class="conversation-action-btn-dropdown rename-btn" title="重命名">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="conversation-action-btn-dropdown delete-btn" title="删除">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                        
                        item.addEventListener('click', (e) => {
                            if (e.target.closest('.conversation-action-btn-dropdown')) return;
                            
                            if (currentMode !== mode) {
                                switchMode(mode);
                            }
                            switchConversation(conversation.id);
                        });
                        
                        const renameBtn = item.querySelector('.rename-btn');
                        renameBtn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            openRenameModal(conversation.id, conversation.title);
                        });
                        
                        const deleteBtn = item.querySelector('.delete-btn');
                        deleteBtn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            deleteConversation(conversation.id);
                        });
                        
                        list.appendChild(item);
                    });
                }
                
                if (sectionTitle) {
                    const count = conversations[mode].length;
                    const countSpan = sectionTitle.querySelector('.conversation-count') || document.createElement('span');
                    if (!sectionTitle.querySelector('.conversation-count')) {
                        countSpan.className = 'conversation-count';
                        countSpan.style.marginLeft = 'auto';
                        countSpan.style.marginRight = '30px';
                        countSpan.style.fontSize = '0.8rem';
                        countSpan.style.color = 'var(--text-secondary)';
                        sectionTitle.appendChild(countSpan);
                    }
                    countSpan.textContent = count > 0 ? `(${count})` : '';
                }
            });
        }
        
        function renderConversationList() {
            updateConversationDropdowns();
        }
        
        function renderMessages() {
            const conversation = getCurrentConversation();
            messagesContainer.innerHTML = '';
            
            if (!conversation || conversation.messages.length === 0) {
                messagesContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-robot"></i>
                        <h3>开始新的对话</h3>
                        <p>在下方输入框发送消息开始对话</p>
                    </div>
                `;
                return;
            }
            
            conversation.messages.forEach((message, index) => {
                const messageContainer = document.createElement('div');
                messageContainer.className = `message-container ${message.role === 'user' ? 'user-message-container' : 'ai-message-container'}`;
                messageContainer.dataset.index = index;
                
                const wordCount = message.content.length;
                
                const formattedTime = formatDateTime(new Date(message.timestamp));
                
                const displayName = getDisplayName(message.role, conversation);
                
                const htmlContent = convertMarkdownToHtml(message.content);
                
                const isFailed = conversation.failedMessages && conversation.failedMessages.includes(index);
                
                const userAvatar = getUserAvatar();
                const aiAvatar = getAiAvatar();
                const avatarUrl = message.role === 'user' ? userAvatar : aiAvatar;
                const avatarInitial = message.role === 'user' ? (conversation.userNickname || '您').charAt(0) : (conversation.aiNickname || 'AI').charAt(0);
                
                if (message.role === 'user') {
                    messageContainer.innerHTML = `
                        <div class="message-bubble user-message-bubble">
                            <div class="message-content-wrapper">
                                <div class="message-header">
                                    <span>${formattedTime}</span>
                                </div>
                                <div class="message-content">${htmlContent}</div>
                                <div class="message-footer">
                                    <span>字数: ${wordCount}</span>
                                    <span>消耗: ${message.batteryCost ? message.batteryCost.toFixed(3) : '0.000'} 电池</span>
                                </div>
                                <div class="message-actions" id="messageActions-${index}"></div>
                                <div class="edit-message-container" id="editContainer-${index}">
                                    <textarea class="edit-textarea" id="editTextarea-${index}">${message.content}</textarea>
                                    <div class="edit-actions">
                                        <button class="message-action-btn" data-action="save-edit" data-index="${index}">保存</button>
                                        <button class="message-action-btn" data-action="cancel-edit" data-index="${index}">取消</button>
                                        <button class="message-action-btn delete" data-action="delete-message" data-index="${index}">删除</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="message-avatar-container">
                            <div class="message-avatar" style="${avatarUrl ? `background-image: url(${avatarUrl}); background-size: cover; background-position: center;` : ''}">
                                ${avatarUrl ? '' : avatarInitial}
                            </div>
                            <div class="message-nickname">${displayName}</div>
                        </div>
                    `;
                } else {
                    messageContainer.innerHTML = `
                        <div class="message-avatar-container">
                            <div class="message-avatar" style="${avatarUrl ? `background-image: url(${avatarUrl}); background-size: cover; background-position: center;` : ''}">
                                ${avatarUrl ? '' : avatarInitial}
                            </div>
                            <div class="message-nickname">${displayName}</div>
                        </div>
                        <div class="message-bubble ai-message-bubble">
                            <div class="message-content-wrapper">
                                <div class="message-header">
                                    <span>${formattedTime}</span>
                                </div>
                                <div class="message-content">${htmlContent}</div>
                                <div class="message-footer">
                                    <span>字数: ${wordCount}</span>
                                    <span>消耗: ${message.batteryCost ? message.batteryCost.toFixed(3) : '0.000'} 电池</span>
                                </div>
                                <div class="message-actions" id="messageActions-${index}"></div>
                                <div class="edit-message-container" id="editContainer-${index}">
                                    <textarea class="edit-textarea" id="editTextarea-${index}">${message.content}</textarea>
                                    <div class="edit-actions">
                                        <button class="message-action-btn" data-action="save-edit" data-index="${index}">保存</button>
                                        <button class="message-action-btn" data-action="cancel-edit" data-index="${index}">取消</button>
                                        <button class="message-action-btn delete" data-action="delete-message" data-index="${index}">删除</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                messagesContainer.appendChild(messageContainer);
                
                const messageActions = document.getElementById(`messageActions-${index}`);
                
                if (message.role === 'assistant') {
                    const regenerateBtn = document.createElement('button');
                    regenerateBtn.className = 'message-action-btn regenerate';
                    regenerateBtn.innerHTML = '<i class="fas fa-redo-alt"></i> 重新生成';
                    regenerateBtn.dataset.index = index;
                    regenerateBtn.addEventListener('click', regenerateAIResponse);
                    
                    const copyBtn = document.createElement('button');
                    copyBtn.className = 'message-action-btn copy';
                    copyBtn.innerHTML = '<i class="fas fa-copy"></i> 复制';
                    copyBtn.dataset.index = index;
                    copyBtn.addEventListener('click', copyAIMessage);
                    
                    const undoBtn = document.createElement('button');
                    undoBtn.className = 'message-action-btn undo';
                    undoBtn.innerHTML = '<i class="fas fa-undo"></i> 撤回';
                    undoBtn.dataset.index = index;
                    undoBtn.addEventListener('click', undoMessagePair);
                    
                    messageActions.appendChild(regenerateBtn);
                    messageActions.appendChild(copyBtn);
                    messageActions.appendChild(undoBtn);
                } else if (message.role === 'user') {
                    if (isFailed) {
                        const resendBtn = document.createElement('button');
                        resendBtn.className = 'message-action-btn resend';
                        resendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> 重新发送';
                        resendBtn.dataset.index = index;
                        resendBtn.addEventListener('click', resendMessage);
                        
                        messageActions.appendChild(resendBtn);
                    }
                }
                
                const editBtn = document.createElement('button');
                editBtn.className = 'message-action-btn edit';
                editBtn.innerHTML = '<i class="fas fa-edit"></i> 编辑';
                editBtn.dataset.index = index;
                editBtn.addEventListener('click', editMessage);
                
                messageActions.appendChild(editBtn);
                
                const deleteBtn = document.querySelector(`button[data-action="delete-message"][data-index="${index}"]`);
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', function() {
                        deleteMessage(index);
                    });
                }
            });
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            
            applySmartTextColor();
        }
        
        function copyAIMessage(e) {
            const index = parseInt(e.target.dataset.index);
            const conversation = getCurrentConversation();
            
            if (!conversation || index >= conversation.messages.length) return;
            
            const aiMessage = conversation.messages[index];
            if (aiMessage.role !== 'assistant') return;
            
            navigator.clipboard.writeText(aiMessage.content)
                .then(() => {
                    showNotification('AI回复已复制到剪贴板', 'success');
                })
                .catch(err => {
                    console.error('复制失败:', err);
                    showNotification('复制失败', 'error');
                });
        }
        
        function resendMessage(e) {
            const index = parseInt(e.target.dataset.index);
            const conversation = getCurrentConversation();
            
            if (!conversation || index >= conversation.messages.length) return;
            
            const userMessage = conversation.messages[index];
            if (userMessage.role !== 'user') return;
            
            if (conversation.failedMessages) {
                const failedIndex = conversation.failedMessages.indexOf(index);
                if (failedIndex !== -1) {
                    conversation.failedMessages.splice(failedIndex, 1);
                }
            }
            
            const content = userMessage.content;
            
            conversation.messages.splice(index, 1);
            
            saveUserData();
            
            renderMessages();
            
            messageInput.value = content;
            sendMessage();
        }
        
        async function deleteMessage(index) {
            const confirmed = await customConfirm('确定要删除这条消息吗？此操作不可恢复。', '删除消息确认');
            if (!confirmed) return;
            
            const conversation = getCurrentConversation();
            if (!conversation || index >= conversation.messages.length) return;
            
            const message = conversation.messages[index];
            
            conversation.messages.splice(index, 1);
            
            conversation.updatedAt = new Date().toISOString();
            
            saveUserData();
            
            renderMessages();
            updateActionButtons();
            showNotification('消息已删除', 'success');
        }
        
        function getDisplayName(role, conversation) {
            if (role === 'user') {
                return conversation.userNickname || '您';
            } else {
                return conversation.aiNickname || 'AI';
            }
        }
        
        function convertMarkdownToHtml(markdown) {
            if (!markdown) return '';
            
            let html = markdown;
            
            html = html.replace(/&/g, '&amp;')
                      .replace(/</g, '&lt;')
                      .replace(/>/g, '&gt;')
                      .replace(/"/g, '&quot;')
                      .replace(/'/g, '&#039;');
            
            html = html.replace(/^### (.*$)/gm, '<h3>$1</h3>');
            html = html.replace(/^## (.*$)/gm, '<h2>$1</h2>');
            html = html.replace(/^# (.*$)/gm, '<h1>$1</h1>');
            
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/__(.*?)__/g, '<strong>$1</strong>');
            
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
            html = html.replace(/_(.*?)_/g, '<em>$1</em>');
            
            html = html.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
            
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            html = html.replace(/^> (.*$)/gm, '<blockquote>$1</blockquote>');
            
            html = html.replace(/^[-*] (.*$)/gm, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>');
            
            html = html.replace(/^\d+\. (.*$)/gm, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>)/gs, '<ol>$1</ol>');
            
            html = html.replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank">$1</a>');
            
            html = html.replace(/!\[(.*?)\]\((.*?)\)/g, '<img src="$2" alt="$1" style="max-width:100%;">');
            
            html = html.replace(/^---$/gm, '<hr>');
            
            html = html.replace(/\n\n/g, '</p><p>');
            html = '<p>' + html + '</p>';
            
            return html;
        }
        
        async function aiFirst() {
            const conversation = getCurrentConversation();
            if (!conversation) return;
            
            if (apis.length === 0) {
                showNotification('请先激活', 'error');
                return;
            }
            
            const isTimeCardActive = currentUser && currentUser.timeCard && currentUser.timeCard.active;
            if (battery <= 0 && !isTimeCardActive) {
                showNotification('电池不足，请充值后使用', 'error');
                return;
            }
            
            const aiAvatar = getAiAvatar();
            const aiAvatarInitial = (conversation.aiNickname || 'AI').charAt(0);
            
            const aiMessageElement = document.createElement('div');
            aiMessageElement.className = 'message-container ai-message-container';
            aiMessageElement.innerHTML = `
                <div class="message-avatar-container">
                    <div class="message-avatar" style="${aiAvatar ? `background-image: url(${aiAvatar}); background-size: cover; background-position: center;` : ''}">
                        ${aiAvatar ? '' : aiAvatarInitial}
                    </div>
                    <div class="message-nickname">${conversation.aiNickname || 'AI'}</div>
                </div>
                <div class="message-bubble ai-message-bubble">
                    <div class="message-content-wrapper">
                        <div class="message-header">
                            <span>正在思考...</span>
                        </div>
                        <div class="loading">
                            <div class="loading-dots">
                                <div class="loading-dot"></div>
                                <div class="loading-dot"></div>
                                <div class="loading-dot"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            messagesContainer.appendChild(aiMessageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            try {
                const costEstimate = calculateBatteryCostByTokens(conversation, "");
                
                const isTimeCardActive = currentUser && currentUser.timeCard && currentUser.timeCard.active;
                if (battery - costEstimate.cost < 0 && !isTimeCardActive) {
                    aiMessageElement.remove();
                    showNotification('电池不足，请充值后使用', 'error');
                    return;
                }
                
                const aiResponse = await getAIResponse(conversation, "");
                
                aiMessageElement.remove();
                
                const finalCost = calculateBatteryCostByTokens(conversation, "", aiResponse);
                
                const aiMessage = {
                    role: 'assistant',
                    content: aiResponse,
                    timestamp: new Date().toISOString(),
                    wordCount: aiResponse.length,
                    batteryCost: calculateBatteryCostByTokensForText(aiResponse)
                };
                
                conversation.messages.push(aiMessage);
                conversation.updatedAt = new Date().toISOString();
                conversation.isNew = false;
                
                currentConversationCost += finalCost.cost;
                conversation.totalCost = currentConversationCost;
                
                consumeBattery(finalCost.cost, conversation.id, conversation.title);
                
                saveUserData();
                
                renderMessages();
                updateRecentConversations();
                updateActionButtons();
                
                updateCostEstimate();
                
                showNotification('AI已开始对话', 'success');
                
            } catch (error) {
                console.error('获取AI响应失败:', error);
                
                aiMessageElement.remove();
                showNotification(`AI先说失败: ${error.message}`, 'error');
            }
        }
        
        async function continueConversation() {
            const conversation = getCurrentConversation();
            if (!conversation || conversation.messages.length === 0) return;
            
            if (apis.length === 0) {
                showNotification('请先激活', 'error');
                return;
            }
            
            const isTimeCardActive = currentUser && currentUser.timeCard && currentUser.timeCard.active;
            if (battery <= 0 && !isTimeCardActive) {
                showNotification('电池不足，请充值后使用', 'error');
                return;
            }
            
            const aiAvatar = getAiAvatar();
            const aiAvatarInitial = (conversation.aiNickname || 'AI').charAt(0);
            
            const aiMessageElement = document.createElement('div');
            aiMessageElement.className = 'message-container ai-message-container';
            aiMessageElement.innerHTML = `
                <div class="message-avatar-container">
                    <div class="message-avatar" style="${aiAvatar ? `background-image: url(${aiAvatar}); background-size: cover; background-position: center;` : ''}">
                        ${aiAvatar ? '' : aiAvatarInitial}
                    </div>
                    <div class="message-nickname">${conversation.aiNickname || 'AI'}</div>
                </div>
                <div class="message-bubble ai-message-bubble">
                    <div class="message-content-wrapper">
                        <div class="message-header">
                            <span>正在继续...</span>
                        </div>
                        <div class="loading">
                            <div class="loading-dots">
                                <div class="loading-dot"></div>
                                <div class="loading-dot"></div>
                                <div class="loading-dot"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            messagesContainer.appendChild(aiMessageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            try {
                const lastMessage = conversation.messages[conversation.messages.length - 1];
                const continuePrompt = "请继续你刚才的回复，生成更多相关内容。";
                
                const tempConversation = JSON.parse(JSON.stringify(conversation));
                tempConversation.messages.push({
                    role: 'user',
                    content: continuePrompt,
                    timestamp: new Date().toISOString()
                });
                
                const costEstimate = calculateBatteryCostByTokens(tempConversation, continuePrompt);
                
                const isTimeCardActive = currentUser && currentUser.timeCard && currentUser.timeCard.active;
                if (battery - costEstimate.cost < 0 && !isTimeCardActive) {
                    aiMessageElement.remove();
                    showNotification('电池不足，请充值后使用', 'error');
                    return;
                }
                
                const aiResponse = await getAIResponse(tempConversation, continuePrompt);
                
                aiMessageElement.remove();
                
                const finalCost = calculateBatteryCostByTokens(tempConversation, continuePrompt, aiResponse);
                
                const aiMessage = {
                    role: 'assistant',
                    content: aiResponse,
                    timestamp: new Date().toISOString(),
                    wordCount: aiResponse.length,
                    batteryCost: calculateBatteryCostByTokensForText(aiResponse)
                };
                
                conversation.messages.push(aiMessage);
                conversation.updatedAt = new Date().toISOString();
                
                currentConversationCost += finalCost.cost;
                conversation.totalCost = currentConversationCost;
                
                consumeBattery(finalCost.cost, conversation.id, conversation.title);
                
                saveUserData();
                
                renderMessages();
                updateRecentConversations();
                
                updateCostEstimate();
                
                showNotification('AI已继续对话', 'success');
                
            } catch (error) {
                console.error('继续AI响应失败:', error);
                
                aiMessageElement.remove();
                showNotification(`继续失败: ${error.message}`, 'error');
            }
        }
        
        async function regenerateAIResponse(e) {
            const index = parseInt(e.target.dataset.index);
            const conversation = getCurrentConversation();
            
            if (!conversation || index >= conversation.messages.length) return;
            
            const messageToRegenerate = conversation.messages[index];
            if (messageToRegenerate.role !== 'assistant') return;
            
            let userMessageIndex = -1;
            let userMessageContent = '';
            
            if (index > 0 && conversation.messages[index - 1].role === 'user') {
                userMessageIndex = index - 1;
                userMessageContent = conversation.messages[index - 1].content;
            } else {
                for (let i = 0; i < index; i++) {
                    if (conversation.messages[i].role === 'user') {
                        userMessageIndex = i;
                        userMessageContent = conversation.messages[i].content;
                        break;
                    }
                }
                
                if (userMessageIndex === -1) {
                    userMessageContent = conversation.presetMessage || '';
                }
            }
            
            if (!userMessageContent && index !== 0) {
                showNotification('找不到对应的用户消息', 'error');
                return;
            }
            
            const confirmed = await customConfirm('确定要重新生成这条AI回复吗？', '重新生成确认');
            if (!confirmed) return;
            
            if (apis.length === 0) {
                showNotification('请先激活', 'error');
                return;
            }
            
            const isTimeCardActive = currentUser && currentUser.timeCard && currentUser.timeCard.active;
            if (battery <= 0 && !isTimeCardActive) {
                showNotification('电池不足，请充值后使用', 'error');
                return;
            }
            
            const tempMessagesContainer = messagesContainer.innerHTML;
            messagesContainer.innerHTML = tempMessagesContainer;
            
            const aiAvatar = getAiAvatar();
            const aiAvatarInitial = (conversation.aiNickname || 'AI').charAt(0);
            
            const aiMessageElement = document.createElement('div');
            aiMessageElement.className = 'message-container ai-message-container';
            aiMessageElement.innerHTML = `
                <div class="message-avatar-container">
                    <div class="message-avatar" style="${aiAvatar ? `background-image: url(${aiAvatar}); background-size: cover; background-position: center;` : ''}">
                        ${aiAvatar ? '' : aiAvatarInitial}
                    </div>
                    <div class="message-nickname">${conversation.aiNickname || 'AI'}</div>
                </div>
                <div class="message-bubble ai-message-bubble">
                    <div class="message-content-wrapper">
                        <div class="message-header">
                            <span>重新生成中...</span>
                        </div>
                        <div class="loading">
                            <div class="loading-dots">
                                <div class="loading-dot"></div>
                                <div class="loading-dot"></div>
                                <div class="loading-dot"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const originalMessageElement = document.querySelector(`.message[data-index="${index}"]`);
            if (originalMessageElement) {
                originalMessageElement.style.opacity = '0.5';
            }
            
            messagesContainer.appendChild(aiMessageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            try {
                const tempConversation = JSON.parse(JSON.stringify(conversation));
                tempConversation.messages = tempConversation.messages.slice(0, index);
                
                const costEstimate = calculateBatteryCostByTokens(tempConversation, userMessageContent);
                
                const isTimeCardActive = currentUser && currentUser.timeCard && currentUser.timeCard.active;
                if (battery - costEstimate.cost < 0 && !isTimeCardActive) {
                    aiMessageElement.remove();
                    if (originalMessageElement) {
                        originalMessageElement.style.opacity = '1';
                    }
                    showNotification('电池不足，请充值后使用', 'error');
                    return;
                }
                
                const aiResponse = await getAIResponse(tempConversation, userMessageContent);
                
                aiMessageElement.remove();
                if (originalMessageElement) {
                    originalMessageElement.remove();
                }
                
                const finalCost = calculateBatteryCostByTokens(tempConversation, userMessageContent, aiResponse);
                
                const originalAICost = conversation.messages[index].batteryCost || 0;
                const newAICost = calculateBatteryCostByTokensForText(aiResponse);
                
                conversation.messages[index].content = aiResponse;
                conversation.messages[index].timestamp = new Date().toISOString();
                conversation.messages[index].wordCount = aiResponse.length;
                conversation.messages[index].batteryCost = newAICost;
                
                conversation.updatedAt = new Date().toISOString();
                
                const costDifference = finalCost.cost - originalAICost;
                if (costDifference > 0) {
                    consumeBattery(costDifference, conversation.id, conversation.title);
                } else if (costDifference < 0) {
                    rechargeBatteryFunc(Math.abs(costDifference));
                }
                
                currentConversationCost += costDifference;
                conversation.totalCost = currentConversationCost;
                
                saveUserData();
                
                renderMessages();
                updateRecentConversations();
                
                updateCostEstimate();
                
                showNotification('AI回复已重新生成', 'success');
                
            } catch (error) {
                console.error('重新生成AI响应失败:', error);
                
                aiMessageElement.remove();
                if (originalMessageElement) {
                    originalMessageElement.style.opacity = '1';
                }
                
                showNotification(`重新生成失败: ${error.message}`, 'error');
            }
        }
        
        async function undoMessagePair(e) {
            const index = parseInt(e.target.dataset.index);
            const conversation = getCurrentConversation();
            
            if (!conversation || index >= conversation.messages.length) return;
            
            const aiMessage = conversation.messages[index];
            if (aiMessage.role !== 'assistant') return;
            
            if (index > 0 && conversation.messages[index - 1].role === 'user') {
                const confirmed = await customConfirm('确定要撤回这一轮对话吗？用户消息将复制到输入框中。', '撤回对话确认');
                if (confirmed) {
                    const userMessage = conversation.messages[index - 1];
                    const userMessageContent = userMessage.content;
                    
                    conversation.messages.splice(index - 1, 2);
                    conversation.updatedAt = new Date().toISOString();
                    
                    saveUserData();
                    
                    messageInput.value = userMessageContent;
                    messageInput.focus();
                    
                    renderMessages();
                    updateRecentConversations();
                    updateActionButtons();
                    
                    updateCostEstimate();
                    
                    showNotification('对话已撤回，用户消息已复制到输入框', 'success');
                }
            } else {
                const confirmed = await customConfirm('确定要撤回这条AI消息吗？', '撤回消息确认');
                if (confirmed) {
                    conversation.messages.splice(index, 1);
                    conversation.updatedAt = new Date().toISOString();
                    
                    saveUserData();
                    
                    messageInput.value = '';
                    messageInput.focus();
                    
                    renderMessages();
                    updateRecentConversations();
                    updateActionButtons();
                    
                    updateCostEstimate();
                    
                    showNotification('AI消息已撤回', 'success');
                }
            }
        }
        
        function editMessage(e) {
            const index = parseInt(e.target.dataset.index);
            const editContainer = document.getElementById(`editContainer-${index}`);
            const messageElement = document.querySelector(`.message-container[data-index="${index}"]`);
            const messageContent = document.querySelector(`.message-container[data-index="${index}"] .message-content`);
            
            if (!editContainer || !messageElement || !messageContent) return;
            
            if (editContainer.classList.contains('active')) {
                editContainer.classList.remove('active');
                messageContent.style.display = 'block';
            } else {
                editContainer.classList.add('active');
                messageContent.style.display = 'none';
            }
            
            const saveEditBtn = document.querySelector(`button[data-action="save-edit"][data-index="${index}"]`);
            const cancelEditBtn = document.querySelector(`button[data-action="cancel-edit"][data-index="${index}"]`);
            
            if (saveEditBtn && cancelEditBtn) {
                saveEditBtn.onclick = function() {
                    saveMessageEdit(index);
                };
                
                cancelEditBtn.onclick = function() {
                    cancelMessageEdit(index);
                };
            }
        }
        
        function saveMessageEdit(index) {
            const editTextarea = document.getElementById(`editTextarea-${index}`);
            const conversation = getCurrentConversation();
            
            if (!editTextarea || !conversation || index >= conversation.messages.length) return;
            
            const newContent = editTextarea.value.trim();
            if (!newContent) {
                showNotification('消息内容不能为空', 'error');
                return;
            }
            
            const originalMessage = conversation.messages[index];
            const originalContent = originalMessage.content;
            const originalCost = originalMessage.batteryCost || 0;
            
            const newCost = calculateBatteryCostByTokensForText(newContent);
            const costDifference = newCost - originalCost;
            
            originalMessage.content = newContent;
            originalMessage.timestamp = new Date().toISOString();
            originalMessage.wordCount = newContent.length;
            originalMessage.batteryCost = newCost;
            
            conversation.updatedAt = new Date().toISOString();
            
            currentConversationCost += costDifference;
            conversation.totalCost = currentConversationCost;
            
            if (costDifference > 0) {
                consumeBattery(costDifference, conversation.id, conversation.title);
            } else if (costDifference < 0) {
                rechargeBatteryFunc(Math.abs(costDifference));
            }
            
            saveUserData();
            
            renderMessages();
            updateRecentConversations();
            
            updateCostEstimate();
            
            showNotification('消息已更新', 'success');
        }
        
        function cancelMessageEdit(index) {
            const editContainer = document.getElementById(`editContainer-${index}`);
            const messageContent = document.querySelector(`.message-container[data-index="${index}"] .message-content`);
            
            if (editContainer && messageContent) {
                editContainer.classList.remove('active');
                messageContent.style.display = 'block';
            }
        }
        
        async function sendMessage() {
            const content = messageInput.value.trim();
            if (!content) return;
            
            if (apis.length === 0) {
                showNotification('请先激活', 'error');
                return;
            }
            
            let conversation = getCurrentConversation();
            if (!conversation) {
                createNewConversation();
                conversation = getCurrentConversation();
            }
            
            messageInput.value = '';
            
            const userMessage = {
                role: 'user',
                content: content,
                timestamp: new Date().toISOString(),
                wordCount: content.length,
                batteryCost: 0
            };
            
            conversation.messages.push(userMessage);
            conversation.isNew = false;
            conversation.updatedAt = new Date().toISOString();
            
            renderMessages();
            updateActionButtons();
            
            const aiAvatar = getAiAvatar();
            const aiAvatarInitial = (conversation.aiNickname || 'AI').charAt(0);
            
            const aiMessageElement = document.createElement('div');
            aiMessageElement.className = 'message-container ai-message-container';
            aiMessageElement.innerHTML = `
                <div class="message-avatar-container">
                    <div class="message-avatar" style="${aiAvatar ? `background-image: url(${aiAvatar}); background-size: cover; background-position: center;` : ''}">
                        ${aiAvatar ? '' : aiAvatarInitial}
                    </div>
                    <div class="message-nickname">${conversation.aiNickname || 'AI'}</div>
                </div>
                <div class="message-bubble ai-message-bubble">
                    <div class="message-content-wrapper">
                        <div class="message-header">
                            <span>正在思考...</span>
                        </div>
                        <div class="loading">
                            <div class="loading-dots">
                                <div class="loading-dot"></div>
                                <div class="loading-dot"></div>
                                <div class="loading-dot"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            messagesContainer.appendChild(aiMessageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            try {
                const costEstimate = calculateBatteryCostByTokens(conversation, content);
                
                const isTimeCardActive = currentUser && currentUser.timeCard && currentUser.timeCard.active;
                if (battery - costEstimate.cost < 0 && !isTimeCardActive) {
                    aiMessageElement.remove();
                    
                    conversation.messages.pop();
                    
                    renderMessages();
                    updateActionButtons();
                    
                    showNotification('电池不足，请充值后使用', 'error');
                    return;
                }
                
                const aiResponse = await getAIResponse(conversation, content);
                
                aiMessageElement.remove();
                
                const finalCost = calculateBatteryCostByTokens(conversation, content, aiResponse);
                
                userMessage.batteryCost = calculateBatteryCostByTokensForText(content);
                
                const aiMessage = {
                    role: 'assistant',
                    content: aiResponse,
                    timestamp: new Date().toISOString(),
                    wordCount: aiResponse.length,
                    batteryCost: calculateBatteryCostByTokensForText(aiResponse)
                };
                
                conversation.messages.push(aiMessage);
                conversation.updatedAt = new Date().toISOString();
                
                currentConversationCost += finalCost.cost;
                conversation.totalCost = currentConversationCost;
                
                consumeBattery(finalCost.cost, conversation.id, conversation.title);
                
                saveUserData();
                
                renderMessages();
                updateRecentConversations();
                updateActionButtons();
                
                updateCostEstimate();
                
            } catch (error) {
                console.error('获取AI响应失败:', error);
                
                aiMessageElement.remove();
                
                const lastIndex = conversation.messages.length - 1;
                if (!conversation.failedMessages) {
                    conversation.failedMessages = [];
                }
                conversation.failedMessages.push(lastIndex);
                
                saveUserData();
                
                renderMessages();
                updateActionButtons();
                
                showNotification(`API调用失败: ${error.message}`, 'error');
            }
        }
        
        async function getAIResponse(conversation, userMessageContent) {
            if (apis.length === 0) {
                throw new Error('请先激活');
            }
            
            const api = apis.find(a => a.id === currentApiId) || apis[0];
            if (!api) {
                throw new Error('没有可用的API');
            }
            
            const messages = [];
            
            if (conversation.presetIndex !== -1 && conversation.presetContent) {
                messages.push({
                    role: "system",
                    content: conversation.presetContent
                });
            }
            
            if (conversation.aiNickname && conversation.userNickname) {
                messages.push({
                    role: "system",
                    content: `[你的名字:${conversation.aiNickname}][你对用户的称呼:${conversation.userNickname}]`
                });
            }
            
            if (currentMode === 'document' && conversation.document) {
                messages.unshift({
                    role: 'system',
                    content: `用户上传了一个文档，内容如下:\n\n${conversation.document.content}\n\n请根据文档内容回答用户的问题。`
                });
            }
            
            const contextLength = conversation.contextLength || 5;
            const startIndex = Math.max(0, conversation.messages.length - contextLength * 2);
            
            for (let i = startIndex; i < conversation.messages.length; i++) {
                const msg = conversation.messages[i];
                messages.push({
                    role: msg.role === 'user' ? 'user' : 'assistant',
                    content: msg.content
                });
            }
            
            messages.push({
                role: 'user',
                content: userMessageContent
            });
            
            const endpoint = api.endpoint || 'https://api.deepseek.com/v1';
            const response = await fetch(`${endpoint}/chat/completions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${api.key}`
                },
                body: JSON.stringify({
                    model: api.model || 'deepseek-chat',
                    messages: messages,
                    max_tokens: 4000,
                    temperature: conversation.temperature || temperature
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || 'API请求失败');
            }
            
            const data = await response.json();
            return data.choices[0].message.content;
        }
        
        function openPresetModal() {
            presetModal.classList.add('active');
            loadPresetSelect();
            loadSelectedPreset();
            renderPresetList();
        }
        
        function loadPresetSelect() {
            presetSelect.innerHTML = '<option value="-1" selected>不使用</option>';
            
            customPresets.forEach((preset, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = preset.name;
                presetSelect.appendChild(option);
            });
            
            const conversation = getCurrentConversation();
            if (conversation && conversation.presetIndex !== -1) {
                presetSelect.value = conversation.presetIndex;
            }
        }
        
        function loadSelectedPreset() {
            const conversation = getCurrentConversation();
            if (!conversation) return;
            
            const selectedIndex = presetSelect.value;
            
            if (selectedIndex === "-1") {
                presetInstruction.value = '';
                presetInstruction.disabled = true;
                customPresetName.value = '自定义预设1';
                customPresetName.disabled = true;
                aiNickname.value = '';
                aiNickname.disabled = true;
                userNickname.value = '';
                userNickname.disabled = true;
                updatePresetTokensDisplay();
                return;
            }
            
            const index = parseInt(selectedIndex);
            if (index >= 0 && index < customPresets.length) {
                const preset = customPresets[index];
                presetInstruction.value = preset.content || '';
                presetInstruction.disabled = false;
                customPresetName.value = preset.name || `自定义预设${index + 1}`;
                customPresetName.disabled = false;
                aiNickname.value = preset.aiNickname || '';
                aiNickname.disabled = false;
                userNickname.value = preset.userNickname || '';
                userNickname.disabled = false;
                updatePresetTokensDisplay();
            }
        }
        
        function handlePresetSelectChange() {
            const selectedIndex = presetSelect.value;
            
            if (selectedIndex === "-1") {
                presetInstruction.value = '';
                presetInstruction.disabled = true;
                customPresetName.value = '自定义预设1';
                customPresetName.disabled = true;
                aiNickname.value = '';
                aiNickname.disabled = true;
                userNickname.value = '';
                userNickname.disabled = true;
            } else {
                const index = parseInt(selectedIndex);
                if (index >= 0 && index < customPresets.length) {
                    const preset = customPresets[index];
                    presetInstruction.value = preset.content || '';
                    presetInstruction.disabled = false;
                    customPresetName.value = preset.name || `自定义预设${index + 1}`;
                    customPresetName.disabled = false;
                    aiNickname.value = preset.aiNickname || '';
                    aiNickname.disabled = false;
                    userNickname.value = preset.userNickname || '';
                    userNickname.disabled = false;
                }
            }
            
            updatePresetTokensDisplay();
        }
        
        function updatePresetStatusDisplay() {
            const conversation = getCurrentConversation();
            if (!conversation) return;
            
            if (conversation.presetIndex === -1) {
                presetStatusDisplay.textContent = '未启用';
                presetStatusDisplay.className = 'nickname-status disabled';
            } else {
                presetStatusDisplay.textContent = '已启用';
                presetStatusDisplay.className = 'nickname-status enabled';
            }
        }
        
        function createNewPreset() {
            const conversation = getCurrentConversation();
            if (!conversation) return;
            
            const newPresetIndex = customPresets.length;
            const newPresetName = `自定义预设${newPresetIndex + 1}`;
            
            const newPreset = {
                name: newPresetName,
                content: '',
                aiNickname: '',
                userNickname: ''
            };
            
            customPresets.push(newPreset);
            
            currentUser.customPresets = customPresets;
            saveUserData();
            
            loadPresetSelect();
            presetSelect.value = newPresetIndex;
            
            handlePresetSelectChange();
            
            conversation.presetIndex = newPresetIndex;
            conversation.presetContent = '';
            conversation.aiNickname = '';
            conversation.userNickname = '';
            
            saveUserData();
            updatePresetStatusDisplay();
            updateCostEstimate();
            updateContextCostInfo();
            renderMessages();
            
            showNotification('已创建新预设', 'success');
        }
        
        function savePreset() {
            const conversation = getCurrentConversation();
            if (!conversation) return;
            
            const selectedIndex = presetSelect.value;
            
            if (selectedIndex === "-1") {
                conversation.presetIndex = -1;
                conversation.presetContent = '';
                conversation.aiNickname = '';
                conversation.userNickname = '';
                
                saveUserData();
                updatePresetStatusDisplay();
                updateCostEstimate();
                updateContextCostInfo();
                renderMessages();
                
                showNotification('预设已禁用', 'success');
                return;
            }
            
            const name = customPresetName.value.trim();
            const content = presetInstruction.value.trim();
            const ai = aiNickname.value.trim();
            const user = userNickname.value.trim();
            
            if (!name) {
                showNotification('请输入预设名称', 'error');
                return;
            }
            
            if ((ai && !user) || (!ai && user)) {
                showNotification('昵称需同时设置或同时留空', 'error');
                return;
            }
            
            const index = parseInt(selectedIndex);
            
            if (index >= 0 && index < customPresets.length) {
                customPresets[index].name = name;
                customPresets[index].content = content;
                customPresets[index].aiNickname = ai;
                customPresets[index].userNickname = user;
                
                conversation.presetIndex = index;
                conversation.presetContent = content;
                conversation.aiNickname = ai;
                conversation.userNickname = user;
                
                saveUserData();
                loadPresetSelect();
                presetSelect.value = index;
                handlePresetSelectChange();
            } else {
                const newPreset = {
                    name: name,
                    content: content,
                    aiNickname: ai,
                    userNickname: user
                };
                customPresets.push(newPreset);
                const newIndex = customPresets.length - 1;
                
                conversation.presetIndex = newIndex;
                conversation.presetContent = content;
                conversation.aiNickname = ai;
                conversation.userNickname = user;
                
                saveUserData();
                loadPresetSelect();
                presetSelect.value = newIndex;
                handlePresetSelectChange();
            }
            
            currentUser.customPresets = customPresets;
            saveUserData();
            
            updatePresetStatusDisplay();
            updateCostEstimate();
            updateContextCostInfo();
            renderMessages();
            showNotification('预设已保存', 'success');
        }
        
        function renderPresetList() {
            presetList.innerHTML = '';
            
            if (customPresets.length === 0) {
                presetList.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">暂无预设指令</div>';
                return;
            }
            
            customPresets.forEach((preset, index) => {
                const presetItem = document.createElement('div');
                presetItem.className = 'preset-item';
                presetItem.style.cssText = 'display: flex; align-items: center; padding: 8px; margin-bottom: 5px; border: 1px solid var(--border-color); border-radius: 4px; background-color: rgba(255, 255, 255, 0.02);';
                
                presetItem.innerHTML = `
                    <input type="checkbox" class="preset-checkbox" data-index="${index}" style="margin-right: 10px;">
                    <div style="flex: 1;">
                        <div style="font-weight: bold; font-size: 0.9rem;">${preset.name}</div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${preset.content.substring(0, 50)}${preset.content.length > 50 ? '...' : ''}</div>
                    </div>
                `;
                
                presetList.appendChild(presetItem);
            });
        }
        
        function deleteCurrentPreset() {
            const selectedIndex = presetSelect.value;
            
            if (selectedIndex === "-1") {
                showNotification('请先选择要删除的预设', 'error');
                return;
            }
            
            customConfirm('确定要删除这个预设吗？', '删除预设确认').then(confirmed => {
                if (!confirmed) return;
                
                const index = parseInt(selectedIndex);
                customPresets.splice(index, 1);
                
                const conversation = getCurrentConversation();
                if (conversation && conversation.presetIndex === index) {
                    conversation.presetIndex = -1;
                    conversation.presetContent = '';
                    conversation.aiNickname = '';
                    conversation.userNickname = '';
                }
                
                currentUser.customPresets = customPresets;
                saveUserData();
                
                loadPresetSelect();
                presetSelect.value = "-1";
                handlePresetSelectChange();
                renderPresetList();
                
                updatePresetStatusDisplay();
                updateCostEstimate();
                updateContextCostInfo();
                renderMessages();
                showNotification('预设已删除', 'success');
            });
            if (!confirmed) return;
            
            const index = parseInt(selectedIndex);
            customPresets.splice(index, 1);
            
            const conversation = getCurrentConversation();
            if (conversation && conversation.presetIndex === index) {
                conversation.presetIndex = -1;
                conversation.presetContent = '';
                conversation.aiNickname = '';
                conversation.userNickname = '';
            }
            
            currentUser.customPresets = customPresets;
            saveUserData();
            
            loadPresetSelect();
            presetSelect.value = "-1";
            handlePresetSelectChange();
            renderPresetList();
            
            updatePresetStatusDisplay();
            updateCostEstimate();
            updateContextCostInfo();
            renderMessages();
            showNotification('预设已删除', 'success');
        }
        
        function exportSelectedPresets() {
            const checkboxes = document.querySelectorAll('.preset-checkbox:checked');
            
            if (checkboxes.length === 0) {
                showNotification('请先选择要导出的预设指令', 'error');
                return;
            }
            
            const selectedPresets = [];
            checkboxes.forEach(checkbox => {
                const index = parseInt(checkbox.dataset.index);
                if (index >= 0 && index < customPresets.length) {
                    selectedPresets.push(customPresets[index]);
                }
            });
            
            if (selectedPresets.length === 0) {
                showNotification('没有有效的预设指令可导出', 'error');
                return;
            }
            
            const exportData = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                presets: selectedPresets
            };
            
            const jsonString = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `樱梦AI预设指令_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification(`成功导出 ${selectedPresets.length} 个预设指令`, 'success');
        }
        
        function importPresets() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                if (!file.name.endsWith('.json')) {
                    showNotification('请选择JSON格式的文件', 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const importData = JSON.parse(e.target.result);
                        
                        if (!importData.presets || !Array.isArray(importData.presets)) {
                            showNotification('文件格式不正确', 'error');
                            return;
                        }
                        
                        if (importData.presets.length === 0) {
                            showNotification('导入文件为空', 'error');
                            return;
                        }
                        
                        
                        for (let i = 0; i < importData.presets.length; i++) {
                            const preset = importData.presets[i];
                            if (!preset.name || !preset.content) {
                                showNotification(`第 ${i + 1} 个预设格式不正确，导入失败`, 'error');
                                return;
                            }
                        }
                        
                        
                        const duplicateNames = [];
                        importData.presets.forEach(importedPreset => {
                            const existingIndex = customPresets.findIndex(p => p.name === importedPreset.name);
                            if (existingIndex !== -1) {
                                duplicateNames.push(importedPreset.name);
                            }
                        });
                        
                        let importMessage = `确定要导入 ${importData.presets.length} 个预设指令吗？`;
                        if (duplicateNames.length > 0) {
                            importMessage += `\n\n注意：以下预设名称已存在，导入后将覆盖：\n${duplicateNames.join(', ')}`;
                        } else {
                            importMessage += '\n\n这将添加新的预设指令到现有列表中。';
                        }
                        
                        const confirmed = await customConfirm(importMessage, '导入预设确认');
                        if (!confirmed) {
                            return;
                        }
                        
                        
                        importData.presets.forEach(importedPreset => {
                            const existingIndex = customPresets.findIndex(p => p.name === importedPreset.name);
                            if (existingIndex !== -1) {
                                
                                customPresets[existingIndex] = importedPreset;
                            } else {
                                
                                customPresets.push(importedPreset);
                            }
                        });
                        
                        currentUser.customPresets = customPresets;
                        saveUserData();
                        
                        loadPresetSelect();
                        renderPresetList();
                        updatePresetStatusDisplay();
                        
                        showNotification(`成功导入 ${importData.presets.length} 个预设指令`, 'success');
                        
                    } catch (error) {
                        console.error('导入错误:', error);
                        showNotification('文件解析失败，请检查文件格式', 'error');
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }
        
        function handleNicknameChange() {
            const conversation = getCurrentConversation();
            if (!conversation) return;
            
            const ai = aiNickname.value.trim();
            const user = userNickname.value.trim();
            
            if ((ai && !user) || (!ai && user)) {
                showNotification('昵称需同时设置或同时留空', 'warning');
                return;
            }
            
            conversation.aiNickname = ai;
            conversation.userNickname = user;
            
            saveUserData();
            updateCostEstimate();
            updateContextCostInfo();
            
            renderMessages();
        }
        
        function openRenameModal(conversationId, currentName) {
            renameModal.classList.add('active');
            conversationNameInput.value = currentName;
            conversationNameInput.dataset.id = conversationId;
        }
        
        function saveConversationRename() {
            const conversationId = parseInt(conversationNameInput.dataset.id);
            const newName = conversationNameInput.value.trim();
            
            if (!newName) {
                showNotification('对话名称不能为空', 'error');
                return;
            }
            
            for (const mode in conversations) {
                const conversation = conversations[mode].find(c => c.id === conversationId);
                if (conversation) {
                    conversation.title = newName;
                    conversation.updatedAt = new Date().toISOString();
                    

                    if (conversationId === currentConversationId && conversationTitle) {
                        conversationTitle.textContent = newName;
                    }
                    break;
                }
            }
            
            saveUserData();
            renderConversationList();
            updateRecentConversations();
            renameModal.classList.remove('active');
            showNotification('对话已重命名', 'success');
        }
        
        async function deleteConversation(conversationId) {
            const confirmed = await customConfirm('确定要删除这个对话吗？', '删除对话确认');
            if (!confirmed) return;
            
            let conversationTitle = '';
            for (const mode in conversations) {
                const conversation = conversations[mode].find(c => c.id === conversationId);
                if (conversation) {
                    conversationTitle = conversation.title;
                    break;
                }
            }
            
            for (const mode in conversations) {
                conversations[mode] = conversations[mode].filter(c => c.id !== conversationId);
            }
            
            if (conversationId === currentConversationId) {
                if (conversations[currentMode].length > 0) {
                    switchConversation(conversations[currentMode][0].id);
                } else {
                    createNewConversation();
                }
            }
            
            saveUserData();
            renderConversationList();
            updateRecentConversations();
            showNotification('对话已删除', 'success');
        }
        
        function addNewApi() {
            const name = apiName.value.trim();
            const key = apiKey.value.trim();
            const endpoint = apiEndpoint.value.trim();
            const model = apiModel.value.trim();
            
            if (!name || !key) {
                showNotification('API名称和密钥不能为空', 'error');
                return;
            }
            
            const existingApi = apis.find(api => api.key === key);
            if (existingApi) {
                showNotification('该API密钥已存在', 'error');
                return;
            }
            
            const apiId = Date.now();
            const newApi = {
                id: apiId,
                name: name,
                key: key,
                endpoint: endpoint || 'https://api.deepseek.com/v1',
                model: model || 'deepseek-chat',
                isActive: true
            };
            
            apis.push(newApi);
            
            if (apis.length === 1) {
                currentApiId = apiId;
            }
            
            if (currentUser) {
                currentUser.apis = apis;
                saveUserData();
            }
            
            apiName.value = '';
            apiKey.value = '';
            apiEndpoint.value = 'https://api.deepseek.com/v1';
            apiModel.value = 'deepseek-chat';
            
            renderApiList();
            
            showNotification('API添加成功', 'success');
        }
        
        function renderApiList() {
            apiList.innerHTML = '';
            
            if (apis.length === 0) {
                apiList.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 20px;">暂无API</div>';
                return;
            }
            
            apis.forEach(api => {
                const item = document.createElement('div');
                item.className = `api-item ${api.id === currentApiId ? 'active' : ''}`;
                
                const hiddenKey = api.key.substring(0, 8) + '***' + api.key.substring(api.key.length - 4);
                
                item.innerHTML = `
                    <div style="flex: 1;">
                        <div class="api-name">${api.name} ${api.id === currentApiId ? '<span style="color: var(--secondary-color); font-size: 0.8rem;">(当前使用)</span>' : ''}</div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 5px;">
                            端点: ${api.endpoint}<br>
                            模型: ${api.model}
                        </div>
                    </div>
                    <div class="api-actions">
                        <button class="btn btn-secondary btn-sm switch-api-btn" data-id="${api.id}" style="padding: 4px 8px; font-size: 0.8rem; margin-right: 5px;">
                            <i class="fas fa-toggle-on"></i>
                        </button>
                        <button class="btn btn-danger btn-sm delete-api-btn" data-id="${api.id}" style="padding: 4px 8px; font-size: 0.8rem;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                apiList.appendChild(item);
            });
            
            document.querySelectorAll('.switch-api-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const apiId = parseInt(this.dataset.id);
                    switchApi(apiId);
                });
            });
            
            document.querySelectorAll('.delete-api-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const apiId = parseInt(this.dataset.id);
                    openDeleteApiModal(apiId);
                });
            });
        }
        
        function switchApi(apiId) {
            currentApiId = apiId;
            
            if (currentUser) {
                saveUserData();
            }
            
            renderApiList();
            
            showNotification('已切换API', 'success');
        }
        
        function openDeleteApiModal(apiId) {
            apiToDelete = apiId;
            deleteCountdown = 10;
            deleteTimerElement.textContent = deleteCountdown;
            deleteCountdownElement.textContent = deleteCountdown;
            
            confirmDeleteApiBtn.disabled = true;
            deleteApiModal.classList.add('active');
            
            deleteTimer = setInterval(() => {
                deleteCountdown--;
                deleteTimerElement.textContent = deleteCountdown;
                deleteCountdownElement.textContent = deleteCountdown;
                
                if (deleteCountdown <= 0) {
                    clearDeleteTimer();
                    confirmDeleteApiBtn.disabled = false;
                }
            }, 1000);
        }
        
        function clearDeleteTimer() {
            if (deleteTimer) {
                clearInterval(deleteTimer);
                deleteTimer = null;
            }
        }
        
        function deleteApi() {
            apis = apis.filter(api => api.id !== apiToDelete);
            
            if (apiToDelete === currentApiId) {
                currentApiId = apis.length > 0 ? apis[0].id : null;
            }
            
            currentUser.apis = apis;
            saveUserData();
            
            deleteApiModal.classList.remove('active');
            clearDeleteTimer();
            
            renderApiList();
            
            showNotification('API已删除', 'success');
            
            if (apis.length === 0) {
                showNotification('您已删除所有API密钥，请添加新的API以使用AI功能', 'warning');
            }
        }
        
        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const fileType = file.type;
            const validTypes = ['text/plain', 'application/json'];
            const validExtensions = ['.txt', '.json'];
            
            const fileName = file.name.toLowerCase();
            const isValidExtension = validExtensions.some(ext => fileName.endsWith(ext));
            
            if (!validTypes.includes(fileType) && !isValidExtension) {
                showNotification('只支持 .txt 和 .json 文件', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(event) {
                const content = event.target.result;
                
                const conversation = getCurrentConversation();
                if (conversation) {
                    conversation.document = {
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        content: content
                    };
                    
                    documentInfo.innerHTML = `
                        <div style="background: rgba(124, 58, 237, 0.1); padding: 10px; border-radius: 6px;">
                            <i class="fas fa-file"></i> 
                            已上传: ${file.name} (${formatFileSize(file.size)})
                        </div>
                    `;
                    
                    saveUserData();
                    updateCostEstimate();
                    updateContextCostInfo();
                    showNotification('文档已上传', 'success');
                }
            };
            
            reader.readAsText(file);
        }
        
        function exportConversation() {
            const conversation = getCurrentConversation();
            if (!conversation || conversation.messages.length === 0) {
                showNotification('当前对话没有内容可以导出', 'error');
                return;
            }
            
            let exportContent = '';
            
            conversation.messages.forEach(message => {
                const displayName = getDisplayName(message.role, conversation);
                exportContent += `${displayName}: ${message.content}\n\n`;
            });
            
            const blob = new Blob([exportContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${conversation.title || '对话记录'}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('对话已导出', 'success');
        }
        
        function handleImportConversation(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.endsWith('.txt')) {
                showNotification('请选择.txt格式的文件', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    const fileName = file.name.replace('.txt', '');
                    importConversation(content, fileName);
                    event.target.value = '';
                } catch (error) {
                    console.error('导入对话失败:', error);
                    showNotification('导入对话失败，文件格式不正确', 'error');
                }
            };
            reader.onerror = function() {
                showNotification('读取文件失败', 'error');
            };
            reader.readAsText(file, 'UTF-8');
        }
        
        
        let importData = {
            fileName: '',
            content: '',
            nicknames: new Set(),
            rawMessages: []
        };
        
        function importConversation(content, fileName) {
            console.log('开始导入对话，文件名:', fileName);
            
            const lines = content.split('\n');
            const nicknames = new Set();
            const rawMessages = [];
            let currentNickname = '';
            let currentContent = '';
            
            console.log('总行数:', lines.length);
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                if (line === '') continue;
                
                
                const colonIndex = line.indexOf(':');
                if (colonIndex !== -1) {
                    const nickname = line.substring(0, colonIndex).trim();
                    const contentPart = line.substring(colonIndex + 1).trim();
                    
                    console.log('检测到角色行，昵称:', nickname, '内容部分:', contentPart);
                    
                    
                    if (currentNickname && currentContent.trim()) {
                        rawMessages.push({
                            nickname: currentNickname,
                            content: currentContent.trim()
                        });
                    }
                    
                    
                    currentNickname = nickname;
                    currentContent = contentPart;
                    
                    
                    if (nickname) {
                        nicknames.add(nickname);
                    }
                } else {
                    
                    console.log('作为内容处理');
                    if (currentContent) {
                        currentContent += '\n' + line;
                    } else {
                        currentContent = line;
                    }
                }
            }
            
            
            if (currentNickname && currentContent.trim()) {
                rawMessages.push({
                    nickname: currentNickname,
                    content: currentContent.trim()
                });
            }
            
            console.log('解析完成，昵称数量:', nicknames.size, '消息数量:', rawMessages.length);
            console.log('检测到的昵称:', Array.from(nicknames));
            
            if (rawMessages.length === 0) {
                showNotification('文件中没有找到有效的对话内容', 'error');
                return;
            }
            
            
            if (nicknames.size > 2) {
                showNotification(`检测到 ${nicknames.size} 个不同的昵称，最多只能有2个昵称（用户和AI）`, 'error');
                return;
            }
            
            
            importData = {
                fileName: fileName,
                content: content,
                nicknames: nicknames,
                rawMessages: rawMessages
            };
            
            
             showNicknameSelectModal();
         }
         
        function showNicknameSelectModal() {
            const modal = document.getElementById('nicknameSelectModal');
            const nicknameList = document.getElementById('nicknameList');
            const userSelect = document.getElementById('userNicknameSelect');
            const aiSelect = document.getElementById('aiNicknameSelect');
            
            
            nicknameList.innerHTML = '';
            userSelect.innerHTML = '<option value="">请选择用户昵称</option>';
            aiSelect.innerHTML = '<option value="">请选择AI昵称</option>';
            
            
            const nicknames = Array.from(importData.nicknames);
            nicknameList.innerHTML = `<div style="color: var(--text-secondary); font-size: 0.9rem;">检测到的昵称: ${nicknames.join(', ')}</div>`;
            
            
            nicknames.forEach(nickname => {
                const userOption = document.createElement('option');
                userOption.value = nickname;
                userOption.textContent = nickname;
                userSelect.appendChild(userOption);
                
                const aiOption = document.createElement('option');
                aiOption.value = nickname;
                aiOption.textContent = nickname;
                aiSelect.appendChild(aiOption);
            });
            
            
            if (nicknames.length === 2) {
                userSelect.value = nicknames[0];
                aiSelect.value = nicknames[1];
            }
            
            
            modal.classList.add('active');
        }
        
        function confirmNicknameSelection() {
            const userNickname = document.getElementById('userNicknameSelect').value;
            const aiNickname = document.getElementById('aiNicknameSelect').value;
            
            if (!userNickname || !aiNickname) {
                showNotification('请选择用户和AI的昵称', 'error');
                return;
            }
            
            if (userNickname === aiNickname) {
                showNotification('用户和AI的昵称不能相同', 'error');
                return;
            }
            
            
            const messages = importData.rawMessages.map(msg => ({
                role: msg.nickname === userNickname ? 'user' : 'assistant',
                content: msg.content,
                timestamp: new Date().toISOString()
            }));
            
            
            const newConversation = {
                id: Date.now(),
                mode: 'chat',
                title: importData.fileName || '导入的对话',
                messages: messages,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                temperature: temperature,
                contextLength: contextLength,
                isNew: false,
                totalCost: 0,
                presetIndex: -1,
                presetContent: '',
                aiNickname: '',
                userNickname: '',
                failedMessages: []
            };
            
            
            if (!conversations.chat) {
                conversations.chat = [];
            }
            conversations.chat.push(newConversation);
            
            
            saveUserData();
            
            
            switchConversation(newConversation.id);
            
            
            const modal = document.getElementById('nicknameSelectModal');
            modal.classList.remove('active');
            
            showNotification(`对话"${importData.fileName}"导入成功`, 'success');
        }
        
        function updateRecentConversations() {
            recentConversations.innerHTML = '';
            
            let allConversations = [];
            for (const mode in conversations) {
                allConversations = allConversations.concat(conversations[mode]);
            }
            
            allConversations.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
            
            const recent = allConversations.slice(0, 5);
            
            if (recent.length === 0) {
                recentConversations.innerHTML = '<div style="color: var(--text-secondary); font-size: 0.9rem; text-align: center; padding: 10px;">暂无对话</div>';
                return;
            }
            
            recent.forEach(conversation => {
                const modeNames = {
                    chat: '文字对话',
                    document: '文档'
                };
                
                const item = document.createElement('a');
                item.href = '#';
                item.className = 'mode-item';
                
                item.innerHTML = `
                    <div class="mode-icon">
                        <i class="fas fa-${getModeIcon(conversation.mode)}"></i>
                    </div>
                    <div class="mode-name">
                        <div style="font-size: 0.9rem;">${conversation.title}</div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">${modeNames[conversation.mode]}</div>
                    </div>
                `;
                
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    switchMode(conversation.mode);
                    switchConversation(conversation.id);
                });
                
                recentConversations.appendChild(item);
            });
        }
        
        function getModeIcon(mode) {
            const icons = {
                chat: 'comment-dots',
                document: 'file-alt'
            };
            return icons[mode] || 'comment-dots';
        }
        
        function showNotification(message, type = 'info') {
            notificationMessage.textContent = message;
            notification.className = 'notification';
            
            if (type === 'error') {
                notification.classList.add('error');
            } else if (type === 'success') {
                notification.classList.add('success');
            } else if (type === 'warning') {
                notification.classList.add('warning');
            }
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        function formatDateTime(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            return `${year}/${month}/${day} ${hours}:${minutes}`;
        }
        
        function formatTime(isoString) {
            const date = new Date(isoString);
            return formatDateTime(date);
        }
        
        function formatRemainingTime(remainingMs) {
            if (remainingMs <= 0) return '已到期';
            
            const seconds = Math.floor(remainingMs / 1000);
            const days = Math.floor(seconds / (24 * 60 * 60));
            const hours = Math.floor((seconds % (24 * 60 * 60)) / (60 * 60));
            const minutes = Math.floor((seconds % (60 * 60)) / 60);
            const secs = seconds % 60;
            
            return `${days.toString().padStart(2, '0')}:${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function loadBatteryDetails() {
            if (!currentUser) return;
            
            const timeCardSummary = document.getElementById('timeCardSummary');
            const batteryDetailsRemaining = document.getElementById('batteryDetailsRemaining');
            const timeCardStatus = document.getElementById('timeCardStatus');
            const timeCardExpire = document.getElementById('timeCardExpire');
            const timeCardRemaining = document.getElementById('timeCardRemaining');
            
            batteryDetailsTotalCost.textContent = totalCost.toFixed(3);
            
            
            if (currentUser.timeCard && currentUser.timeCard.active) {
                
                const originalBattery = currentUser.timeCard.originalBattery || 0.000;
                batteryDetailsRemaining.textContent = originalBattery.toFixed(3);
                
                
                timeCardSummary.style.display = 'block';
                timeCardStatus.textContent = `${currentUser.timeCard.type}卡激活中`;
                
                const endTime = new Date(currentUser.timeCard.endTime);
                timeCardExpire.textContent = endTime.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const now = new Date();
                const remainingMs = endTime.getTime() - now.getTime();
                timeCardRemaining.textContent = formatRemainingTime(remainingMs);
            } else {
                batteryDetailsRemaining.textContent = battery.toFixed(3);
                timeCardSummary.style.display = 'none';
            }
        }
        
        const copyrightInfo = document.getElementById('copyrightInfo');
        const creditsModal = document.createElement('div');
        creditsModal.className = 'modal';
        creditsModal.id = 'creditsModal';
        creditsModal.style.display = 'none';
        creditsModal.innerHTML = `
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h3 class="modal-title">樱梦DX AI 开发与感谢</h3>
                    <button class="modal-close" id="closeCreditsModal">&times;</button>
                </div>
                <div class="modal-body" style="max-height: 600px; overflow-y: auto;">
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: var(--primary-color); margin-bottom: 15px;">🏆 开发核心</h4>
                        <p style="margin-bottom: 10px;">全栈开发：樱玖璃梦</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: var(--primary-color); margin-bottom: 15px;">🤖 功能模块开发</h4>
                        <p style="margin-bottom: 5px;">AI对话引擎：樱玖璃梦</p>
                        <p style="margin-bottom: 5px;">用户界面设计：樱玖璃梦</p>
                        <p style="margin-bottom: 5px;">后端架构：樱玖璃梦</p>
                        <p style="margin-bottom: 5px;">数据处理：樱玖璃梦</p>
                        <p style="margin-bottom: 5px;">系统集成：樱玖璃梦</p>
                        <p style="margin-bottom: 5px;">大模型数据提供：DeepSeek</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: var(--primary-color); margin-bottom: 15px;">🧪 测试与反馈</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px;">
                            <span>007超级内鬼</span>
                            <span>2333333</span>
                            <span>404NotFound</span>
                            <span>888888</span>
                            <span>95274697</span>
                            <span>114514哼哼啊</span>
                            <span>AAA开发板设计定制</span>
                            <span>Daylights</span>
                            <span>Eyye</span>
                            <span>Fishover</span>
                            <span>Labyrintix</span>
                            <span>NekoChan</span>
                            <span>PYJY</span>
                            <span>Quantum</span>
                            <span>RelicError</span>
                            <span>SBGA</span>
                            <span>SkyApple</span>
                            <span>Stellar</span>
                            <span>迟毕</span>
                            <span>根本布诗人</span>
                            <span>珂萝</span>
                            <span>枯木化羽</span>
                            <span>困意批发的吴总</span>
                            <span>牢鸽不老</span>
                            <span>墨</span>
                            <span>噫！我中了！</span>
                            <span>盐巴</span>
                            <span>我写的程序我都看不懂</span>
                            <span>十岚</span>
                            <span>失败的罗德岛博士</span>
                            <span>心爱软萌奶糖</span>
                            <span>二代目青眼白龙</span>
                            <span>几把羊刀</span>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: var(--primary-color); margin-bottom: 15px;">💝 特别致谢</h4>
                        <p style="margin-bottom: 5px;">无条件给予支持和鼓励的家人</p>
                        <p style="margin-bottom: 5px;">提供宝贵建议的群友和朋友</p>
                        <p style="margin-bottom: 5px;">在开源社区提供贡献的开发者</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: var(--primary-color); margin-bottom: 15px;">📜 项目信息</h4>
                        <p style="margin-bottom: 5px;">樱梦DX AI</p>
                        <p style="margin-bottom: 5px;">从构思到实现</p>
                        <p style="margin-bottom: 5px;">创造温暖而有用的AI助手</p>
                        <p style="margin-bottom: 5px;">持续优化，服务更多用户</p>
                    </div>
                    
                    <div style="border-top: 1px solid var(--border-color); padding-top: 15px;">
                        <p style="font-style: italic; color: var(--text-secondary);">
                            结语<br>
                            感谢每一位测试人员的耐心与支持，樱梦DX AI的每一步成长都离不开你们的帮助！
                        </p>
                        <p style="text-align: right; margin-top: 10px; color: var(--primary-color);">
                            开发：樱玖璃梦（飞哥）
                        </p>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(creditsModal);
        
        copyrightInfo.addEventListener('click', function() {
            creditsModal.style.display = 'flex';
        });
        
        document.getElementById('closeCreditsModal').addEventListener('click', function() {
            creditsModal.style.display = 'none';
        });
        
        creditsModal.addEventListener('click', function(e) {
            if (e.target === creditsModal) {
                creditsModal.style.display = 'none';
            }
        });
        
        // 图片压缩函数
        function compressImage(file, callback) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                // 计算压缩比例，限制最大尺寸为1920x1080
                const maxWidth = 1920;
                const maxHeight = 1080;
                let { width, height } = img;
                
                if (width > maxWidth || height > maxHeight) {
                    if (width > height) {
                        height = Math.round((height * maxWidth) / width);
                        width = maxWidth;
                    } else {
                        width = Math.round((width * maxHeight) / height);
                        height = maxHeight;
                    }
                }
                
                canvas.width = width;
                canvas.height = height;
                
                // 绘制压缩后的图片
                ctx.drawImage(img, 0, 0, width, height);
                
                // 转换为JPEG格式，质量为0.7（70%）
                const compressedDataURL = canvas.toDataURL('image/jpeg', 0.7);
                
                // 检查压缩后的大小，如果仍然过大，进一步压缩
                if (compressedDataURL.length > 1.5 * 1024 * 1024) { // 1.5MB
                    const furtherCompressedDataURL = canvas.toDataURL('image/jpeg', 0.5);
                    callback(furtherCompressedDataURL);
                } else {
                    callback(compressedDataURL);
                }
            };
            
            img.onerror = function() {
                // 如果压缩失败，使用原始文件
                const reader = new FileReader();
                reader.onload = function(event) {
                    callback(event.target.result);
                };
                reader.readAsDataURL(file);
            };
            
            img.src = URL.createObjectURL(file);
        }
        
        // 存储空间管理函数
        function analyzeStorageUsage() {
            const storageData = {};
            let totalSize = 0;
            
            // 分析所有localStorage键值对
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                const size = new Blob([value]).size;
                
                storageData[key] = {
                    size: size,
                    sizeFormatted: formatFileSize(size),
                    value: key.startsWith('sakuraAI_') ? '应用数据' : value.substring(0, 100) + (value.length > 100 ? '...' : '')
                };
                
                totalSize += size;
            }
            
            return {
                totalSize: totalSize,
                totalSizeFormatted: formatFileSize(totalSize),
                items: storageData,
                itemCount: localStorage.length,
                quotaAvailable: checkStorageQuota()
            };
        }
        
        function checkStorageQuota() {
            try {
                const testKey = 'storage_quota_test';
                const testValue = 'x'.repeat(1024); // 1KB测试数据
                
                for (let i = 0; i < 1024; i++) { // 尝试写入1MB数据
                    localStorage.setItem(testKey + i, testValue);
                }
                
                // 清理测试数据
                for (let i = 0; i < 1024; i++) {
                    localStorage.removeItem(testKey + i);
                }
                
                return true;
            } catch (error) {
                return false;
            }
        }
        
        function cleanupStorage() {
            try {
                let cleanedItems = [];
                let totalFreed = 0;
                
                // 清理过大的聊天背景图片
                const users = JSON.parse(localStorage.getItem('sakuraAI_users') || '[]');
                users.forEach(user => {
                    if (user.chatBackground && user.chatBackground.length > 0.5 * 1024 * 1024) { // 超过0.5MB
                        const oldSize = user.chatBackground.length;
                        user.chatBackground = null;
                        cleanedItems.push(`用户 ${user.username} 的背景图片`);
                        totalFreed += oldSize;
                    }
                });
                
                if (cleanedItems.length > 0) {
                    localStorage.setItem('sakuraAI_users', JSON.stringify(users));
                }
                
                // 清理过期的会话数据
                const currentUserData = JSON.parse(localStorage.getItem('sakuraAI_currentUser') || '{}');
                if (currentUserData.conversations) {
                    const maxConversations = 30; // 保留最多30个会话
                    Object.keys(currentUserData.conversations).forEach(mode => {
                        if (currentUserData.conversations[mode].length > maxConversations) {
                            const oldCount = currentUserData.conversations[mode].length;
                            currentUserData.conversations[mode] = 
                                currentUserData.conversations[mode]
                                    .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt))
                                    .slice(0, maxConversations);
                            const newCount = currentUserData.conversations[mode].length;
                            cleanedItems.push(`${mode}模式会话 (从${oldCount}个减少到${newCount}个)`);
                        }
                    });
                }
                
                // 清理过期的消息内容（保留最近100条消息）
                if (currentUserData.conversations) {
                    Object.keys(currentUserData.conversations).forEach(mode => {
                        currentUserData.conversations[mode].forEach(conversation => {
                            if (conversation.messages && conversation.messages.length > 100) {
                                const oldCount = conversation.messages.length;
                                conversation.messages = conversation.messages.slice(-100);
                                const newCount = conversation.messages.length;
                                cleanedItems.push(`对话"${conversation.title}"的消息 (从${oldCount}条减少到${newCount}条)`);
                            }
                        });
                    });
                }
                
                if (Object.keys(currentUserData).length > 0) {
                    localStorage.setItem('sakuraAI_currentUser', JSON.stringify(currentUserData));
                }
                
                // 清理过期的充值码记录
                const usedCodes = JSON.parse(localStorage.getItem('sakuraAI_usedRechargeCodes') || '[]');
                if (usedCodes.length > 100) {
                    const oldCount = usedCodes.length;
                    const now = new Date().getTime();
                    const oneDay = 24 * 60 * 60 * 1000;
                    
                    // 保留最近100条或24小时内的记录
                    const filteredCodes = usedCodes
                        .filter((code, index) => index >= usedCodes.length - 100)
                        .slice(-50); // 最终保留50条
                    
                    localStorage.setItem('sakuraAI_usedRechargeCodes', JSON.stringify(filteredCodes));
                    cleanedItems.push(`已使用充值码记录 (从${oldCount}条减少到${filteredCodes.length}条)`);
                }
                
                // 清理临时数据
                const tempKeys = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('temp_') || key.includes('_temp') || key === 'messageInputHeight') {
                        tempKeys.push(key);
                    }
                }
                
                tempKeys.forEach(key => {
                    localStorage.removeItem(key);
                    cleanedItems.push(`临时数据: ${key}`);
                });
                
                // 显示清理结果
                if (cleanedItems.length > 0) {
                    const freedSize = formatFileSize(totalFreed);
                    console.log(`存储清理完成，释放了 ${freedSize}，清理了 ${cleanedItems.length} 个项目`);
                    console.log('清理的项目:', cleanedItems);
                } else {
                    console.log('存储空间已优化，无需清理');
                }
                
                return {
                    cleanedItems: cleanedItems,
                    totalFreed: totalFreed,
                    freedSizeFormatted: formatFileSize(totalFreed)
                };
                
            } catch (error) {
                console.warn('存储清理失败:', error);
                return {
                    cleanedItems: [],
                    totalFreed: 0,
                    freedSizeFormatted: '0 B'
                };
            }
        }
        
        // 自定义确认和提示函数
        function customConfirm(message, title = '确认操作') {
            return new Promise((resolve) => {
                const modal = document.getElementById('customConfirmModal');
                const messageElement = document.getElementById('confirmModalMessage');
                const titleElement = document.getElementById('confirmModalTitle');
                const okBtn = document.getElementById('confirmModalOk');
                const cancelBtn = document.getElementById('confirmModalCancel');
                const closeBtn = document.getElementById('closeConfirmModal');
                
                // 设置内容和标题
                messageElement.textContent = message;
                titleElement.textContent = title;
                
                // 显示模态框
                modal.style.display = 'flex';
                
                // 处理确认
                const handleConfirm = () => {
                    modal.style.display = 'none';
                    resolve(true);
                    removeEventListeners();
                };
                
                // 处理取消
                const handleCancel = () => {
                    modal.style.display = 'none';
                    resolve(false);
                    removeEventListeners();
                };
                
                // 移除事件监听器
                const removeEventListeners = () => {
                    okBtn.removeEventListener('click', handleConfirm);
                    cancelBtn.removeEventListener('click', handleCancel);
                    closeBtn.removeEventListener('click', handleCancel);
                    modal.removeEventListener('click', handleOutsideClick);
                };
                
                // 点击模态框外部关闭
                const handleOutsideClick = (e) => {
                    if (e.target === modal) {
                        handleCancel();
                    }
                };
                
                // 添加事件监听器
                okBtn.addEventListener('click', handleConfirm);
                cancelBtn.addEventListener('click', handleCancel);
                closeBtn.addEventListener('click', handleCancel);
                modal.addEventListener('click', handleOutsideClick);
            });
        }
        
        function customAlert(message, title = '提示') {
            return new Promise((resolve) => {
                const modal = document.getElementById('customAlertModal');
                const messageElement = document.getElementById('alertModalMessage');
                const titleElement = document.getElementById('alertModalTitle');
                const okBtn = document.getElementById('alertModalOk');
                const closeBtn = document.getElementById('closeAlertModal');
                
                // 设置内容和标题
                messageElement.textContent = message;
                titleElement.textContent = title;
                
                // 显示模态框
                modal.style.display = 'flex';
                
                // 处理确认
                const handleConfirm = () => {
                    modal.style.display = 'none';
                    resolve();
                    removeEventListeners();
                };
                
                // 移除事件监听器
                const removeEventListeners = () => {
                    okBtn.removeEventListener('click', handleConfirm);
                    closeBtn.removeEventListener('click', handleConfirm);
                    modal.removeEventListener('click', handleOutsideClick);
                };
                
                // 点击模态框外部关闭
                const handleOutsideClick = (e) => {
                    if (e.target === modal) {
                        handleConfirm();
                    }
                };
                
                // 添加事件监听器
                okBtn.addEventListener('click', handleConfirm);
                closeBtn.addEventListener('click', handleConfirm);
                modal.addEventListener('click', handleOutsideClick);
            });
        }
        
        // 自定义文件选择器功能
        let currentFilePickerCallback = null;
        let selectedFile = null;
        let isFullscreenBeforeFilePicker = false;
        
        function openFilePicker(callback, accept = 'image/*', title = '选择文件') {
            currentFilePickerCallback = callback;
            selectedFile = null;
            
            // 记录当前全屏状态
            isFullscreenBeforeFilePicker = document.fullscreenElement !== null;
            
            const modal = document.getElementById('customFilePickerModal');
            const titleElement = document.getElementById('filePickerTitle');
            const fileInput = document.getElementById('customFileInput');
            const filePreview = document.getElementById('filePreview');
            const fileName = document.getElementById('fileName');
            const previewImage = document.getElementById('previewImage');
            const confirmBtn = document.getElementById('filePickerConfirm');
            
            // 设置标题和文件类型
            titleElement.textContent = title;
            fileInput.accept = accept;
            
            // 重置预览
            filePreview.style.display = 'none';
            confirmBtn.disabled = true;
            
            // 显示模态框
            modal.style.display = 'flex';
        }
        
        function closeFilePicker() {
            const modal = document.getElementById('customFilePickerModal');
            modal.style.display = 'none';
            currentFilePickerCallback = null;
            selectedFile = null;
        }
        
        // 文件选择器事件处理
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('customFilePickerModal');
            const fileInput = document.getElementById('customFileInput');
            const selectFileBtn = document.getElementById('selectFileBtn');
            const fileDropArea = document.getElementById('fileDropArea');
            const confirmBtn = document.getElementById('filePickerConfirm');
            const cancelBtn = document.getElementById('filePickerCancel');
            const closeBtn = document.getElementById('closeFilePickerModal');
            
            // 点击选择文件按钮
            selectFileBtn.addEventListener('click', function() {
                fileInput.click();
            });
            
            // 文件输入变化
            fileInput.addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    handleFileSelection(e.target.files[0]);
                }
            });
            
            // 拖拽文件处理
            fileDropArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                fileDropArea.style.borderColor = 'var(--primary-color)';
                fileDropArea.style.backgroundColor = 'rgba(59, 130, 246, 0.05)';
            });
            
            fileDropArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                fileDropArea.style.borderColor = 'var(--border-color)';
                fileDropArea.style.backgroundColor = '';
            });
            
            fileDropArea.addEventListener('drop', function(e) {
                e.preventDefault();
                fileDropArea.style.borderColor = 'var(--border-color)';
                fileDropArea.style.backgroundColor = '';
                
                if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                    handleFileSelection(e.dataTransfer.files[0]);
                }
            });
            
            // 确认上传
            confirmBtn.addEventListener('click', function() {
                if (selectedFile && currentFilePickerCallback) {
                    currentFilePickerCallback(selectedFile);
                }
                closeFilePicker();
                
                // 如果之前是全屏状态，重新进入全屏
                if (isFullscreenBeforeFilePicker) {
                    setTimeout(() => {
                        enterFullscreen();
                    }, 100);
                }
            });
            
            // 取消和关闭
            cancelBtn.addEventListener('click', closeFilePicker);
            closeBtn.addEventListener('click', closeFilePicker);
            
            // 点击模态框外部关闭
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeFilePicker();
                }
            });
        });
        
        function handleFileSelection(file) {
            selectedFile = file;
            const filePreview = document.getElementById('filePreview');
            const fileName = document.getElementById('fileName');
            const previewImage = document.getElementById('previewImage');
            const confirmBtn = document.getElementById('filePickerConfirm');
            
            // 显示文件信息
            fileName.textContent = `${file.name} (${formatFileSize(file.size)})`;
            
            // 如果是图片，显示预览
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImage.src = e.target.result;
                    filePreview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                filePreview.style.display = 'block';
                previewImage.style.display = 'none';
            }
            
            // 启用确认按钮
            confirmBtn.disabled = false;
        }
        
        // 在应用启动时检查存储空间
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                if (!checkStorageQuota()) {
                    cleanupStorage();
                }
            }, 2000);
        });
    </script>
    

    <div class="modal" id="nicknameSelectModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">选择角色昵称</h3>
                <button class="modal-close" id="closeNicknameSelectModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">检测到以下昵称，请选择对应的角色：</label>
                    <div id="nicknameList" style="margin-bottom: 20px;"></div>
                    <div class="form-group">
                        <label class="form-label">用户角色：</label>
                        <select class="form-control" id="userNicknameSelect">
                            <option value="">请选择用户昵称</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">AI角色：</label>
                        <select class="form-control" id="aiNicknameSelect">
                            <option value="">请选择AI昵称</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary" id="confirmNicknameSelect" style="width: 100%;">
                    <i class="fas fa-check"></i>
                    确认选择
                </button>
            </div>
        </div>
    </div>

    <!-- 移动端设置模态框 -->
    <div class="settings-modal" id="settingsModal">
        <div class="settings-content">
            <div class="settings-header">
                <h3 class="settings-title">设置</h3>
                <button class="close-settings" id="closeSettings">&times;</button>
            </div>
            
            <div class="settings-group">
                <label class="settings-label">设备模式</label>
                <div class="device-toggle">
                    <span class="toggle-label">移动端模式</span>
                    <div class="toggle-switch" id="mobileModeToggle">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 10px;">
                    开启后将为移动设备优化界面和交互体验
                </p>
            </div>
            
            <div class="settings-group">
                <label class="settings-label">界面设置</label>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="autoDetectDevice" checked>
                        <span>自动检测设备类型</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="compactMode">
                        <span>紧凑模式（节省空间）</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="gestureSupport" checked>
                        <span>手势操作支持</span>
                    </label>
                </div>
            </div>
            
            <div class="settings-group">
                <button class="btn btn-primary" id="saveSettings" style="width: 100%;">
                    <i class="fas fa-save"></i>
                    保存设置
                </button>
            </div>
        </div>
    </div>
    
    <!-- 自定义确认模态框 -->
    <div class="modal" id="customConfirmModal" style="z-index: 2000;">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title" id="confirmModalTitle">确认操作</h3>
                <button class="modal-close" id="closeConfirmModal">&times;</button>
            </div>
            <div class="modal-body">
                <p id="confirmModalMessage" style="margin-bottom: 20px; line-height: 1.5;">确定要执行此操作吗？</p>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn btn-secondary" id="confirmModalCancel">取消</button>
                    <button class="btn btn-primary" id="confirmModalOk">确定</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 自定义提示模态框 -->
    <div class="modal" id="customAlertModal" style="z-index: 2000;">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title" id="alertModalTitle">提示</h3>
                <button class="modal-close" id="closeAlertModal">&times;</button>
            </div>
            <div class="modal-body">
                <p id="alertModalMessage" style="margin-bottom: 20px; line-height: 1.5;"></p>
                <div style="display: flex; justify-content: flex-end;">
                    <button class="btn btn-primary" id="alertModalOk">确定</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 自定义文件选择器模态框 -->
    <div class="modal" id="customFilePickerModal" style="z-index: 2000;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title" id="filePickerTitle">选择文件</h3>
                <button class="modal-close" id="closeFilePickerModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="filePickerContent" style="text-align: center; padding: 20px;">
                    <div style="margin-bottom: 20px;">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: var(--primary-color);"></i>
                        <p style="margin-top: 10px; color: var(--text-secondary);">拖拽文件到此处或点击选择</p>
                    </div>
                    <div id="fileDropArea" style="border: 2px dashed var(--border-color); border-radius: 10px; padding: 30px; cursor: pointer; transition: all 0.3s;">
                        <input type="file" id="customFileInput" style="display: none;" accept="image/*">
                        <button class="btn btn-primary" id="selectFileBtn">
                            <i class="fas fa-folder-open"></i>
                            选择文件
                        </button>
                        <p style="margin-top: 10px; font-size: 0.9rem; color: var(--text-secondary);">支持 JPG, PNG, GIF 格式</p>
                    </div>
                    <div id="filePreview" style="margin-top: 20px; display: none;">
                        <img id="previewImage" style="max-width: 200px; max-height: 150px; border-radius: 5px;">
                        <p id="fileName" style="margin-top: 10px; font-size: 0.9rem;"></p>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button class="btn btn-secondary" id="filePickerCancel">取消</button>
                    <button class="btn btn-primary" id="filePickerConfirm" disabled>确认上传</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
